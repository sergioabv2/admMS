<!DOCTYPE html>
<html lang="es">
<head>   
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Profesor - Mozart Academy</title>
    <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
</head>

<style>
    :root {
        --primary-color: #FF4757;
        --secondary-color: #2ed573;
        --bg-light: #f8f9fa;
        --card-bg: #ffffff;
        --text-dark: #2f3542;
        --text-muted: #6c757d;
        --border-color: #dee2e6;
        --piano-bg: #1e1e1e;
        --piano-height: 110px;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Inter', sans-serif;
        background: var(--bg-light);
        color: var(--text-dark);
        overflow: hidden;
    }

    .professor-container {
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* ==================== HEADER ==================== */
    .professor-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, #ff6b81 100%);
        color: white;
        padding: 15px 25px;
        box-shadow: 0 4px 15px rgba(255, 71, 87, 0.2);
        flex-shrink: 0;
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .professor-header h1 {
        font-size: 20px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .midi-status-header {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .midi-indicator {
        font-size: 13px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 20px;
    }

    .midi-indicator i {
        font-size: 8px;
    }

    .midi-indicator.connected {
        background: rgba(46, 213, 115, 0.3);
    }

    .midi-indicator.connected i {
        animation: pulse-midi 1.5s infinite;
    }

    @keyframes pulse-midi {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.4; }
    }

    /* ==================== MAIN LAYOUT ==================== */
    .main-layout {
        display: grid;
        grid-template-columns: 1fr 340px;
        gap: 0;
        flex: 1;
        overflow: hidden;
        height: calc(100vh - 70px);
    }

    /* ==================== MAIN CENTER ==================== */
    .main-center {
        background: white;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .students-section {
        background: white;
        border-bottom: 1px solid var(--border-color);
        padding: 15px 0;
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: 0;
        overflow: hidden;
    }

    .section-header {
        padding: 0 20px;
        margin-bottom: 10px;
    }

    .section-header h2 {
        font-size: 16px;
        font-weight: 800;
        color: var(--text-dark);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .section-header i {
        color: var(--primary-color);
    }

    .student-info-badge {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: var(--text-muted);
        padding: 8px 16px;
        background: var(--bg-light);
        border-radius: 20px;
    }

    .student-info-badge.active {
        background: rgba(46, 213, 115, 0.1);
        color: var(--secondary-color);
        font-weight: 600;
    }

    .students-grid {
        display: flex;
        flex-direction: row;
        overflow-x: auto;
        overflow-y: hidden;
        gap: 15px;
        padding: 10px 20px 20px 20px;
        scroll-behavior: smooth;
        scrollbar-width: thin;
    }

    .students-grid::-webkit-scrollbar {
        height: 8px;
    }

    .students-grid::-webkit-scrollbar-track {
        background: transparent;
    }

    .students-grid::-webkit-scrollbar-thumb {
        background: #ddd;
        border-radius: 4px;
    }

    .student-item {
        min-width: 220px;
        width: 220px;
        background: white;
        border-radius: 16px;
        min-height: 280px;
        border: 1px solid var(--border-color);
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 15px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .student-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        border-color: var(--primary-color);
    }

    .student-item.connected {
        border-color: var(--secondary-color);
        background: linear-gradient(to bottom, #fff 0%, rgba(46, 213, 115, 0.05) 100%);
    }

    .student-item.selected {
        border-color: var(--primary-color);
        background: linear-gradient(to bottom, #fff 0%, rgba(255, 71, 87, 0.05) 100%);
        box-shadow: 0 0 0 2px rgba(255, 71, 87, 0.1);
    }

    .card-avatar-container {
        position: relative;
        margin-bottom: 10px;
    }

    .card-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        background: #eee;
    }

    .card-status-dot {
        position: absolute;
        bottom: 2px;
        right: 2px;
        width: 14px;
        height: 14px;
        background: #ccc;
        border: 2px solid white;
        border-radius: 50%;
    }

    .card-status-dot.connected {
        background: var(--secondary-color);
        box-shadow: 0 0 5px rgba(46, 213, 115, 0.6);
    }

    .card-info {
        text-align: center;
        margin-bottom: 15px;
        width: 100%;
    }

    .card-name {
        font-weight: 700;
        font-size: 15px;
        color: var(--text-dark);
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .card-meta {
        font-size: 11px;
        color: var(--text-muted);
        background: var(--bg-light);
        padding: 4px 8px;
        border-radius: 12px;
        display: inline-block;
        margin-bottom: 4px;
    }

    .student-actions {
        margin-top: auto;
        width: 100%;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
        padding-top: 10px;
        border-top: 1px solid var(--bg-light);
    }

    .student-action-btn {
        width: 28px;
        height: 28px;
        font-size: 11px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        color: white;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .student-action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .student-action-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
        transform: none;
    }

    .btn-connect-primary {
        background: linear-gradient(135deg, var(--primary-color) 0%, #ff6b81 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        font-weight: 600;
        font-size: 13px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        width: 100%;
        transition: all 0.3s ease;
        box-shadow: 0 4px 10px rgba(255, 71, 87, 0.3);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .btn-connect-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(255, 71, 87, 0.4);
        filter: brightness(1.1);
    }

    .btn-connect-primary:disabled {
        opacity: 0.7;
        cursor: wait;
        transform: none;
        box-shadow: none;
    }

    .action-microphone {
        background: var(--secondary-color);
    }

    .action-microphone.active {
        background: var(--primary-color);
        animation: pulse-mic 1.5s infinite;
    }

    .action-speaker {
        background: #ff9800;
    }

    .action-speaker.muted {
        background: var(--text-muted);
    }

    .action-screen {
        background: #5c80bc;
    }

    .action-screen.active {
        background: var(--primary-color);
        box-shadow: 0 0 15px rgba(255, 71, 87, 0.4);
    }

    .action-midi {
        background: #6c5ce7;
    }

    .action-midi.active {
        background: var(--primary-color);
        box-shadow: 0 0 15px rgba(255, 71, 87, 0.4);
        animation: pulse-piano 1.5s infinite;
    }

    .action-chat {
        background: #5c80bc;
    }

    .action-chat.active {
        background: var(--primary-color);
    }

    .action-close {
        background: var(--primary-color);
    }

    @keyframes pulse-mic {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.08); }
    }

    @keyframes pulse-piano {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.08); }
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .fa-spinner-animate {
        animation: spin 1s linear infinite;
    }

    /* ==================== PIANO SECTION ==================== */
    .piano-section {
        flex: 0 0 auto;
        margin-top: auto;
        display: flex;
        flex-direction: column;
        padding: 30px 20px 20px 20px;
        overflow: hidden;
        background: var(--bg-light);
        border-top: 1px solid var(--border-color);
    }

    .piano-header-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--border-color);
    }

    .piano-header-bar h3 {
        font-size: 18px;
        font-weight: 800;
        color: var(--text-dark);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .piano-header-bar i {
        color: var(--primary-color);
    }

    .piano-controls {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .transmission-badge {
        font-size: 12px;
        font-weight: 700;
        padding: 6px 14px;
        background: var(--text-muted);
        color: white;
        border-radius: 20px;
    }

    .transmission-badge.active {
        background: var(--secondary-color);
        box-shadow: 0 0 15px rgba(46, 213, 115, 0.4);
        animation: pulse-badge 1.5s infinite;
    }

    @keyframes pulse-badge {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    .piano-wrapper {
        height: var(--piano-height);
        background: var(--piano-bg);
        border-radius: 12px 12px 0 0;
        overflow: hidden;
        box-shadow: 0 -5px 25px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        margin-top: auto;
        margin-bottom: 0;
    }

    #piano-top-casing {
        position: relative;
        width: 100%;
        height: 25px;
        background: #333;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-shrink: 0;
    }

    .casing-note-label {
        position: absolute;
        top: 50%;
        transform: translate(-50%, -50%);
        color: #fff;
        font-size: 11px;
        font-weight: 700;
        background: rgba(0, 0, 0, 0.7);
        padding: 3px 10px;
        border-radius: 4px;
        pointer-events: none;
        white-space: nowrap;
        z-index: 20;
    }

    #piano-container {
        position: relative;
        width: 100%;
        flex: 1;
        overflow-x: auto;
        overflow-y: hidden;
        background: #1a1a1a;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 0;
    }

    #piano-container::-webkit-scrollbar {
        height: 8px;
        background: #222;
    }

    #piano-container::-webkit-scrollbar-thumb {
        background: #444;
        border-radius: 4px;
    }

    #piano-keys {
        position: relative;
        display: flex;
        height: 100%;
        padding: 0 10px;
        align-items: flex-start;
    }

    .piano-key {
        position: relative;
        cursor: pointer;
        transition: all 0.05s ease;
        border: 1px solid #999;
        flex-shrink: 0;
    }

    .piano-key.white {
        width: 18px;
        height: 100%;
        background: linear-gradient(to bottom, #ffffff 0%, #f5f5f5 100%);
        border-radius: 0 0 3px 3px;
        z-index: 1;
        border-right: 1px solid #ccc;
        box-shadow: inset 0 -2px 5px rgba(0, 0, 0, 0.1);
        flex-shrink: 0;
    }

    .piano-key.white:hover {
        background: linear-gradient(to bottom, #f8f8f8 0%, #e8e8e8 100%);
    }

    .piano-key.white.active {
        background: var(--primary-color) !important;
        box-shadow: 0 0 20px rgba(255, 71, 87, 0.6), inset 0 2px 5px rgba(0, 0, 0, 0.3);
        transform: translateY(1px);
    }

    .piano-key.black {
        width: 12px;
        height: 60%;
        background: linear-gradient(to bottom, #1a1a1a 0%, #000000 100%);
        margin-left: -6px;
        margin-right: -6px;
        z-index: 2;
        border-radius: 0 0 2px 2px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        flex-shrink: 0;
    }

    .piano-key.black:hover {
        background: linear-gradient(to bottom, #2a2a2a 0%, #0a0a0a 100%);
    }

    .piano-key.black.active {
        background: var(--primary-color) !important;
        box-shadow: 0 0 15px rgba(255, 71, 87, 0.6), inset 0 2px 5px rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.3) !important;
    }

    /* ==================== RIGHT SIDEBAR ==================== */
    .right-sidebar {
        background: white;
        border-left: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .sidebar-tabs {
        display: flex;
        border-bottom: 2px solid var(--border-color);
        background: var(--bg-light);
    }

    .tab-btn {
        flex: 1;
        padding: 15px;
        border: none;
        background: transparent;
        color: var(--text-muted);
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .tab-btn:hover {
        background: rgba(255, 71, 87, 0.05);
        color: var(--text-dark);
    }

    .tab-btn.active {
        background: white;
        color: var(--primary-color);
        border-bottom: 3px solid var(--primary-color);
    }

    .tab-content {
        display: none;
        flex: 1;
        flex-direction: column;
        overflow: hidden;
    }

    .tab-content.active {
        display: flex;
    }

    /* ==================== CHAT TAB ==================== */
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        background: var(--bg-light);
    }

    .chat-messages::-webkit-scrollbar {
        width: 6px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 10px;
    }

    .message {
        padding: 12px 16px;
        border-radius: 16px;
        max-width: 80%;
        word-break: break-word;
        font-size: 14px;
        line-height: 1.5;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .message.self {
        align-self: flex-end;
        background: var(--primary-color);
        color: white;
        border-bottom-right-radius: 4px;
    }

    .message.other {
        align-self: flex-start;
        background: white;
        color: var(--text-dark);
        border: 1px solid var(--border-color);
        border-bottom-left-radius: 4px;
    }

    .message-sender {
        font-size: 11px;
        font-weight: 700;
        margin-bottom: 4px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .message.self .message-sender {
        opacity: 0.9;
    }

    .message.other .message-sender {
        color: var(--primary-color);
    }

    .chat-input-container {
        padding: 15px;
        background: white;
        border-top: 1px solid var(--border-color);
        display: flex;
        gap: 10px;
    }

    #chatInput {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid var(--border-color);
        border-radius: 24px;
        font-size: 14px;
        outline: none;
        transition: all 0.3s ease;
        font-family: 'Inter', sans-serif;
    }

    #chatInput:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(255, 71, 87, 0.1);
    }

    #chatInput:disabled {
        background: var(--bg-light);
        cursor: not-allowed;
    }

    .send-button {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        border: none;
        background: var(--secondary-color);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        transition: all 0.2s ease;
        box-shadow: 0 4px 12px rgba(46, 213, 115, 0.3);
    }

    .send-button:hover {
        background: #26d07c;
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(46, 213, 115, 0.4);
    }

    .send-button:disabled {
        background: var(--text-muted);
        cursor: not-allowed;
        opacity: 0.5;
        transform: none;
        box-shadow: none;
    }

    @media (max-width: 768px) {
        .main-layout {
            grid-template-columns: 1fr;
        }

        .right-sidebar {
            display: none;
        }

        .students-grid {
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        }
    }
</style>

<body>
    <div class="professor-container">
        
        <!-- HEADER -->
        <header class="professor-header">
            <div class="header-content">
                <h1>
                    <i class="fas fa-chalkboard-teacher"></i> 
                    Mozart Academy
                </h1>
                <div class="midi-status-header">
                    <span id="midiHeaderStatus" class="midi-indicator">
                        <i class="fas fa-circle"></i> Sin piano MIDI
                    </span>
                </div>
            </div>
        </header>

        <!-- MAIN LAYOUT -->
        <div class="main-layout">
            
            <!-- MAIN CENTER: STUDENTS + PIANO -->
            <main class="main-center">
                
                <!-- STUDENTS SECTION -->
                <section class="students-section">
                    <div class="section-header">
                        <h2>
                            <i class="fas fa-users"></i> 
                            Alumnos Conectados
                        </h2>
                        <div class="student-info-badge" id="selectedStudentInfo">
                            <i class="fas fa-info-circle"></i>
                            <span>Selecciona un alumno para iniciar</span>
                        </div>
                    </div>
                    
                    <div id="studentsContainer" class="students-grid">
                        <!-- Los estudiantes se cargar√°n din√°micamente aqu√≠ -->
                    </div>
                </section>

                <!-- PIANO SECTION -->
                <section class="piano-section">
                    <div class="piano-header-bar">
                        <h3><i class="fas fa-piano"></i> Piano Virtual</h3>
                        <div class="piano-controls">
                            <span id="transmissionStatus" class="transmission-badge">
                                Transmisi√≥n inactiva
                            </span>
                        </div>
                    </div>

                    <div class="piano-wrapper">
                        <div id="piano-top-casing"></div>
                        <div id="piano-container">
                            <div id="piano-keys"></div>
                        </div>
                    </div>
                </section>
                
            </main>

            <!-- RIGHT SIDEBAR -->
            <aside class="right-sidebar">
                <div class="sidebar-tabs">
                    <button class="tab-btn active" data-tab="chat">
                        <i class="fas fa-comments"></i> Chat
                    </button>
                </div>

                <div class="tab-content active" id="chatTab">
                    <div class="chat-messages" id="chatLog">
                    </div>
                    
                    <div class="chat-input-container">
                        <input id="chatInput" type="text" placeholder="Escribe un mensaje..." disabled>
                        <button id="sendBtn" class="send-button" disabled>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <script>
        // ==================== CONFIGURACI√ìN FIREBASE ====================
const fb_config = {
  apiKey: "AIzaSyCb_t1xm9ueLy0lURXBovtZVdowSgTTT7c",
  authDomain: "mozartplus-85ab1.firebaseapp.com",
  databaseURL: "https://mozartplus-85ab1-default-rtdb.firebaseio.com",
  projectId: "mozartplus-85ab1",
  storageBucket: "mozartplus-85ab1.firebasestorage.app",
  messagingSenderId: "742478520566"
};
        firebase.initializeApp(fb_config);

        const db = firebase.database();
        const room = "piano-class";
        const usersRef = db.ref(`${room}/users`);
        const signalsRef = db.ref(`${room}/signals`);
        const chatsRef = db.ref(`${room}/chats`);

        // ==================== VARIABLES GLOBALES ====================
        let myId = "profesor-" + Math.floor(Math.random() * 10000);
        let myName = "Profesor";
        let localStream = null;
        let peers = {};
        let selectedStudent = null;
        let connectedStudents = {};
        let studentConnections = {};

        // Variables MIDI
        let midiAccess = null;
        let midiInput = null;
        let midiTransmissionEnabled = false;
        let activeMidiStudent = null;

        // Variables Piano Visual
        let sampler = null;
        let activeNotes = {};

        // Variables streams individuales
        let individualAudioStreams = {};
        let individualScreenStreams = {};

        // Evitar desconectar al alumno por un snapshot incompleto (ej. al conectar piano MIDI)
        let pendingCleanupTimeouts = {};
        const CLEANUP_DELAY_MS = 8000;
        const HEARTBEAT_GRACE_MS = 45000;

        const keyMap = {
            'a': 'C4', 'w': 'Db4', 's': 'D4', 'e': 'Eb4', 'd': 'E4', 'f': 'F4', 't': 'Gb4',
            'g': 'G4', 'y': 'Ab4', 'h': 'A4', 'u': 'Bb4', 'j': 'B4', 'k': 'C5', 'o': 'Db5',
            'l': 'D5', 'p': 'Eb5', ';': 'E5'
        };

        // ==================== INICIALIZACI√ìN ====================
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById("sendBtn").addEventListener("click", sendMessage);
            document.getElementById("chatInput").addEventListener("keypress", e => {
                if (e.key === "Enter") sendMessage();
            });

            // Eventos de teclado para piano
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                if (e.repeat) return;

                const key = e.key.toLowerCase();
                if (keyMap[key]) {
                    triggerNoteOn(keyMap[key]);
                }
            });

            document.addEventListener('keyup', (e) => {
                const key = e.key.toLowerCase();
                if (keyMap[key]) {
                    triggerNoteOff(keyMap[key]);
                }
            });

            init();
        });

        async function init() {
            try {
                // Stream b√°sico (silencioso)
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: true,
                    video: false
                });
                
                localStream.getAudioTracks().forEach(track => {
                    track.enabled = false;
                });

                // Registrar en Firebase
                usersRef.child(myId).set({ id: myId, role: "master", name: myName });
                usersRef.child(myId).onDisconnect().remove();

                // Listeners
                listenForStudents();
                listenForSignals();
                
                // Inicializar piano y MIDI
                await initPianoVisual();
                await initMIDI();

            } catch (error) {
                console.error("Error al inicializar:", error);
                alert('Error: No se pudo acceder al micr√≥fono.');
            }
        }

        // ==================== GESTI√ìN DE ESTUDIANTES ====================
        function listenForStudents() {
            usersRef.on("value", snap => {
                const users = snap.val() || {};
                const studentsContainer = document.getElementById("studentsContainer");

                studentsContainer.innerHTML = '';
                connectedStudents = {};
                
                const now = Date.now();
                const TIMEOUT_MS = 30000;
                
                for (let key in users) {
                    if (users[key].role === "user") {
                        const lastHeartbeat = users[key].lastHeartbeat || 0;
                        
                        if (now - lastHeartbeat < TIMEOUT_MS) {
                            connectedStudents[key] = users[key];
                            createStudentUI(key, users[key].name || users[key].id);
                        } else {
                            const hasActivePeer = peers[key];
                            const reallyStale = (now - lastHeartbeat) > HEARTBEAT_GRACE_MS;
                            if (!hasActivePeer || reallyStale) {
                                console.log(`üëª Removiendo fantasma: ${key}`);
                                usersRef.child(key).remove();
                            }
                        }
                    }
                }
                
                if (selectedStudent && !connectedStudents[selectedStudent]) {
                    selectedStudent = null;
                    updateStudentInfo(null);
                    disableChat();
                }
                
                for (let studentId in peers) {
                    if (connectedStudents[studentId]) {
                        if (pendingCleanupTimeouts[studentId]) {
                            clearTimeout(pendingCleanupTimeouts[studentId]);
                            delete pendingCleanupTimeouts[studentId];
                        }
                    } else {
                        if (!pendingCleanupTimeouts[studentId]) {
                            pendingCleanupTimeouts[studentId] = setTimeout(() => {
                                delete pendingCleanupTimeouts[studentId];
                                usersRef.child(studentId).once('value', snap => {
                                    const data = snap.val();
                                    const t = Date.now();
                                    const last = (data && data.lastHeartbeat) || 0;
                                    if (!data || (t - last > TIMEOUT_MS)) {
                                        console.log(`üîå Cerrando conexi√≥n con ${studentId} (ausente en Firebase)`);
                                        cleanupStudentConnection(studentId);
                                    }
                                });
                            }, CLEANUP_DELAY_MS);
                        }
                    }
                }
            });
            
            setInterval(() => {
                checkHeartbeats();
            }, 10000);
        }

        function checkHeartbeats() {
            usersRef.once('value', snapshot => {
                const users = snapshot.val() || {};
                const now = Date.now();
                const TIMEOUT_MS = 30000;
                
                for (let userId in users) {
                    if (users[userId].role === "user") {
                        const lastHeartbeat = users[userId].lastHeartbeat || 0;
                        
                        if (now - lastHeartbeat > TIMEOUT_MS) {
                            console.log(`üíÄ Heartbeat timeout: ${userId}`);
                            usersRef.child(userId).remove();
                        }
                    }
                }
            });
        }

        function createStudentUI(studentId, name) {
            const studentsContainer = document.getElementById("studentsContainer");
            const existingElement = document.getElementById(`student-${studentId}`);
            
            if (existingElement) {
                existingElement.remove();
            }

            const isConnected = studentConnections[studentId]?.connected || false;
            const isSelected = selectedStudent === studentId;
            const isMidiActive = activeMidiStudent === studentId;
            const isAudioActive = individualAudioStreams[studentId]?.active || false;
            const isScreenActive = individualScreenStreams[studentId]?.active || false;
            const audioMuted = document.getElementById(`audio-${studentId}`)?.muted || false;

            const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random&color=fff&size=128`;

            const studentItem = document.createElement("div");
            studentItem.className = `student-item ${isConnected ? 'connected' : ''} ${isSelected ? 'selected' : ''}`;
            studentItem.id = `student-${studentId}`;

            studentItem.innerHTML = `
                <div class="card-avatar-container">
                    <img src="${avatarUrl}" class="card-avatar" alt="${name}">
                    <div class="card-status-dot ${isConnected ? 'connected' : ''}"></div>
                </div>

                <div class="card-info">
                    <div class="card-name">${name}</div>
                    <div class="card-meta">Estudiante</div>
                </div>

                <div class="student-actions">
                    ${!isConnected ? `
                        <button id="btn-connect-${studentId}" class="btn-connect-primary" onclick="handleConnectClick('${studentId}')">
                            <i class="fas fa-plug"></i> 
                            <span>Conectar</span>
                        </button>
                    ` : `
                        <button class="student-action-btn action-microphone ${isAudioActive ? 'active' : ''}" 
                                onclick="toggleIndividualAudio('${studentId}')" 
                                title="Audio">
                            <i class="fas fa-microphone${isAudioActive ? '' : '-slash'}"></i>
                        </button>
                        <button class="student-action-btn action-speaker ${audioMuted ? 'muted' : ''}" 
                                onclick="toggleIncomingAudio('${studentId}')" 
                                title="Escuchar">
                            <i class="fas fa-volume-${audioMuted ? 'mute' : 'up'}"></i>
                        </button>
                        <button class="student-action-btn action-screen ${isScreenActive ? 'active' : ''}" 
                                onclick="toggleIndividualScreen('${studentId}')" 
                                title="Pantalla">
                            <i class="fas fa-desktop"></i>
                        </button>
                        <button class="student-action-btn action-midi ${isMidiActive ? 'active' : ''}" 
                                onclick="toggleMidiTransmission('${studentId}')" 
                                title="Piano MIDI">
                            <i class="fas fa-music"></i>
                        </button>
                        <button class="student-action-btn action-chat ${isSelected ? 'active' : ''}" 
                                onclick="selectStudentForChat('${studentId}')" 
                                title="Chat">
                            <i class="fas fa-comment"></i>
                        </button>
                        <button class="student-action-btn action-close" 
                                onclick="disconnectStudent('${studentId}')" 
                                title="Desconectar">
                            <i class="fas fa-times"></i>
                        </button>
                    `}
                </div>
            `;

            studentItem.style.opacity = '0';
            studentsContainer.appendChild(studentItem);
            
            setTimeout(() => {
                studentItem.style.opacity = '1';
            }, 10);
        }

        function handleConnectClick(studentId) {
            const btn = document.getElementById(`btn-connect-${studentId}`);
            
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = `
                    <i class="fas fa-circle-notch fa-spinner-animate"></i> 
                    <span>Conectando...</span>
                `;
            }
            
            const connectionTimeout = setTimeout(() => {
                if (!studentConnections[studentId]?.connected) {
                    console.warn(`‚è±Ô∏è Timeout conectando con ${getStudentName(studentId)}`);
                    
                    if (peers[studentId]) {
                        peers[studentId].destroy();
                        delete peers[studentId];
                    }
                    
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = `
                            <i class="fas fa-plug"></i> 
                            <span>Reintentar</span>
                        `;
                    }
                    
                    alert(`No se pudo conectar con ${getStudentName(studentId)}. ¬øReintentar?`);
                }
            }, 15000);
            
            studentConnections[studentId] = { 
                connected: false, 
                timeout: connectionTimeout 
            };
            
            setTimeout(() => {
                connectToStudent(studentId);
            }, 50);
        }

        async function connectToStudent(studentId) {
            console.log(`Conectando con ${getStudentName(studentId)}...`);
            startPeer(studentId, true);
        }

        function disconnectStudent(studentId) {
            cleanupStudentConnection(studentId);
            signalsRef.push({ from: myId, to: studentId, type: 'close' });
            console.log(`Desconectado de ${getStudentName(studentId)}`);
            createStudentUI(studentId, getStudentName(studentId));
        }

        function cleanupStudentConnection(studentId) {
            if (pendingCleanupTimeouts[studentId]) {
                clearTimeout(pendingCleanupTimeouts[studentId]);
                delete pendingCleanupTimeouts[studentId];
            }
            if (peers[studentId]) {
                peers[studentId].destroy();
                delete peers[studentId];
            }
            
            if (individualAudioStreams[studentId]?.stream) {
                individualAudioStreams[studentId].stream.getTracks().forEach(track => track.stop());
                delete individualAudioStreams[studentId];
            }

            if (individualScreenStreams[studentId]?.stream) {
                individualScreenStreams[studentId].stream.getTracks().forEach(track => track.stop());
                delete individualScreenStreams[studentId];
            }

            studentConnections[studentId] = { connected: false };

            const audioEl = document.getElementById(`audio-${studentId}`);
            if (audioEl) audioEl.remove();

            if (activeMidiStudent === studentId) {
                activeMidiStudent = null;
                midiTransmissionEnabled = false;
                updateTransmissionStatus();
            }

            if (selectedStudent === studentId) {
                selectedStudent = null;
                updateStudentInfo(null);
                disableChat();
            }
        }

        function selectStudentForChat(studentId) {
            document.querySelectorAll('.student-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            selectedStudent = studentId;
            
            const studentElement = document.getElementById(`student-${studentId}`);
            if (studentElement) {
                studentElement.classList.add('selected');
            }
            
            updateStudentInfo(studentId);
            enableChat();

            document.querySelectorAll('.action-chat').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const chatBtn = document.querySelector(`#student-${studentId} .action-chat`);
            if (chatBtn) {
                chatBtn.classList.add('active');
            }

            loadChatHistory(studentId);
        }

        function loadChatHistory(studentId) {
            const chatLog = document.getElementById("chatLog");
            chatLog.innerHTML = '';
            
            const chatId = [myId, studentId].sort().join('-');
            chatsRef.child(chatId).off();
            
            chatsRef.child(chatId).on('child_added', snap => {
                const msg = snap.val();
                const senderName = msg.sender === myId ? "T√∫" : getStudentName(msg.sender);
                logChat(senderName, msg.text);
            });
        }

        // ==================== CONTROL DE AUDIO INDIVIDUAL ====================
        async function toggleIndividualAudio(studentId) {
            if (!peers[studentId] || !studentConnections[studentId]?.connected) {
                alert('El alumno no est√° conectado');
                return;
            }
            
            const isActive = individualAudioStreams[studentId]?.active || false;

            if (!isActive) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                    
                    individualAudioStreams[studentId] = { stream: stream, active: true };
                    
                    const audioTrack = stream.getAudioTracks()[0];
                    peers[studentId].addTrack(audioTrack, stream);
                    
                    console.log(`üé§ Audio activado para ${getStudentName(studentId)}`);
                    createStudentUI(studentId, getStudentName(studentId));
                    
                } catch (error) {
                    console.error('Error al activar audio:', error);
                    alert('No se pudo acceder al micr√≥fono');
                }
            } else {
                const stream = individualAudioStreams[studentId].stream;
                
                const senders = peers[studentId]._pc.getSenders();
                senders.forEach(sender => {
                    if (sender.track && sender.track.kind === 'audio' && stream.getAudioTracks().includes(sender.track)) {
                        peers[studentId].removeTrack(sender.track, stream);
                    }
                });
                
                stream.getTracks().forEach(track => track.stop());
                delete individualAudioStreams[studentId];
                
                console.log(`üé§ Audio desactivado para ${getStudentName(studentId)}`);
                createStudentUI(studentId, getStudentName(studentId));
            }
        }

        // ==================== CONTROL DE PANTALLA INDIVIDUAL ====================
        async function toggleIndividualScreen(studentId) {
            if (!peers[studentId] || !studentConnections[studentId]?.connected) {
                alert('El alumno no est√° conectado');
                return;
            }
            
            const isActive = individualScreenStreams[studentId]?.active || false;
            
            if (!isActive) {
                try {
                    const stream = await navigator.mediaDevices.getDisplayMedia({
                        video: {
                            displaySurface: 'window',
                            width: { ideal: 1920 },
                            height: { ideal: 1080 },
                            frameRate: { ideal: 30, max: 60 }
                        },
                        audio: false
                    });
                    
                    stream.getVideoTracks()[0].onended = () => {
                        console.log('üì∫ Usuario detuvo compartir pantalla');
                        toggleIndividualScreen(studentId);
                    };
                    
                    individualScreenStreams[studentId] = { 
                        stream: stream, 
                        active: true,
                        isNativeScreenShare: true
                    };
                    
                    const videoTrack = stream.getVideoTracks()[0];
                    if (videoTrack) {
                        const sender = peers[studentId].addTrack(videoTrack, stream);
                        individualScreenStreams[studentId].sender = sender;
                    }
                    
                    console.log(`‚úÖ Pantalla compartida con ${getStudentName(studentId)}`);
                    createStudentUI(studentId, getStudentName(studentId));
                    
                } catch (error) {
                    console.error('Error al compartir pantalla:', error);
                    
                    if (error.name === 'NotAllowedError') {
                        alert('‚ùå Compartir pantalla cancelado o no permitido.');
                    } else if (error.name === 'NotFoundError') {
                        alert('‚ùå No se encontr√≥ ninguna pantalla/ventana para compartir.');
                    } else {
                        alert('Error al compartir contenido: ' + error.message);
                    }
                }
            } else {
                const stream = individualScreenStreams[studentId].stream;
                
                const senders = peers[studentId]._pc.getSenders();
                senders.forEach(sender => {
                    if (sender.track && stream.getTracks().includes(sender.track)) {
                        peers[studentId].removeTrack(sender.track, stream);
                    }
                });
                
                stream.getTracks().forEach(track => track.stop());
                delete individualScreenStreams[studentId];
                
                console.log(`üñ•Ô∏è Compartir pantalla detenido para ${getStudentName(studentId)}`);
                createStudentUI(studentId, getStudentName(studentId));
            }
        }

        function toggleIncomingAudio(studentId) {
            const audioEl = document.getElementById(`audio-${studentId}`);
            if (audioEl) {
                audioEl.muted = !audioEl.muted;
                createStudentUI(studentId, getStudentName(studentId));
            }
        }

        function updateStudentInfo(studentId) {
            const infoBox = document.getElementById('selectedStudentInfo');
            
            if (studentId) {
                const isConnected = studentConnections[studentId]?.connected || false;
                infoBox.innerHTML = `
                    <i class="fas fa-user"></i>
                    <span><strong>${getStudentName(studentId)}</strong> - ${isConnected ? 'Conectado' : 'Desconectado'}</span>
                `;
                infoBox.classList.add('active');
            } else {
                infoBox.innerHTML = `
                    <i class="fas fa-info-circle"></i>
                    <span>Selecciona un alumno para iniciar</span>
                `;
                infoBox.classList.remove('active');
            }
        }

        function getStudentName(studentId) {
            const student = connectedStudents[studentId];
            return student ? (student.name || studentId) : studentId;
        }

        // ==================== WEBRTC ====================
        function startPeer(targetId, initiator) {
            const peer = new SimplePeer({
                initiator,
                stream: localStream,
                trickle: false,
                config: {
                    iceServers: [
                        { urls: "stun:stun.relay.metered.ca:80" },
                        { 
                            urls: "turn:a.relay.metered.ca:80", 
                            username: "fad444a63bcf5c8176a3e139", 
                            credential: "MQm2u8W0l1TCVMm0" 
                        },
                        { 
                            urls: "turn:a.relay.metered.ca:443", 
                            username: "fad444a63bcf5c8176a3e139", 
                            credential: "MQm2u8W0l1TCVMm0" 
                        }
                    ]
                }
            });
            
            peers[targetId] = peer;
            studentConnections[targetId] = { connected: false };

            peer._pc.oniceconnectionstatechange = () => {
                const state = peer._pc.iceConnectionState;
                console.log(`üßä ICE State [${getStudentName(targetId)}]: ${state}`);
                
                if (state === 'connected' || state === 'completed') {
                    studentConnections[targetId].connected = true;
                    createStudentUI(targetId, getStudentName(targetId));
                } else if (state === 'failed' || state === 'disconnected') {
                    console.warn(`‚ö†Ô∏è ICE ${state} para ${getStudentName(targetId)}`);
                    
                    if (state === 'failed') {
                        studentConnections[targetId].connected = false;
                        createStudentUI(targetId, getStudentName(targetId));
                    }
                }
            };

            peer.on("signal", data => {
                signalsRef.push({ from: myId, to: targetId, data });
            });

            peer.on("connect", () => {
                studentConnections[targetId].connected = true;
                
                if (studentConnections[targetId].timeout) {
                    clearTimeout(studentConnections[targetId].timeout);
                    delete studentConnections[targetId].timeout;
                }
                
                console.log(`‚úÖ Conexi√≥n WebRTC con ${getStudentName(targetId)}`);
                createStudentUI(targetId, getStudentName(targetId));
                
                const btnConnect = document.getElementById(`btn-connect-${targetId}`);
                if (btnConnect) {
                    btnConnect.disabled = false;
                    btnConnect.innerHTML = `
                        <i class="fas fa-check-circle"></i> 
                        <span>Conectado</span>
                    `;
                }
            });

            peer.on("data", msg => {
                try {
                    const data = JSON.parse(msg.toString());
                    
                    if (data.type === 'chat') {
                        if (selectedStudent === targetId) {
                            logChat(getStudentName(targetId), data.text);
                        }
                    }
                    else if (data.type === 'midi') {
                        console.log(`üéπ MIDI recibido de ${getStudentName(targetId)}: ${data.note}`);
                        
                        if (data.action === 'noteOn') {
                            triggerNoteOn(data.note);
                        } else if (data.action === 'noteOff') {
                            triggerNoteOff(data.note);
                        }
                    }
                    
                } catch (error) {
                    console.error("Error parsing peer data:", error);
                }
            });

            peer.on("stream", stream => {
                console.log(`Stream recibido de ${getStudentName(targetId)}`);
                
                let audioEl = document.getElementById(`audio-${targetId}`);
                if (!audioEl) {
                    audioEl = document.createElement('audio');
                    audioEl.id = `audio-${targetId}`;
                    audioEl.autoplay = true;
                    audioEl.style.display = 'none';
                    document.body.appendChild(audioEl);
                }
                audioEl.srcObject = stream;
                
                if (!studentConnections[targetId].connected) {
                    studentConnections[targetId].connected = true;
                    createStudentUI(targetId, getStudentName(targetId));
                }
            });

            peer.on("close", () => {
                studentConnections[targetId] = { connected: false };
                console.log(`Conexi√≥n cerrada con ${getStudentName(targetId)}`);
                
                usersRef.child(targetId).remove();
                
                createStudentUI(targetId, getStudentName(targetId));
            });

            peer.on("error", (err) => {
                console.error("Error en peer:", err);
                studentConnections[targetId] = { connected: false };
                
                usersRef.child(targetId).remove();
                
                const btnConnect = document.getElementById(`btn-connect-${targetId}`);
                if (btnConnect) {
                    btnConnect.disabled = false;
                    btnConnect.innerHTML = `
                        <i class="fas fa-plug"></i> 
                        <span>Conectar</span>
                    `;
                }
                
                createStudentUI(targetId, getStudentName(targetId));
            });
        }

        function listenForSignals() {
            signalsRef.on("child_added", snap => {
                const { from, to, data, type } = snap.val();

                if (to === myId) {
                    if (type === 'close') {
                        if (peers[from]) {
                            peers[from].destroy();
                            delete peers[from];
                        }
                        studentConnections[from] = { connected: false };
                        createStudentUI(from, getStudentName(from));
                    } else if (data) {
                        if (!peers[from]) {
                            startPeer(from, false);
                        }
                        try {
                            peers[from].signal(data);
                        } catch(e) { console.error(e); }
                    }
                }
                
                signalsRef.child(snap.key).remove();
            });
        }

        // ==================== CHAT ====================
        function sendMessage() {
            if (!selectedStudent) return;
            
            const input = document.getElementById("chatInput");
            const msg = input.value.trim();
            if (!msg) return;

            input.value = "";

            const chatId = [myId, selectedStudent].sort().join('-');
            const messageData = {
                text: msg,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                sender: myId,
                recipient: selectedStudent
            };
            chatsRef.child(chatId).push(messageData);

            if (peers[selectedStudent] && peers[selectedStudent].connected) {
                peers[selectedStudent].send(JSON.stringify({ 
                    type: 'chat', 
                    text: msg 
                }));
            }
        }

        function logChat(sender, message) {
            const chatLog = document.getElementById("chatLog");
            const messageElement = document.createElement("div");
            messageElement.classList.add("message");
            messageElement.classList.add(sender === "T√∫" ? "self" : "other");
            messageElement.innerHTML = `
                <div class="message-sender">${sender}</div>
                <div>${message}</div>
            `;
            chatLog.appendChild(messageElement);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        function enableChat() {
            document.getElementById("chatInput").disabled = false;
            document.getElementById("sendBtn").disabled = false;
        }

        function disableChat() {
            document.getElementById("chatInput").disabled = true;
            document.getElementById("sendBtn").disabled = true;
        }

        // ==================== MIDI ====================
        async function initMIDI() {
            if (navigator.requestMIDIAccess) {
                try {
                    midiAccess = await navigator.requestMIDIAccess();
                    console.log('‚úÖ MIDI Acceso concedido');

                    const inputs = midiAccess.inputs.values();
                    for (let input of inputs) {
                        console.log(`üéπ Piano MIDI: ${input.name}`);
                        midiInput = input;
                        midiInput.onmidimessage = handleMIDIMessage;
                        updateMIDIStatus(true, input.name);
                    }

                    if (!midiInput) {
                        console.warn('‚ö†Ô∏è No se detect√≥ piano MIDI');
                        updateMIDIStatus(false);
                    }

                    midiAccess.onstatechange = (e) => {
                        if (e.port.type === 'input') {
                            if (e.port.state === 'connected') {
                                console.log(`üîå Piano conectado: ${e.port.name}`);
                                midiInput = e.port;
                                midiInput.onmidimessage = handleMIDIMessage;
                                updateMIDIStatus(true, e.port.name);
                            } else {
                                console.log('üîå Piano desconectado');
                                updateMIDIStatus(false);
                                if (midiTransmissionEnabled) {
                                    activeMidiStudent = null;
                                    midiTransmissionEnabled = false;
                                    updateTransmissionStatus();
                                }
                            }
                        }
                    };

                } catch (err) {
                    console.error('‚ùå Error MIDI:', err);
                }
            } else {
                console.warn('Web MIDI API no soportada');
            }
        }

        function updateMIDIStatus(connected, deviceName = '') {
            const statusEl = document.getElementById('midiHeaderStatus');
            if (connected) {
                statusEl.innerHTML = `<i class="fas fa-circle"></i> Piano: ${deviceName}`;
                statusEl.classList.add('connected');
            } else {
                statusEl.innerHTML = '<i class="fas fa-circle"></i> Sin piano MIDI';
                statusEl.classList.remove('connected');
            }
        }

        function handleMIDIMessage(message) {
            const [command, note, velocity] = message.data;
            const noteName = midiNoteToName(note);

            if (command === 144 && velocity > 0) {
                triggerNoteOn(noteName);
            } else if (command === 128 || (command === 144 && velocity === 0)) {
                triggerNoteOff(noteName);
            }

            if (midiTransmissionEnabled && activeMidiStudent) {
                sendMIDIToStudent(activeMidiStudent, command === 144 && velocity > 0 ? 'noteOn' : 'noteOff', noteName, velocity);
            }
        }

        function midiNoteToName(midiNote) {
            const noteNames = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
            const octave = Math.floor(midiNote / 12) - 1;
            const noteName = noteNames[midiNote % 12];
            return `${noteName}${octave}`;
        }

        function sendMIDIToStudent(studentId, type, note, velocity) {
            if (peers[studentId] && peers[studentId].connected) {
                try {
                    const midiData = {
                        type: 'midi',
                        action: type,
                        note: note,
                        velocity: velocity,
                        timestamp: Date.now()
                    };
                    peers[studentId].send(JSON.stringify(midiData));
                } catch (error) {
                    console.error('Error sending MIDI:', error);
                }
            }
        }

        function toggleMidiTransmission(studentId) {
            if (!midiInput) {
                alert('No hay piano MIDI conectado');
                return;
            }
            
            if (!studentConnections[studentId]?.connected) {
                alert('El alumno no est√° conectado');
                return;
            }

            if (activeMidiStudent === studentId) {
                activeMidiStudent = null;
                midiTransmissionEnabled = false;
                console.log('üéπ Transmisi√≥n MIDI detenida');
            } else {
                activeMidiStudent = studentId;
                midiTransmissionEnabled = true;
                console.log(`üéπ Transmisi√≥n MIDI activa ‚Üí ${getStudentName(studentId)}`);
            }

            updateTransmissionStatus();
            createStudentUI(studentId, getStudentName(studentId));
        }

        function updateTransmissionStatus() {
            const statusBadge = document.getElementById('transmissionStatus');
            if (midiTransmissionEnabled && activeMidiStudent) {
                statusBadge.textContent = `Transmitiendo a ${getStudentName(activeMidiStudent)}`;
                statusBadge.classList.add('active');
            } else {
                statusBadge.textContent = 'Transmisi√≥n inactiva';
                statusBadge.classList.remove('active');
            }
        }

        // ==================== PIANO VISUAL ====================
        async function initPianoVisual() {
            await Tone.start();
            
            sampler = new Tone.Sampler({
                urls: {
                    A0: "A0.mp3", C1: "C1.mp3", "D#1": "Ds1.mp3", "F#1": "Fs1.mp3", A1: "A1.mp3",
                    C2: "C2.mp3", "D#2": "Ds2.mp3", "F#2": "Fs2.mp3", A2: "A2.mp3", C3: "C3.mp3",
                    "D#3": "Ds3.mp3", "F#3": "Fs3.mp3", A3: "A3.mp3", C4: "C4.mp3", "D#4": "Ds4.mp3",
                    "F#4": "Fs4.mp3", A4: "A4.mp3", C5: "C5.mp3", "D#5": "Ds5.mp3", "F#5": "Fs5.mp3",
                    A5: "A5.mp3", C6: "C6.mp3", "D#6": "Ds6.mp3", "F#6": "Fs6.mp3", A6: "A6.mp3",
                    C7: "C7.mp3", "D#7": "Ds7.mp3", "F#7": "Fs7.mp3", A7: "A7.mp3", C8: "C8.mp3"
                },
                release: 1,
                baseUrl: "https://tonejs.github.io/audio/salamander/"
            }).toDestination();

            renderPianoKeys();
        }

        function renderPianoKeys() {
            const container = document.getElementById('piano-keys');
            if (!container) return;
            
            container.innerHTML = '';

            const pattern = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
            const blackKeys = { 'C': 'Db', 'D': 'Eb', 'F': 'Gb', 'G': 'Ab', 'A': 'Bb' };

            const handleMouseName = (note) => {
                triggerNoteOn(note);
            };
            const handleMouseUp = (note) => {
                triggerNoteOff(note);
            };

            for (let octave = 1; octave <= 7; octave++) {
                for (let i = 0; i <= 6; i++) {
                    const note = pattern[i];
                    const noteName = `${note}${octave}`;
                    
                    const whiteKey = document.createElement('div');
                    whiteKey.className = 'piano-key white';
                    whiteKey.dataset.note = noteName;
                    whiteKey.id = `key-${noteName}`;
                    
                    whiteKey.addEventListener('mousedown', () => handleMouseName(noteName));
                    whiteKey.addEventListener('mouseup', () => handleMouseUp(noteName));
                    whiteKey.addEventListener('mouseleave', () => handleMouseUp(noteName));

                    container.appendChild(whiteKey);
                    
                    if (blackKeys[note]) {
                        const blackNoteName = `${blackKeys[note]}${octave}`;
                        const blackKey = document.createElement('div');
                        blackKey.className = 'piano-key black';
                        blackKey.dataset.note = blackNoteName;
                        blackKey.id = `key-${blackNoteName}`;

                        blackKey.addEventListener('mousedown', () => handleMouseName(blackNoteName));
                        blackKey.addEventListener('mouseup', () => handleMouseUp(blackNoteName));
                        blackKey.addEventListener('mouseleave', () => handleMouseUp(blackNoteName));

                        container.appendChild(blackKey);
                    }
                }
            }
        }

        function triggerNoteOn(noteName) {
            if (activeNotes[noteName]) return;
            
            if (sampler && Tone.context.state === 'running') {
                sampler.triggerAttack(noteName, Tone.now());
            }

            const key = document.getElementById(`key-${noteName}`);
            if (key) {
                key.classList.add('active');
                createFloatingLabel(noteName, key);
            }

            activeNotes[noteName] = true;
        }

        function triggerNoteOff(noteName) {
            if (!activeNotes[noteName]) return;
            
            if (sampler) {
                sampler.triggerRelease(noteName);
            }

            const key = document.getElementById(`key-${noteName}`);
            if (key) {
                key.classList.remove('active');
            }

            removeFloatingLabel(noteName);
            delete activeNotes[noteName];
        }

        function createFloatingLabel(noteName, keyElement) {
            const casing = document.getElementById('piano-top-casing');
            if (!casing) return;
            
            const keyRect = keyElement.getBoundingClientRect();
            const casingRect = casing.getBoundingClientRect();
            const keyCenterX = keyRect.left + (keyRect.width / 2);
            const relativeX = keyCenterX - casingRect.left;

            const lbl = document.createElement('div');
            lbl.className = 'casing-note-label';
            lbl.id = `lbl-${noteName}`;
            lbl.textContent = noteName.replace(/[0-9]/g, '');
            lbl.style.left = `${relativeX}px`;
            casing.appendChild(lbl);
        }

        function removeFloatingLabel(noteName) {
            const lbl = document.getElementById(`lbl-${noteName}`);
            if (lbl) lbl.remove();
        }
    </script>
</body>
</html>
