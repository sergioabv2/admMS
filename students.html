<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> 
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootcards/1.1.1/js/bootcards.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootcards/1.1.1/css/bootcards-desktop.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.2/angular.min.js"></script>
   <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">

<style> 
  
  body{
    background: white;
    margin-top: -50px;
  }
  
a.list-group-item:before {
  content: '';
}
  

.list-group-item {
  margin-left: 0px;
  padding-left: 15px;
}

.list-group-item .row > div.col-sm-5 {
  margin-left: 10px;
}

.list-group-item .row > div.col-sm-6 {
  margin-left: -10px;
}

.panel-title {
  margin-top: 13px;
  margin-right: 7px;
}

.list-group-item-heading,
.list-group-item-text {
  padding-left: 3px;
}



@media only screen and (max-width: 767px) {
  .list-group-item .row > div.col-sm-5 {
    margin-left: 0px;
    padding-left: 5px;
  }
  .list-group-item-heading {
    margin-top: 3px;
  }
  
  .mobile-back-btn {
    display: block;
    margin-bottom: 15px;
  }
  
  .companies-panel {
    display: none;
  }
  
  .list-panel {
    display: block;
  }
}

@media (min-width: 768px) and (max-width: 911px) {
  #search {
    padding-left: 0px;
  }
  
  .mobile-back-btn {
    display: none;
  }
  
  .companies-panel {
    display: block;
  }
  
  .list-panel {
    display: block;
  }
}

@media (min-width: 912px) {
  .mobile-back-btn {
    display: none;
  }
  
  .companies-panel {
    display: block;
  }
  
  .list-panel {
    display: block;
  }
}

  @media(min-width: 769px){
.companies-panel {
      position: sticky !important;
      top: 20px; 
      width: 45%;

      overflow-y: auto;


    }
  }
  
.mobile-back-btn {
  margin-bottom: 15px;
}
  
  

.message-container.unread {
  background-color: #f5f5f5;
  border-left: 3px solid #337ab7;
}

.message-content {
  margin-top: 10px;
  margin-left: 58px; /* Alineado con el avatar */
}

.media {
  margin-top: 0;
}

.btnPreview{
  transform: scale(0.9)
}
  
</style>

<div ng-app="companyApp" ng-controller="companyController" class="container">
  <div class="row">
    <div class="bootcards-list col-sm-6 list-panel">
      <div class="panel panel-default">
        <div class="panel-body">
      <form>
  <!-- Fila 1: Input + botón de búsqueda -->
  <div class="row">
    <div class="col-xs-8">
      <div class="form-group">
        <input type="text" class="form-control" placeholder="Search student" ng-model="searchQuery">
        <i class="fa fa-search"></i>
      </div>
    </div>
    <div class="col-xs-4">
          <div class="form-group">
         <select class="form-control" ng-model="selectedFilter" ng-change="applyFilter()">
      <option value="active">Activo</option>
      <option value="now">Ahora</option>
      <option value="today">Hoy</option>
      <option value="all">Todos</option>
    </select>
    </div>
    </div>
  </div>

  <!-- Fila 2: Botones de ordenamiento -->
  <div class="row" style="margin-top: 10px;">
    <div class="col-xs-12" >
      <button class="btn btn-default" style="color: black" ng-click="filterByHour()">Presencial</button>
      <button class="btn btn-default" style="color: black" ng-click="filterByDay()">Online</button>
      <button class="btn btn-default" style="color: black" ng-click="showAllStudents()">Plataforma</button>
    </div>
  </div>
</form>


        </div>
        <div class="list-group">
          <a class="list-group-item" href="#" ng-repeat="company in filteredStudents | filter:searchQuery" ng-click="showCompany(company.name, $event)">
            <div class="row">
              <div class="col-sm-1">
                <img style="border-radius: 50%;" ng-src="{{company.photo}}">
              </div>
              <div class="col-sm-5">
                <h4 class="list-group-item-heading">{{company.name}}</h4>
                <p class="list-group-item-text">{{company.status}}</p>
              </div>
              <div class="col-sm-6">
                <p class="list-group-item-text">{{company.level}}</p>
                <p class="list-group-item-text">{{company.classtime}}</p>
              </div>
            </div>
          </a>
        </div>
      </div>
    </div>
    <div class="col-sm-6 companies-panel" >
      <button class="btn btn-default mobile-back-btn" ng-click="backToList()">
        <i class="fa fa-arrow-left"></i> Back to List
      </button>
      
      <div class="panel panel-default company-detail" ng-repeat="company in companies" ng-if="selectedCompany == company.name">
        <div class="panel-heading clearfix">
        
          <h3 class="panel-title pull-left" ng-if="company.status == 'ACTIVO'"> <i class="ri-progress-8-line" style="color: #28a745; text-shadow: 0 0 10px #28a745; margin-right: 4px"></i> ACTIVO </h3>
 <h3 class="panel-title pull-left" ng-if="company.status == 'PENDING'"> <i class="ri-progress-8-line" style="color: orange; text-shadow: 0 0 10px orange; margin-right: 4px"></i> PENDIENTE </h3>

  <h3 class="panel-title pull-left" ng-if="company.status == 'INACTIVO'"> <i class="ri-progress-8-line" style="color: red; text-shadow: 0 0 10px red; margin-right: 4px"></i> INACTIVO </h3>
         <button class="btn btn-default pull-right" ng-if="company.status != 'ACTIVO'">
            Registrar pago
          </button> 
        </div>
        
        
        <div class="list-group">
           <div class="list-group-item">
               <img class="pull-left" style="border-radius: 50%; width: 65px; height: 65px; margin-top: 4px; margin-right: 10px;" ng-src="{{company.photo}}">
            <h4 class="list-group-item-heading">
             {{company.name}}
              </h4>
            <p class="list-group-item-text">{{company.mail}}</p>
             <p class="list-group-item-text">{{company.level}}</p>
     
          </div>
          
       <div class="list-group-item" ng-show="activeTab === 'Analytics'">  

      
         
        <div class="panel panel-default">
    <div class="panel-body" style="height: 260px; overflow-y: auto;">
      <!-- Lista de grabaciones -->
      <div ng-repeat="lsn in company.currentLsn" class="recording-container">
        <div class="media">
          <div class="media-left">
            <i class="fa fa-clock fa-2x"></i>
          </div>
          <div class="media-body">
            <h5 class="media-heading">
              {{lsn.name}}
              <small class="text-muted pull-right">date</small>
            </h5>
            <p>
              <span ng-if="lsn.status == 'Evaluada'" class="text-success">
                Evaluado
              </span>
              <span ng-if="lsn.status != 'Evaluada'" class="text-warning">
                Pendiente
              </span>
            </p>
          </div>
          <div class="media-right" style="display: flex; flex-direction: row;">
         <button class="btn btn-default btnPreview" style="width: 62px; ng-click="openRecordingModal(recording)">Evaluar</button>
            <button class="btn btn-default btnPreview" ng-click="abrirNuevaPestana(lsn.pdf);$event.preventDefault();$event.stopPropagation()">
              Abrir
            </button>
          </div>
        </div>
        <hr ng-if="!$last">
      </div>
    </div>

     <div class="panel-footer">
      <button class="btn btn-primary btn-block">
        <i class="fa fa-plus"></i> Agregar actividad
      </button>
    </div>
   
  </div>
             </div>
          
          
   <div class="list-group-item" id="Agenda" ng-show="activeTab === 'Agenda'">
  <div class="panel panel-default">
   
    <div class="panel-body" style="height: 260px; overflow-y: auto;">
      <!-- Lista de mensajes -->

        <div ng-if="company.agenda && company.agenda.length > 0">
      <div ng-repeat="event in company.agenda" class="message-container" >
        
        <!-- Cabecera del mensaje -->
        <div class="media">
          <div class="media-left">
             <span ng-if="event.attendance == 1" class="text-success">
              <i class="fa fa-check-circle fa-2x"></i>
            </span>
            <span ng-if="event.attendance == 0" class="text-danger">
              <i class="fa fa-times-circle fa-2x"></i>
            </span>
          </div>
          <div class="media-body">
            <h5 class="media-heading">{{event.title}}
              <small class="text-muted pull-right">{{returnDateFormat(event.start)}}</small>
            </h5>
            <p >{{event.title}}</p>
          </div>
           <div class="media-right" style="display: flex; flex-direction: row;">
         <button class="btn btn-default btnPreview" style="width: 62px; ng-click="openRecordingModal(recording)"><i class="fa fa-play"></i></button>
            <button class="btn btn-default btnPreview" ng-if="!recording.evaluated" ng-click="evaluateRecording(recording)">
              Asistencia
            </button>
          </div>
        </div>
        <hr ng-if="!$last">
      </div>
        </div>

         <div ng-if="!company.agenda || company.agenda.length === 0" class="text-center" style="padding: 20px;">
        <i class="fa fa-calendar fa-4x" style="color: #ddd;"></i>
        <h4>No existen fechas</h4>
        <p>Aún no hay fechas registradas</p>
      </div>


    </div>
 <div class="panel-footer">
      <button class="btn btn-primary btn-block">
        <i class="fa fa-plus"></i> Nuevo evento
      </button>
    </div>
  </div>
</div>
          



<div class="list-group-item" id="Messages" ng-show="activeTab === 'Messages'">
  <div class="panel panel-default">
    <div class="panel-body" style="height: 260px; overflow-y: auto;">
      <!-- Lista de grabaciones -->
      <div ng-if="company.audios && company.audios.length > 0">
      <div ng-repeat="recording in company.audios" class="recording-container">
        <div class="media">
          <div class="media-left">
            <i class="fa fa-music fa-2x"></i>
          </div>
          <div class="media-body">
            <h5 class="media-heading">
              {{recording.lesson}}
              <small class="text-muted pull-right">{{returnDateFormat(event.start)}}</small>
            </h5>
            <p>
              <span ng-if="recording.evaluated" class="text-success">
                Evaluado
              </span>
              <span ng-if="!recording.evaluated" class="text-warning">
                Pendiente
              </span>
            </p>
          </div>
          <div class="media-right" style="display: flex; flex-direction: row;">
         <button class="btn btn-default btnPreview" style="width: 62px; ng-click="openRecordingModal(recording)"><i class="fa fa-play"></i></button>
            <button class="btn btn-default btnPreview" ng-if="!recording.evaluated" ng-click="evaluateRecording(recording)">
              Evaluar
            </button>
          </div>
        </div>
        <hr ng-if="!$last">
      </div>
        </div>

         <div ng-if="!company.audios || company.audios.length === 0" class="text-center" style="padding: 20px;">
        <i class="fa fa-music fa-4x" style="color: #ddd;"></i>
        <h4>No existen archivos</h4>
        <p>Aún no hay grabaciones registradas</p>
      </div>

    </div>
   
  </div>
</div>

          
          
        </div>
        
        
        
        
    <div class="panel-footer">
  <div class="btn-group btn-group-justified">
    <div class="btn-group">
      <button class="btn btn-default" ng-click="showTab('Analytics')">
       <i class="ri-folder-open-line"></i> Evaluación
      </button>
    </div>
    <div class="btn-group">
      <button class="btn btn-default" ng-click="showTab('Agenda')">
        <i class="ri-calendar-line"></i> Agenda
      </button>
    </div>
    <div class="btn-group">
      <button class="btn btn-default" ng-click="showTab('Messages')">
       <i class="ri-record-circle-line"></i> Grabación
      </button>
    </div>
  </div>
</div>
        
        
        
        
      </div>
    </div>
  </div>
</div>

<script>
angular.module('companyApp', [])
  .controller('companyController', ['$http', '$scope', function($http, $scope) {

    $scope.companies = [];
//  $scope.orderList = 'name';

   var requestData = {
                action: "getAdminData",
                token: "U2FsdGVkX18LC0oGisKqGLC5uGXpU9h3zw8tJYi5QZDfYwdF32/rwVQsfq3hqkBE"
     //localStorage.getItem('ADtoken')
              };

              var config = {
                headers: {
                  "Content-Type": "text/plain;charset=utf-8"
                },
                followRedirects: true
              };
   
  $http.post('https://script.google.com/macros/s/AKfycbxXD35z5FSf_m_dwBt5qcBwWq2L7IDc7KBrYGfix6hUa4kvJ1TFpjU82NltFXezUroGgQ/exec', requestData, config)
    .then(function(response) { 
      $scope.companies = response.data.students;
      $scope.filterByActive()

  });
  
 


  
     $scope.returnDateFormat = function(date){
    const dat = new Date(date);
  const options = { weekday: 'long', month: 'long', day: 'numeric' };
    var dat2 = dat.toLocaleDateString("es-mx",options).replace(",","");
    return dat2.charAt(0).toUpperCase() + dat2.slice(1);
  }
    
     $scope.abrirNuevaPestana = function(URL) {
     const regex = /\/d\/([^\/]+)\//;
    const matches = URL.match(regex);
    var id = matches ? matches[1] : null;
     var url = "https://admin.mozartacademy.mx/edit?fileId="+id
    window.open(url, '_blank');
  };
    
    
    $scope.activeTab = 'Analytics'; // Tab por defecto

$scope.showTab = function(tabName) {
  $scope.activeTab = tabName;
};
    
    $scope.selectedCompany = '';
    
    $scope.showCompany = function(companyId, event) {
      event.preventDefault();
      $scope.selectedCompany = companyId;
      
      // For mobile view
      if (window.innerWidth <= 767) {
        document.querySelector('.list-panel').style.display = 'none';
        document.querySelector('.companies-panel').style.display = 'block';
      }
    };
    
    $scope.backToList = function() {
      // For mobile view
      if (window.innerWidth <= 767) {
        document.querySelector('.list-panel').style.display = 'block';
        document.querySelector('.companies-panel').style.display = 'none';
      }
    };
    
    // Handle window resize
    window.onresize = function() {
      if (window.innerWidth > 767) {
        document.querySelector('.list-panel').style.display = 'block';
        document.querySelector('.companies-panel').style.display = 'block';
      } else if ($scope.selectedCompany) {
        document.querySelector('.list-panel').style.display = 'none';
        document.querySelector('.companies-panel').style.display = 'block';
      } else {
        document.querySelector('.list-panel').style.display = 'block';
        document.querySelector('.companies-panel').style.display = 'none';
      }
    };




$scope.applyFilter = function() {
  switch($scope.selectedFilter) {
    case 'active':
      $scope.filterByActive();
      break;
    case 'now':
      $scope.filterByHour(); // Asumo que "Ahora" usa filterByHour
      break;
    case 'today':
      $scope.filterByDay();
      break;
    case 'all':
      $scope.showAllStudents(); 
      break;
    default:
      $scope.filterByActive();
  }
};



      $scope.filteredStudents = [];
       $scope.noStudentsMessage = '';

        $scope.filterByActive = function() {
    $scope.filteredStudents = $scope.companies.filter(function(student) {
      return student.status === 'ACTIVO';
    });
  };


  $scope.filterByDay = function() {
    $scope.filteredStudents = $scope.companies.filter(function(student) {
      return student.classtime.split(" ")[0] === $scope.getCurrentDay() && student.status === 'ACTIVO';
    });
     $scope.noStudentsMessage = $scope.filteredStudents.length === 0 ? 'No hay alumnos en este instante.' : '';
  };

  
  $scope.filterByHour = function() {
    $scope.filteredStudents = $scope.companies.filter(function(student) {
      return (student.classtime.split(" ")[0] === $scope.getCurrentDay() && parseInt(student.classtime.split(" ")[2].split(":")[0]) === $scope.getCurrentHour()  && student.status === 'ACTIVO');
    });
    $scope.noStudentsMessage = $scope.filteredStudents.length === 0 ? 'No hay alumnos en este instante.' : '';
  };
  
  
  $scope.showAllStudents = function() {
  $scope.filteredStudents = $scope.companies;
  $scope.noStudentsMessage = '';
};




   
    $scope.getCurrentDay = function() {
    var days = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
    var now = new Date();
    return days[now.getDay()];
  };

  $scope.getCurrentHour = function() {
    var now = new Date();
    var hours = now.getHours();
    return hours
  };




  }]);
</script>
