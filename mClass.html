
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> 
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootcards/1.1.1/js/bootcards.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootcards/1.1.1/css/bootcards-desktop.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.2/angular.min.js"></script>
   <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/combine/npm/tone@14.7.77,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0"></script>

 

<style> 
  
  body{
    background: white;
    margin-top: -50px;
  }
  
a.list-group-item:before {
  content: '';
}
  

.list-group-item {
  margin-left: 0px;
  padding-left: 15px;
}

.list-group-item .row > div.col-sm-5 {
  margin-left: 10px;
}

.list-group-item .row > div.col-sm-6 {
  margin-left: -10px;
}

.panel-title {
  margin-top: 13px;
  margin-right: 7px;
}

.list-group-item-heading,
.list-group-item-text {
  padding-left: 3px;
}



@media only screen and (max-width: 767px) {
  .list-group-item .row > div.col-sm-5 {
    margin-left: 0px;
    padding-left: 5px;
  }
  .list-group-item-heading {
    margin-top: 3px;
  }
  
  .mobile-back-btn {
    display: block;
    margin-bottom: 15px;
  }
  
  .companies-panel {
    display: none;
  }
  
  .list-panel {
    display: block;
  }
}

@media (min-width: 768px) and (max-width: 911px) {
  #search {
    padding-left: 0px;
  }
  
  .mobile-back-btn {
    display: none;
  }
  
  .companies-panel {
    display: block;
  }
  
  .list-panel {
    display: block;
  }
}

@media (min-width: 912px) {
  .mobile-back-btn {
    display: none;
  }
  
  .companies-panel {
    display: block;
  }
  
  .list-panel {
    display: block;
  }
}

  @media(min-width: 769px){
.companies-panel {
      position: sticky !important;
      top: 20px; 
      width: 45%;

      overflow-y: auto;


    }
  }
  
.mobile-back-btn {
  margin-bottom: 15px;
}
  
  

.message-container.unread {
  background-color: #f5f5f5;
  border-left: 3px solid #337ab7;
}

.message-content {
  margin-top: 10px;
  margin-left: 58px; /* Alineado con el avatar */
}

.media {
  margin-top: 0;
}

.btnPreview{
  transform: scale(0.9)
}

#attendanceBtn {
  cursor: pointer;
  padding: 10px;
  border-radius: 50%;
  transition: all 0.3s;
}

#attendanceBtn:hover {
  background-color: #f5f5f5;
}

.modal-content {
  border-radius: 0;
}

.modal-header {
  background-color: #f8f9fa;
  border-bottom: 1px solid #e9ecef;
}
  
  /* Eliminar el fondo del midi-player y sus partes internas */
midi-player {
  --midi-player-background: transparent !important;
  --midi-player-controls-background: transparent !important;
  background: transparent !important;
  margin-top: 7px !important;
}

/* Si el componente usa shadow parts */
midi-player::part(control-panel) {
  background: transparent !important;
}

midi-player::part(background) {
  background: transparent !important;
}


/*-----------------------
    Audio Player - AP
------------------------*/
.ap {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  width: 100%;
  height: 64px;
  font-family: inherit;
  font-size: 14px;
  -webkit-user-select: none;
     -moz-user-select: none;
      -ms-user-select: none;
          user-select: none;
  border-top: 1px solid #ccc;
  background: #f2f2f2;
  box-shadow: 0 -1px 10px rgba(0, 0, 0, 0.1);
  z-index: 99999;
  display: none;
}

.ap__inner {
  display: flex;
  max-width: 1440px;
  margin: auto;
}

.ap__item {
  display: flex;
  justify-content: center;
  align-items: center;
}

.ap__item--player {
  flex: 2; /* Ocupa 2 partes del espacio disponible */
  min-width: 0; /* Permite que el contenido se ajuste correctamente */
  justify-content: flex-start; /* Alinea el contenido a la izquierda */
  padding-left: 15px; /* Espaciado opcional */
}

.ap__item--settings {
  flex: 1; /* Ocupa 1 parte del espacio disponible */
  justify-content: flex-end; /* Alinea los botones a la derecha */
  padding-right: 15px; /* Espaciado opcional */
}

.track__title {
  position: absolute;
  top: 2px;
  left: 17px;
  font-size: 12px; /* Tamaño pequeño */
  font-weight: 500;
  color: #666;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  z-index: 2;
  padding: 0 5px;
}

.ap__item--playback > .ap__controls,
.ap__item--settings > .ap__controls {
  flex: 0 25%;
  margin-top: -7px;
}



@-webkit-keyframes fs {
  0% {
    opacity: 0;
    transform: scale(0.5);
  }
  100% {
    opacity: 1;
    transform: scale(1);
  }
}

@keyframes fs {
  0% {
    opacity: 0;
    transform: scale(0.5);
  }
  100% {
    opacity: 1;
    transform: scale(1);
  }
}




.progress__preload {
  background: #c4c4c4;
  z-index: 0;
}

.ap__controls,
.ap button {
  margin: 0;
  padding: 0;
  border: 0;
  outline: 0;
  background: transparent;
  position: relative;
  display: block;
  height: 50px;
  text-align: center;
  cursor: pointer;
  transition: background 0.3s ease;
}

.ap__controls:active,
.ap button:active {
  background: rgba(0, 0, 0, 0.1);
}
.ap__controls:hover,
.ap button:hover {
  opacity: 1;
}



.ap__controls.is-active > svg {
  fill: steelblue;
  filter: drop-shadow(0 0 3px rgba(70, 130, 180, 0.4));
}

@media (max-width: 1024px) {
  .ap__item > .ap__controls {
    flex: 1;
  }
}
@media (max-width: 580px) {
  .ap {
    min-width: 250px;
  }

  .ap, .ap__inner {
    height: auto;
  }

  .ap__inner {
    flex-wrap: wrap;
  }

  .ap__item--player{
    margin-bottom: -5px;
  }


   .ap__item--player,
  .ap__item--settings {
    flex: 1 1 50% !important; /* Media query tiene prioridad */
    order: 2;
    min-width: initial;
    justify-content: center;
margin: 0;
  }
  
  .ap__item--settings {
    margin-top: -10px;
     margin-bottom: 10px;
  }
}

   #commentModal .modal-body {
  padding: 15px;
}

#commentModal textarea {
  resize: vertical;
  min-height: 100px;
}

.panel-default{
  margin-bottom: -1px !important;
}
  
  .drop-zone {
    border: 2px dashed #ccc; /* Borde punteado */
    border-radius: 5px;      /* Bordes redondeados */
    padding: 20px;           /* Espacio interno */
    text-align: center;      /* Texto centrado */
    color: #666;             /* Color del texto */
    cursor: pointer;         /* Cursor de puntero */
    margin-top: 15px;        /* Margen superior para separarlo del input */
    background-color: #f9f9f9; /* Color de fondo */
    transition: background-color 0.3s ease; /* Transición suave para el hover */
}

.drop-zone.dragover {
    background-color: #e9e9e9; /* Cambia el fondo cuando se arrastra algo encima */
    border-color: #337ab7;   /* Cambia el color del borde */
}

/* Opcional: Estilo para cuando se ha soltado un archivo */
.drop-zone.file-dropped {
    background-color: #dff0d8; /* Color verde claro */
    border-color: #4CAF50;    /* Borde verde */
    color: #3c763d;
}

 .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
   display: flex;
            font-family: Arial, sans-serif;
        }

        .loading-container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 300px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            margin: 0 auto 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            margin-bottom: 20px;
            font-size: 16px;
            color: #333;
        }

.progress-container {
            height: 6px;
            background-color: #e0e0e0;
            border-radius: 3px;
            margin-bottom: 20px;
            overflow: hidden;
        }

/* Añade esto */
@keyframes progressAnimation {
  0% { width: 0%; }
  100% { width: 100%; }
}

.progress-bar {
  height: 100%;
  background-color: #3498db;
  animation: progressAnimation 4s linear forwards; /* <- Simulación */
  border-radius: 3px;
}

</style>

<div ng-app="companyApp" ng-controller="companyController" class="container">
  
  
     <div class="loading-overlay" ng-if="loading">
  <div class="loading-container">
    <div class="loading-spinner"></div>
    <div class="loading-text">Procesando, por favor espere...</div>
    <div class="progress-container">
      <div class="progress-bar"></div>
    </div>
  </div>
</div>
  
  
  <div class="row">
    <div class="bootcards-list col-sm-6 list-panel">
      <div class="panel panel-default">
        <div class="panel-body">
      <form>
  <!-- Fila 1: Input + botón de búsqueda -->
  <div class="row">
    <div class="col-xs-8">
      <div class="form-group">
        <input type="text" class="form-control" placeholder="Search student" ng-model="searchQuery">
        <i class="fa fa-search"></i>
      </div>
    </div>
    <div class="col-xs-4">
          <div class="form-group">
         <select class="form-control" ng-model="selectedFilter" ng-change="applyFilter()">
      <option value="active">Activo</option>
      <option value="all">Inactivo</option>
    </select>
    </div>
    </div>
  </div>

  <!-- Fila 2: Botones de ordenamiento -->
  <div class="row" style="margin-top: 10px;">
    <div class="col-xs-12" >
      <button class="btn btn-default" style="color: black" ng-click="filterByHour()">Ahora</button>
      <button class="btn btn-default" style="color: black" ng-click="filterByDay()">Hoy</button>
      <button class="btn btn-default" style="color: black" ng-click="filterByActive()">Todos</button>
      <div class="pull-right" style="cursor: pointer; margin-top: 10px; margin-right: 17px; font-size: 20px;" ng-click="reload()"><i class="ri-loop-left-fill"></i> </div>
    </div>

  </div>


</form>
        </div>
        

        <div class="list-group">
          <a class="list-group-item" href="#" ng-repeat="company in filteredStudents | filter:{name: searchQuery}" ng-click="showCompany(company.name, $event)">
            <div class="row">
              <div class="col-sm-1">
                <img style="border-radius: 50%;" ng-src="{{company.photo}}">
              </div>
              <div class="col-sm-5">
                <h4 class="list-group-item-heading">{{company.name}}</h4>
                <p class="list-group-item-text">{{company.level}} - Lección {{company.lsn}}</p>
              </div>
              <div class="col-sm-6">
                <p class="list-group-item-text">{{company.classtime[0]}}</p>
                <p class="list-group-item-text">{{company.classtime[1]}}</p>
              </div>
            </div>
          </a>
        </div>
      </div>
    </div>
    <div class="col-sm-6 companies-panel" >
      <button class="btn btn-default mobile-back-btn" ng-click="backToList()">
        <i class="fa fa-arrow-left"></i> Back to List
      </button>
      
      <div class="panel panel-default company-detail" ng-repeat="company in companies" ng-if="selectedCompany == company.name" >
        <div class="panel-heading clearfix">
        
          <h3 class="panel-title pull-left" ng-if="company.status == 'ACTIVO'"> <i class="ri-progress-8-line" style="color: #28a745; text-shadow: 0 0 10px #28a745; margin-right: 4px"></i> ACTIVO </h3>
 <h3 class="panel-title pull-left" ng-if="company.status == 'PENDING'"> <i class="ri-progress-8-line" style="color: orange; text-shadow: 0 0 10px orange; margin-right: 4px"></i> PENDIENTE </h3>

  <h3 class="panel-title pull-left" ng-if="company.status == 'INACTIVO'"> <i class="ri-progress-8-line" style="color: red; text-shadow: 0 0 10px red; margin-right: 4px"></i> INACTIVO </h3>
         <button class="btn btn-default pull-right" ng-if="company.status != 'ACTIVO'">
            Registrar pago
          </button> 
        </div>
        
        
        <div class="list-group" >
           <div class="list-group-item">
               <img class="pull-left" style="border-radius: 50%; width: 65px; height: 65px; margin-top: 4px; margin-right: 10px;" ng-src="{{company.photo}}">
                <button class="btn btn-default btnPreview pull-right" ng-if="company.phone != ''"><i class="ri-whatsapp-line" ng-click="sendWhats(company.phone)"></i>Whatsapp</button>
            <h4 class="list-group-item-heading">
             {{company.name}}
              </h4>
            <p class="list-group-item-text">{{company.mail}} - {{company.phone}}</p>
             <p class="list-group-item-text" style="font-size: 12px; color: silver">Próximo pago: {{company.nextPay}}</p>
     
          </div>
          
       <div class="list-group-item" ng-show="activeTab === 'Analytics'" >  

      
         
        <div class="panel panel-default" >
    <div class="panel-body" style="height: 220px; overflow-y: auto;">


      <div ng-repeat="lsn in company.currentLsn" class="recording-container" ng-show="activeContent === 'Activity'">
        <div class="media" style="margin-bottom: -14px !important;">
          <div class="media-left" style="cursor: pointer;" ng-click="toggleLsn(lsn)">
            <i class="ri-time-line fa-2x" ng-if="lsn.status != 'Evaluada'"></i>
             <i class="ri-check-line fa-2x" style="color: green; opacity: 0.8; text-shadow: 0 0 10px green;" ng-if="lsn.status == 'Evaluada'"></i>
          </div>
          <div class="media-body">
            <h5 class="media-heading">
              {{lsn.name}}
   
                <button class="btn btn-default btnPreview pull-right" style="width: 62px;" ng-click="abrirNuevaPestana(lsn.pdf);$event.preventDefault();$event.stopPropagation()">
              Abrir
            </button>
            </h5>
            <p style="font-size: 12px; font-weight: 400">
              <span ng-if="lsn.status == 'Evaluada'" class="text-success">
                Evaluado
              </span>
              <span ng-if="lsn.status != 'Evaluada'" class="text-warning">
                Pendiente
              </span>
            </p>
          </div>
     
        </div>
        <hr ng-if="!$last">
      </div>


      <div ng-repeat="rep in company.repertoire" ng-if="company.repertoire && company.repertoire.length > 0" class="recording-container" ng-show="activeContent === 'Repertoire'">
        <div class="media" style="margin-bottom: -14px !important;">
          <div class="media-left">
            <i class="ri-file-music-line fa-2x" ></i>
          </div>
          <div class="media-body">
            <h5 class="media-heading">
              {{rep.title}}
   
                <button class="btn btn-default btnPreview pull-right" style="width: 62px;" ng-click="abrirNuevaPestana(rep.pdf);$event.preventDefault();$event.stopPropagation()">
              Abrir
            </button>
            </h5>
            <p style="font-size: 12px; font-weight: 400">
              <span  class="text-warning">
                {{rep.grade}}
              </span>
            </p>
          </div>
     
        </div>
        <hr ng-if="!$last">
      </div>

       <div ng-if="!company.repertoire || company.repertoire.length === 0" ng-show="activeContent === 'Repertoire'" class="text-center" style="padding: 20px;">
        <i class="ri-file-close-line fa-4x" style="color: #ddd;"></i>
        <h4>Sin repertorio</h4>
        <p>Aún no hay contenido cargado</p>
      </div>


    </div>

 <div class="btn-group-justified"  style="height: 40px; transform: scale(0.9);">
    <div class="btn-group">
      <button class="btn btn-default" ng-click="showCont('Activity')">
       Actividades
      </button>
    </div>
    <div class="btn-group">
      <button class="btn btn-default" ng-click="showCont('Repertoire')">
   Repertorio
      </button>
    </div>
  </div>


 <div class="panel-footer">
      <button class="btn btn-primary btn-block" ng-click="openEditModal2(company)">
       <i class="ri-edit-2-line"></i>Editar
      </button>
    </div>
   
  </div>
             </div>
          
          
   <div class="list-group-item" id="Agenda" ng-show="activeTab === 'Agenda'">
  <div class="panel panel-default">
   
    <div class="panel-body" style="height: 260px; overflow-y: auto;">
      <!-- Lista de mensajes -->

        <div ng-if="company.agenda && company.agenda.length > 0">
      <div ng-repeat="event in company.agenda" class="message-container" >
        
        <!-- Cabecera del mensaje -->
        <div class="media" style="margin-bottom: -14px !important;">
          <div class="media-left" style="cursor: pointer;" ng-click="toggleAttendance(event)">
             <span ng-if="event.attendance === 1" >
              <i class="ri-check-line fa-2x" style="color: green; opacity: 0.8; text-shadow: 0 0 10px green;"></i>
            </span>
            <span ng-if="event.attendance === 0" >
              <i class="ri-close-line fa-2x" style="color: red; opacity: 0.8; text-shadow: 0 0 10px red;"></i>
            </span>
              <span ng-if="event.attendance === ''" >
              <i class="ri-subtract-line fa-2x"></i>
            </span>
          </div>
          <div class="media-body" >
            <h5 class="media-heading">{{event.title}}
              <small class="text-muted pull-right" style="cursor: pointer">Editar</small>
            </h5>
            <p style=" font-size: 12px; color: gray; font-weight: 400">{{returnDateFormat(event.start)}}</p>
          </div>
        
        </div>
        <hr ng-if="!$last">
      </div>
        </div>

         <div ng-if="!company.agenda || company.agenda.length === 0" class="text-center" style="padding: 20px;">
        <i class="fa fa-calendar fa-4x" style="color: #ddd;"></i>
        <h4>No existen fechas</h4>
        <p>Aún no hay fechas registradas</p>
      </div>


    </div>
 <div class="panel-footer">
    <button class="btn btn-primary btn-block" ng-click="openEditModal(company)">
       <i class="ri-edit-2-line"></i>Editar
      </button>
    </div>
  </div>
</div> 
          



<div class="list-group-item" id="Messages" ng-show="activeTab === 'Messages'">
  <div class="panel panel-default">
    <div class="panel-body" style="height: 210px; overflow-y: auto;">
      <!-- Lista de grabaciones -->
      <div ng-if="company.audios && company.audios.length > 0">
      <div ng-repeat="recording in company.audios" class="recording-container">
        <div class="media" style="margin-bottom: -15px !important;">
          <div class="media-left">
            <i class="fa fa-music fa-2x"></i>
          </div>
          <div class="media-body" >
            <h5 class="media-heading">
              {{recording.lesson}}
  
               <button class="btn btn-default btnPreview pull-right" style="width: 62px;" ng-click="openPlayer(recording)"><i class="fa fa-play"></i></button>
            </h5>
            <p style=" font-size: 12px; font-weight: 400; color: gray">
               {{returnDateFormat(recording.date)}}
            </p>
            <p style="font-size: 14px;">{{recording.comment}}</p>
          </div>
       
        </div>
        <hr ng-if="!$last">
      </div>
        </div>

         <div ng-if="!company.audios || company.audios.length === 0" class="text-center" style="padding: 20px;">
        <i class="fa fa-music fa-4x" style="color: #ddd;"></i>
        <h4>No existen archivos</h4>
        <p>Aún no hay grabaciones registradas</p>
      </div>
    </div>


<div style="height: 40px; margin: 7px; border: 1px solid silver;">
    <span style="margin: 3px; font-size: 13px">Último mensaje: {{msgLast}}</span>
  </div>


     <div class="panel-footer" style="display: flex; align-items: center; gap: 8px;">
       <input style="flex: 1;" id="msgInput"/> <button class="btn btn-info" ng-click="openMsgModal(company)" style="width: 42px;"><i class="ri-flashlight-fill" ></i></button> <button class="btn btn-success" ng-click="sendMsg(company)">Enviar</button>
    </div>
   
  </div>
</div>

          
          
        </div>
        
        
        
        
    <div class="panel-footer" >
  <div class="btn-group btn-group-justified">
    <div class="btn-group">
      <button class="btn btn-default" ng-click="showTab('Analytics')">
       <i class="ri-award-line"></i> Evaluación
      </button>
    </div>
    <div class="btn-group">
      <button class="btn btn-default" ng-click="showTab('Agenda')">
        <i class="ri-calendar-line"></i> Agenda
      </button>
    </div>
    <div class="btn-group">
      <button class="btn btn-default" ng-click="showTab('Messages')">
       <i class="ri-folder-open-line"></i> Grabación
      </button>
    </div>
  </div>
</div>
        
        



        
        
      </div>
    </div>

                  <!-- Modal -->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Opciones</h4>
      </div>
      <div class="modal-body">
        <select class="form-control" ng-model="selectedOption">
          <option value="1">Agregar evento</option>
          <option value="2">Registrar pago</option>
        </select>
        
        <!-- Contenido dinámico según opción -->
        <div ng-if="selectedOption == '1'" style="margin-top: 15px;">
          <div class="form-group">
            <label>Título del evento</label>
            <input type="text" class="form-control" ng-model="newEvent.title">
          </div>
          <div class="form-group">
            <label>Fecha y hora</label>
            <input type="datetime-local" class="form-control" ng-model="newEvent.date">
          </div>
        </div>
        
        <div ng-if="selectedOption == '2'" style="margin-top: 15px;">
          
          <div class="form-group">
            <label>Fecha de pago</label>
            <input type="date" class="form-control" ng-model="newPayment" >
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" ng-click="processOption()">Continuar</button>
      </div>
    </div>
  </div>
</div>




                  <!-- Modal2 -->
<div class="modal fade" id="editModal2" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Evaluación</h4>
      </div>
      <div class="modal-body">
        <select class="form-control" ng-model="selectedOption2">
          <option value="1">Aprobar todo</option>
          <option value="2">Asignar nivel</option>
           <option value="3">Agregar pieza a repertorio</option>
           <option value="4">Agregar documento</option>
        </select>
         
        <!-- Contenido dinámico según opción -->
        <div ng-if="selectedOption2 == '2'" style="margin-top: 15px;">

         <div class="form-group">
        <label for="nivelSelect">Nivel</label>
        <select class="form-control" id="nivelSelect">
            <option value="0">Preparatorio</option>
            <option value="1">Nivel 1</option>
           <option value="2">Nivel 2</option>
           <option value="3">Nivel 3</option>
           <option value="4">Nivel 4</option>
           <option value="5">Nivel 5</option>
        </select>
    </div>

     <div class="form-group">
        <label for="leccionSelect">Lección</label>
        <select class="form-control" id="leccionSelect">
            <option value="1">Lección 1</option>
            <option value="2">Lección 2</option>
            <option value="3">Lección 3</option>
            <option value="4">Lección 4</option>
            <option value="5">Lección 5</option>
            <option value="6">Lección 6</option>
            <option value="7">Lección 7</option>
            <option value="8">Lección 8</option>
            <option value="9">Lección 9</option>
        </select>
    </div>
        </div>


         <div ng-if="selectedOption2 == '3'" style="margin-top: 15px;">
        <div class="form-group">
    <label for="leccionSelect">Dificultad</label>
        <select class="form-control" id="leccionSelect">
            <option value="0">Preparatorio</option>
            <option value="1">Grado 1</option>
            <option value="2">Grado 2</option>
            <option value="3">Grado 3</option>
            <option value="4">Grado 4</option>
            <option value="5">Grado 5</option>
            <option value="6">Grado 6</option>
            <option value="7">Grado 7</option>
            <option value="8">Grado 8</option>
            <option value="9">Profesional</option>
        </select>
      </div>
      <div class="form-group">
    <label for="leccionSelect">Lista</label>
        <select class="form-control" id="leccionSelect">
            <option value="A">A</option>
            <option value="B">B</option>
            <option value="C">C</option>
        </select>
      </div>
      </div>

        
        <div ng-if="selectedOption2 == '4'" style="margin-top: 15px;">
          
 <div class="form-group">
  <label for="dropZone">Subir archivo PDF</label>
        <div id="dropZone" class="drop-zone"
         file-dropzone
         file-model="selectedPdfFile"
         on-file-dropped="handleDropzoneFile(file)">
        Arrastra y suelta tu archivo PDF aquí, o haz clic en el botón de arriba.
        <br>
        <small>(Solo archivos PDF)</small>
    </div>
       </div>


      <div style="display: flex; flex: row; justify-content: center; gap: 12px">
        <div class="form-group" >
            <label>Titulo</label>
            <input type="text" class="form-control"  >
          </div>
            <div class="form-group">
            <label>Autor</label>
            <input type="text" class="form-control"  style="max-width: 150px">
          </div>
          <div class="form-group">
    <label for="gradeSelect">Dificultad</label>
        <select class="form-control" id="gradeSelect">
            <option value="0">Preparatorio</option>
            <option value="1">Grado 1</option>
            <option value="2">Grado 2</option>
            <option value="3">Grado 3</option>
            <option value="4">Grado 4</option>
            <option value="5">Grado 5</option>
            <option value="6">Grado 6</option>
            <option value="7">Grado 7</option>
            <option value="8">Grado 8</option>
            <option value="9">Profesional</option>
        </select>
      </div>
       <div class="form-group">
            <label for="bars">Barras</label>
            <input type="number" class="form-control"  style="max-width: 70px"  id="bars">
          </div>
      </div>

        
      </div>




      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" ng-click="processOption2()">Continuar</button>
      </div>
    </div>
  </div>
</div>









                                <!-- Modal3 -->
<div class="modal fade" id="msgModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Opciones</h4>
      </div>
      <div class="modal-body">
        <select class="form-control" ng-model="msgType" ng-change="updateResp()">
          <option value="ready"> Instrucción </option>
          <option value="BPM"> BPM inicial</option>
          <option value="BPM+"> BPM+ </option>
           <option value="BPM+"> BPM+ </option>
          <option value="present"> Presentación </option>
        </select>
        <br>
      <select class="form-control" ng-model="msgResp" ng-options="option for option in options"></select> 
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button> 
        <button type="button" class="btn btn-primary" ng-click="selectMsg()">Continuar</button>
      </div>
    </div>
  </div>
</div>



 

                                 <!-- Player -->
   
 
<div class="ap" id="ap">
   <div class="ap__inner">
  
      <div class="ap__item ap__item--player">
 <div class="track__title">{{currentRecording.lesson}}</div>
         <midi-player 
          id="midiPlayer"
          sound-font 
          visualizer="#midiVisualizer"
          style="width: 100%">
        </midi-player>
      </div>
      <div class="ap__item ap__item--settings">
          <button class="ap__controls" id="commentAudioBtn" ng-click="openCommentModal(currentRecording)">
               <i class="ri-message-3-line fa-2x"></i>
          </button>
        <button class="ap__controls" id="checkAudioBtn">
           <i class="ri-checkbox-circle-line fa-2x"></i>
        </button>
        <button class="ap__controls" id="closeAudioBtn" ng-click="closePlayer()">
          <i class="ri-close-circle-fill fa-2x"></i>
        </button>
      </div>
  </div>
</div>

<!-- Modal para comentarios -->
<div class="modal fade" id="commentModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Agregar comentario</h4>
      </div>
      <div class="modal-body">
        <textarea 
          class="form-control" 
          rows="3" 
          ng-model="newComment"
          placeholder="Escribe tu comentario aquí..."></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" ng-click="saveComment()">Guardar</button>
      </div>
    </div>
  </div>
</div>

  </div>
</div>

<script>
angular.module('companyApp', [])
  .controller('companyController', ['$http', '$scope', function($http, $scope) {

    $scope.companies = [];
    $scope.loading = true;


   var requestData = {
                action: "getMozartData",
                token: "U2FsdGVkX19FIE+E8FpvkMxOZo1u4xby0/CffZfQmhrcIWavhFpXISrp/BBYZzmm"
     //localStorage.getItem('ADtoken')
              };

              var config = {
                headers: {
                  "Content-Type": "text/plain;charset=utf-8"
                },
                followRedirects: true
              };
  
  $scope.loadData = function(){ 
  $http.post('https://script.google.com/macros/s/AKfycbxXD35z5FSf_m_dwBt5qcBwWq2L7IDc7KBrYGfix6hUa4kvJ1TFpjU82NltFXezUroGgQ/exec', requestData, config)
    .then(function(response) { 
      $scope.companies = response.data;
      $scope.filterByActive()
      $scope.loading = false;
    });
  }

  $scope.loadData()

  $scope.reload = function(){
    $scope.loading = true;
    $scope.loadData()
  }
 

$scope.sendWhats = function(phone) {
    var url = "https://wa.me/521" + phone;
    window.open(url, "_blank");
  }


 

  $scope.returnDateFormat = function(date) {
    const dat = new Date(date);
    const optionsDate = { 
        weekday: 'long', 
        month: 'long', 
        day: 'numeric' 
    };
    const optionsTime = {
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
    };

    var dateStr = dat.toLocaleDateString("es-MX", optionsDate).replace(",", "");
    dateStr = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);
    var timeStr = dat.toLocaleTimeString("es-MX", optionsTime);
    return dateStr + ' - ' + timeStr;
};
    
     $scope.abrirNuevaPestana = function(URL) {
     const regex = /\/d\/([^\/]+)\//;
    const matches = URL.match(regex);
    var id = matches ? matches[1] : null;
     var url = "https://admin.mozartacademy.mx/edit?fileId="+id
    window.open(url, '_blank');
  };
    
    
    $scope.activeTab = 'Analytics'; 
$scope.showTab = function(tabName) {
  $scope.activeTab = tabName;
};

   $scope.activeContent = 'Activity'; 
$scope.showCont = function(contName) {
  $scope.activeContent = contName;
};
    
    $scope.selectedCompany = '';
    
    $scope.showCompany = function(companyId, event) {
      event.preventDefault();
      $scope.selectedCompany = companyId;
      
      // For mobile view
      if (window.innerWidth <= 767) {
        document.querySelector('.list-panel').style.display = 'none';
        document.querySelector('.companies-panel').style.display = 'block';
      }
    };
    
    $scope.backToList = function() {
      // For mobile view
      if (window.innerWidth <= 767) {
        document.querySelector('.list-panel').style.display = 'block';
        document.querySelector('.companies-panel').style.display = 'none';
      }
    };
    
    // Handle window resize
    window.onresize = function() {
      if (window.innerWidth > 767) {
        document.querySelector('.list-panel').style.display = 'block';
        document.querySelector('.companies-panel').style.display = 'block';
      } else if ($scope.selectedCompany) {
        document.querySelector('.list-panel').style.display = 'none';
        document.querySelector('.companies-panel').style.display = 'block';
      } else {
        document.querySelector('.list-panel').style.display = 'block';
        document.querySelector('.companies-panel').style.display = 'none';
      }
    };


$scope.toggleAttendance = function(event) {
  if(event.attendance === 1) {
    event.attendance = 0;
  } else  {
    event.attendance = 1;
  } 
};

$scope.toggleLsn = function(lsn) {
  if(lsn.status != 'Evaluada') {
    lsn.status = 'Evaluada';
  } else  {
    lsn.status = 'Pendiente';
  } 
};


$scope.selectedOption = '1';
$scope.selectedOption2 = '1';
$scope.currentCompany = null; 
$scope.currentCompany2 = null; 
$scope.currentRecording = null; 
$scope.today = new Date().toISOString().split('T')[0];
$scope.newEvent = { title: '', date: '' };

$scope.openEditModal = function(company) {
    $scope.currentCompany = company; 
  $('#editModal').modal('show');
};

$scope.openMsgModal = function(company) {
    $scope.currentCompany = company; 
  $('#msgModal').modal('show');
};

$scope.processOption = function() {
  if($scope.selectedOption == '1') {
    // Agregar nuevo evento al currentCompany
    var newEventObj = {
      title: $scope.newEvent.title,
      start: new Date($scope.newEvent.date),
      attendance: ''
    };
    
    if(!$scope.currentCompany.agenda) {
      $scope.currentCompany.agenda = []; // Inicializar array si no existe
    }
    
    $scope.currentCompany.agenda.push(newEventObj);
    $scope.newEvent = { title: '', date: '' }; // Limpiar campos
    
  } else if($scope.selectedOption == '2') {
    
  }
  
  $('#editModal').modal('hide');
};




$scope.openEditModal2 = function(company) {
    $scope.currentCompany2 = company; 
  $('#editModal2').modal('show');
};

$scope.processOption2 = function() {
  if($scope.selectedOption2 == '1') {
    // Agregar nuevo evento al currentCompany
    var newEventObj = {
      title: $scope.newEvent.title,
      start: new Date($scope.newEvent.date),
      attendance: ''
    };
    
    if(!$scope.currentCompany2.agenda) {
      $scope.currentCompany2.agenda = []; // Inicializar array si no existe
    }
    
    $scope.currentCompany2.agenda.push(newEventObj);
    $scope.newEvent = { title: '', date: '' }; // Limpiar campos
    
  } else if($scope.selectedOption2 == '2') {
    
  }
  
  $('#editModal2').modal('hide');
};




$scope.options = []
$scope.msgLast = ""
$scope.updateResp = function() {
  if ($scope.msgType === 'BPM') {
    $scope.options = ['35', '40', '45', '50', '55', '60', '70', 'Final'];
  }else if ($scope.msgType === 'BPM+') {
    $scope.options = ['+5', '-5', '+10'];
  } else if ($scope.msgType === 'ready') {
    $scope.options = ['Solo Derecha', 'Ahora Izquierda', 'Ambas manos', 'Siguiente ejercicio', 'Cambio de pagina', 'Tema concluido'];
  } else if ($scope.msgType === 'present') {
     $scope.options = ['Primera', 'Corta'];
  }   else if ($scope.msgType === 'delete') {
    text = ""
  } 
};
  
  
   $scope.selectMsg = function(){
    var opt = $scope.msgResp
    var text = ""
    if(opt == '+5'){
      text = "Listo, sube 5 bits más al metrónomo"
    }else if(opt == '-5'){
  text = "Por favor, reduce 5 bits menos a la velocidad del metrónomo"
    }else if(opt == '+10'){
  text = "Perfecto, sube 10 bits más al metrónomo"
    }else if(opt == '35'){
  text = "Bien, vamos a encender el metrónomo ajustando la velocidad en 35 bits"
    }else if(opt == '40'){
  text = "Bien, vamos a encender el metrónomo ajustando la velocidad en 40 bits"
    }else if(opt == '45'){
  text = "Bien, vamos a encender el metrónomo ajustando la velocidad en 45 bits"
    }else if(opt == '50'){
  text = "Bien, vamos a encender el metrónomo ajustando la velocidad en 50 bits"
    }else if(opt == '55'){
  text = "Bien, vamos a encender el metrónomo ajustando la velocidad en 55 bits"
    }else if(opt == '60'){
  text = "Bien, vamos a encender el metrónomo ajustando la velocidad en 60 bits"
    }else if(opt == '70'){
  text = "Bien, vamos a encender el metrónomo ajustando la velocidad en 70 bits"
    }else if(opt == 'Final'){
  text = "Perfecto, vamos a ajustar la velocidad del metrónomo a la velocidad final que indica el ejercicio"
    }else if(opt == 'Solo Derecha'){
  text = "Vamos a comenzar a trabajar la actividad leyendo solo la mano derecha sin metrónomo"
    }else if(opt == 'Ahora Izquierda'){
  text = "Listo, ahora vamos a darle un repaso solo a la mano izquierda"
    }else if(opt == 'Ambas manos'){
  text = "Ya está, ahora si vamos a leer con ambas manos"
    }else if(opt == 'Siguiente ejercicio'){
  text = "Listo ya quedó el ejercicio, vamos a continuar trabajando el siguiente ejercicio"
    }else if(opt == 'Cambio de pagina'){
  text = "Perfecto, vamos a cambiar de página y continuar con el siguiente ejercicio"
    }else if(opt == 'Primera'){
  text = "Hola buenas tardes, me presento, soy Alicia y seré tu asistente virtual, asistiré al profesor en darte indicaciones cuando él se encuentre ocupado"
    }else if(opt == 'Corta'){
  text = "Hola, ¿como estás?, bienvenido"
    }else if(opt == 'Tema concluido'){
  text = "Excelente trabajo, puedes tomar un breve descanso de 1 minuto para refrescar la mente y no saturarse de información"
    }
 
    document.getElementById('msgInput').value = text;
     $('#msgModal').modal('hide');
 }



 $scope.sendMsg = function(student){
    var msg = document.getElementById('msgInput').value
    if(msg != ''){
  
  /*   
 var requestData = {
   action: "msg",
   mail: student.mail,
   msg: msg,
  };

  var config = {
    headers: {
      "Content-Type": "text/plain;charset=utf-8"
    },
    followRedirects: true, 
  };
     
$http.post('https://script.google.com/macros/s/AKfycbxXD35z5FSf_m_dwBt5qcBwWq2L7IDc7KBrYGfix6hUa4kvJ1TFpjU82NltFXezUroGgQ/exec', requestData, config)

*/
$scope.msgLast = msg
    }
   document.getElementById('msgInput').value = '';
   $scope.msgResp = ''
 }




$scope.midiPlayer = null;
$scope.progressPercent = 0;
    

$scope.openPlayer = function(recording) {
      $scope.currentRecording = recording;
      $('#ap').css('display', 'block');

      if ($scope.midiPlayer) {
        $scope.midiPlayer.stop();
        $scope.midiPlayer.src = recording.midi;
        console.log('Archivo MIDI asignado:', recording.midi);
      }
    };
    
    $scope.closePlayer  = function() {
       $('#ap').css('display', 'none');
   $scope.currentRecording = null; 
   if ($scope.midiPlayer) $scope.midiPlayer.stop();
   
}
    

// Inicializar el reproductor
$scope.initPlayer = function() {
  $scope.midiPlayer = document.getElementById('midiPlayer');
  
  // Configurar eventos
  $scope.midiPlayer.addEventListener('ready', function() {
    $scope.$apply();
  });
  
  $scope.midiPlayer.addEventListener('pause', function() {
    $scope.$apply();
  });
  
  $scope.midiPlayer.addEventListener('play', function() {
    $scope.$apply();
  });
  
};

// Llamar a initPlayer cuando se carga la vista
$scope.initPlayer();



// Variables para comentarios
$scope.newComment = '';
$scope.commentRecording = null;

// Abrir modal de comentarios
$scope.openCommentModal = function(recording) {
  $scope.commentRecording = recording;
  $scope.newComment = recording.comment || ''; // Cargar comentario existente si hay
  $('#commentModal').modal('show');
};

// Guardar comentario
$scope.saveComment = function() {
  if ($scope.commentRecording) {
    // Si no existe la propiedad comment, la creamos
    if (!$scope.commentRecording.hasOwnProperty('comment')) {
      $scope.commentRecording.comment = '';
    }
    
    // Asignar el nuevo comentario
    $scope.commentRecording.comment = $scope.newComment;
    
   
  }
  
  $('#commentModal').modal('hide');
  $scope.newComment = ''; // Limpiar el textarea
};



$scope.applyFilter = function() {
  switch($scope.selectedFilter) {
    case 'active':
      $scope.filterByActive();
      break;
    case 'now':
      $scope.filterByHour(); // Asumo que "Ahora" usa filterByHour
      break;
    case 'today':
      $scope.filterByDay();
      break;
    case 'all':
      $scope.showAllStudents(); 
      break;
    default:
      $scope.filterByActive();
  }
};



      $scope.filteredStudents = [];
       $scope.noStudentsMessage = '';

        $scope.filterByActive = function() {
    $scope.filteredStudents = $scope.companies.filter(function(student) {
      return student.status === 'ACTIVO';
    });
  };


  $scope.filterByDay = function() {
    $scope.filteredStudents = $scope.companies.filter(function(student) {
      return ((student.classtime[0].split(" ")[0] === $scope.getCurrentDay()) || (student.classtime[1].split(" ")[0] === $scope.getCurrentDay())) && student.status === 'ACTIVO'
    });
  };

   
  $scope.filterByHour = function() {
    $scope.filteredStudents = $scope.companies.filter(function(student) {
     return student.online == 1;
    });
  };
  
  
  $scope.showAllStudents = function() {
  $scope.filteredStudents = $scope.companies;
  $scope.noStudentsMessage = '';
};




   
    $scope.getCurrentDay = function() {
    var days = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
    var now = new Date();
    return days[now.getDay()];
  };

  $scope.getCurrentHour = function() {
    var now = new Date();
    var hours = now.getHours();
    return hours
  };
 



  }]);
</script>
