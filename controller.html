 
<html lang="es">
<head>   
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Profesor - Mozart Academy</title>
    <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
     <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
</head>

<style>
    :root {
    --primary-color: #FF4757;
    --secondary-color: #2ed573;
    --bg-light: #f8f9fa;
    --card-bg: #ffffff;
    --text-dark: #2f3542;
    --text-muted: #6c757d;
    --border-color: #dee2e6;
    --piano-bg: #1e1e1e;
    --piano-height: 110px; /* Antes era 150px, lo hacemos más compacto */
    --key-white-height: 100%; /* Ahora ocuparán todo el alto del contenedor */
    --key-black-height: 60%;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', sans-serif;
    background: var(--bg-light);
    color: var(--text-dark);
    overflow: hidden;
}

.professor-container {
    width: 100vw;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* ==================== HEADER ==================== */
.professor-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, #ff6b81 100%);
    color: white;
    padding: 15px 25px;
    box-shadow: 0 4px 15px rgba(255, 71, 87, 0.2);
    flex-shrink: 0;
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    max-width: 100%;
}

.professor-header h1 {
    font-size: 20px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
}

.midi-status-header {
    display: flex;
    align-items: center;
    gap: 10px;
}

.midi-indicator {
    font-size: 13px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 20px;
}

.midi-indicator i {
    font-size: 8px;
}

.midi-indicator.connected {
    background: rgba(46, 213, 115, 0.3);
}

.midi-indicator.connected i {
    animation: pulse-midi 1.5s infinite;
}

@keyframes pulse-midi {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
}

/* ==================== MAIN LAYOUT ==================== */
.main-layout {
    display: grid;
    /* CAMBIO AQUÍ: Reduce de 380px a 260px */
    grid-template-columns: 1fr 340px; 
    gap: 0;
    flex: 1;
    overflow: hidden;
    height: calc(100vh - 70px);
}

/* ==================== MAIN CENTER ==================== */
.main-center {
    background: white;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}


.students-section {
    background: white;
    border-bottom: 1px solid var(--border-color);
    padding: 15px 0;
    display: flex;
    flex-direction: column;
    
    /* --- CAMBIO IMPORTANTE --- */
    flex: 1;          /* Esto hace que ESTA sección crezca para llenar el hueco */
    min-height: 0;    /* Evita problemas de desbordamiento en Flexbox */
    overflow: hidden; /* Mantiene el contenido controlado */
}

.section-header {
    padding: 0 20px; /* Padding solo para el título */
    margin-bottom: 10px;
}

.section-header h2 {
    font-size: 16px;
    font-weight: 800;
    color: var(--text-dark);
    display: flex;
    align-items: center;
    gap: 8px;
}

.section-header i {
    color: var(--primary-color);
}

.student-info-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: var(--text-muted);
    padding: 8px 16px;
    background: var(--bg-light);
    border-radius: 20px;
}

.student-info-badge.active {
    background: rgba(46, 213, 115, 0.1);
    color: var(--secondary-color);
    font-weight: 600;
}

.students-grid {
    display: flex; /* Flex en fila */
    flex-direction: row; /* Horizontal */
    overflow-x: auto; /* Scroll horizontal */
    overflow-y: hidden;
    gap: 15px;
    padding: 10px 20px 20px 20px; /* Espacio para la sombra de abajo */
    scroll-behavior: smooth;
    /* Ocultar barra de scroll en Firefox */
    scrollbar-width: thin; 
}

.students-grid::-webkit-scrollbar {
    height: 8px; /* Altura de la barra horizontal */
}
.students-grid::-webkit-scrollbar-track {
    background: transparent;
}
.students-grid::-webkit-scrollbar-thumb {
    background: #ddd;
    border-radius: 4px;
}
.students-grid::-webkit-scrollbar-thumb:hover {
    background: #bbb;
}

.student-item {
    /* Dimensiones fijas para la tarjeta */
    min-width: 220px; 
    width: 220px;
    background: white;
    border-radius: 16px;
    min-height: 240px;
    border: 1px solid var(--border-color);
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.student-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    border-color: var(--primary-color);
}

.student-item.connected {
    border-color: var(--secondary-color);
    background: linear-gradient(to bottom, #fff 0%, rgba(46, 213, 115, 0.05) 100%);
}

.student-item.selected {
    border-color: var(--primary-color);
    background: linear-gradient(to bottom, #fff 0%, rgba(255, 71, 87, 0.05) 100%);
    box-shadow: 0 0 0 2px rgba(255, 71, 87, 0.1);
}

.student-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.student-name {
    font-weight: 600;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--text-dark);
}

.student-status {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--text-muted);
}

.student-status.connected {
    background: var(--secondary-color);
    box-shadow: 0 0 8px rgba(46, 213, 115, 0.5);
    animation: pulse-status 2s infinite;
}

@keyframes pulse-status {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

.card-avatar-container {
    position: relative;
    margin-bottom: 10px;
}

.card-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    background: #eee;
}

.card-status-dot {
    position: absolute;
    bottom: 2px;
    right: 2px;
    width: 14px;
    height: 14px;
    background: #ccc;
    border: 2px solid white;
    border-radius: 50%;
}
.card-status-dot.connected {
    background: var(--secondary-color);
    box-shadow: 0 0 5px rgba(46, 213, 115, 0.6);
}

/* Info del Estudiante */
.card-info {
    text-align: center;
    margin-bottom: 15px;
    width: 100%;
}

.card-name {
    font-weight: 700;
    font-size: 15px;
    color: var(--text-dark);
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.card-meta {
    font-size: 11px;
    color: var(--text-muted);
    background: var(--bg-light);
    padding: 4px 8px;
    border-radius: 12px;
    display: inline-block;
    margin-bottom: 4px;
}

.card-lesson {
    font-size: 12px;
    color: var(--primary-color);
    font-weight: 600;
}

.student-actions {
    margin-top: auto; /* Empuja los botones al final */
    width: 100%;
    display: flex;
    justify-content: center;
    gap: 8px;
    padding-top: 10px;
    border-top: 1px solid var(--bg-light);
}

.student-action-btn {
    width: 28px;
    height: 28px;
    font-size: 11px;
}

.student-action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.student-action-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
    transform: none;
}

.action-connect {
    background: var(--primary-color);
}

.action-microphone {
    background: var(--secondary-color);
}

.action-microphone.active {
    background: var(--primary-color);
    box-shadow: 0 0 15px rgba(255, 71, 87, 0.4);
}

.action-speaker {
    background: #ff9800;
}

.action-speaker.muted {
    background: var(--text-muted);
}

.action-desktop {
    background: #5c80bc;
}

.action-desktop.active {
    background: var(--primary-color);
    box-shadow: 0 0 15px rgba(255, 71, 87, 0.4);
}

.action-piano {
    background: #6c5ce7;
}

.action-piano.active {
    background: var(--primary-color);
    box-shadow: 0 0 15px rgba(255, 71, 87, 0.4);
    animation: pulse-piano 1.5s infinite;
}

@keyframes pulse-piano {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.08); }
}

.action-chat {
    background: #5c80bc;
}

.action-chat.active {
    background: var(--primary-color);
}

.action-close {
    background: var(--primary-color);
}


.piano-section {
    flex: 0 0 auto;       /* No crece */
    margin-top: auto;     /* Se empuja al fondo si sobra espacio */
    display: flex;
    flex-direction: column;
    
    /* CAMBIO AQUÍ: 30px arriba para más aire, 20px en el resto */
    padding: 30px 20px 20px 20px; 
    
    overflow: hidden;
    background: var(--bg-light);
    border-top: 1px solid var(--border-color);
}

.piano-header-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--border-color);
}

.piano-header-bar h3 {
    font-size: 18px;
    font-weight: 800;
    color: var(--text-dark);
    display: flex;
    align-items: center;
    gap: 10px;
}

.piano-header-bar i {
    color: var(--primary-color);
}

.piano-controls {
    display: flex;
    align-items: center;
    gap: 12px;
}

.transmission-badge {
    font-size: 12px;
    font-weight: 700;
    padding: 6px 14px;
    background: var(--text-muted);
    color: white;
    border-radius: 20px;
}

.transmission-badge.active {
    background: var(--secondary-color);
    box-shadow: 0 0 15px rgba(46, 213, 115, 0.4);
    animation: pulse-badge 1.5s infinite;
}

@keyframes pulse-badge {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.piano-wrapper {
    height: var(--piano-height, 180px);
    background: var(--piano-bg);
    border-radius: 12px 12px 0 0; /* Opcional: Quitar bordes redondeados de abajo para que se vea integrado */
    overflow: hidden;
    box-shadow: 0 -5px 25px rgba(0, 0, 0, 0.1); /* Sombra hacia arriba */
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    
    /* CAMBIO CLAVE: "Resorte" hacia abajo */
    margin-top: auto;    /* Empuja el elemento lo más abajo posible */
    margin-bottom: 0;    /* Elimina el margen inferior */
}

#piano-top-casing {
    position: relative;
    width: 100%;
    height: 25px;
    background: #333;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-shrink: 0;
}

.casing-note-label {
    position: absolute;
    top: 50%;
    transform: translate(-50%, -50%);
    color: #fff;
    font-size: 11px;
    font-weight: 700;
    background: rgba(0, 0, 0, 0.7);
    padding: 3px 10px;
    border-radius: 4px;
    pointer-events: none;
    white-space: nowrap;
    z-index: 20;
}

#piano-container {
    position: relative;
    width: 100%;
    flex: 1;
    overflow-x: auto;
    overflow-y: hidden;
    background: #1a1a1a;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 0;
}

#piano-container::-webkit-scrollbar {
    height: 8px;
    background: #222;
}

#piano-container::-webkit-scrollbar-thumb {
    background: #444;
    border-radius: 4px;
}

#piano-keys {
    position: relative;
    display: flex;
    height: 100%;
    padding: 0 10px; /* Quitamos el padding vertical excesivo */
    align-items: flex-start; /* IMPORTANTE: Cambia de flex-end a flex-start */
}


.piano-key {
    position: relative;
    cursor: pointer;
    transition: all 0.05s ease;
    border: 1px solid #999;
    flex-shrink: 0;
}

.piano-key.white {
    width: 18px; /* ANTES: 40px -> AHORA: 18px (Esto permite ver más octavas) */
    height: 100%;
    background: linear-gradient(to bottom, #ffffff 0%, #f5f5f5 100%);
    border-radius: 0 0 3px 3px; /* Bordes más sutiles */
    z-index: 1;
    border-right: 1px solid #ccc;
    box-shadow: inset 0 -2px 5px rgba(0, 0, 0, 0.1);
    flex-shrink: 0;
}

.piano-key.white:hover {
    background: linear-gradient(to bottom, #f8f8f8 0%, #e8e8e8 100%);
}

.piano-key.white.active {
    background: var(--primary-color) !important;
    box-shadow: 0 0 20px rgba(255, 71, 87, 0.6), inset 0 2px 5px rgba(0, 0, 0, 0.3);
    transform: translateY(1px);
}

.piano-key.black {
    width: 12px; /* ANTES: 24px -> AHORA: 12px */
    height: 60%;
    background: linear-gradient(to bottom, #1a1a1a 0%, #000000 100%);
    
    /* Ajuste de márgenes para centrar la tecla negra (mitad del ancho) */
    margin-left: -6px; 
    margin-right: -6px;
    
    z-index: 2;
    border-radius: 0 0 2px 2px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    flex-shrink: 0;
}

.piano-key.black:hover {
    background: linear-gradient(to bottom, #2a2a2a 0%, #0a0a0a 100%);
}

.piano-key.black.active {
    background: var(--primary-color) !important;
    box-shadow: 0 0 15px rgba(255, 71, 87, 0.6), inset 0 2px 5px rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.3) !important;
}

/* ==================== RIGHT SIDEBAR ==================== */
.right-sidebar {
    background: white;
    border-left: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* TABS */
.sidebar-tabs {
    display: flex;
    border-bottom: 2px solid var(--border-color);
    background: var(--bg-light);
}

.tab-btn {
    flex: 1;
    padding: 15px;
    border: none;
    background: transparent;
    color: var(--text-muted);
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.tab-btn:hover {
    background: rgba(255, 71, 87, 0.05);
    color: var(--text-dark);
}

.tab-btn.active {
    background: white;
    color: var(--primary-color);
    border-bottom: 3px solid var(--primary-color);
}

.tab-content {
    display: none;
    flex: 1;
    flex-direction: column;
    overflow: hidden;
}

.tab-content.active {
    display: flex;
}






/* ==================== DIRECTORIO DE USUARIOS (MEJORADO) ==================== */
.users-directory-view {
    display: flex;
    flex-direction: column;
    height: 100%;
    background: var(--bg-light);
}

.directory-header {
    padding: 20px 20px 15px 20px;
    background: white;
    border-bottom: 1px solid var(--border-color);
    flex-shrink: 0;
}

.directory-header h3 {
    font-size: 16px;
    font-weight: 800;
    color: var(--text-dark);
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
}

.directory-header h3 i {
    color: var(--primary-color);
    font-size: 18px;
}

.directory-search {
    position: relative;
    display: flex;
    align-items: center;
}

.directory-search i {
    position: absolute;
    left: 14px;
    color: var(--text-muted);
    font-size: 14px;
    z-index: 1;
}

.directory-search input {
    width: 100%;
    padding: 11px 14px 11px 40px;
    border: 2px solid var(--border-color);
    border-radius: 20px;
    font-size: 13px;
    outline: none;
    transition: all 0.3s ease;
    background: var(--bg-light);
    font-family: 'Inter', sans-serif;
}

.directory-search input:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(255, 71, 87, 0.1);
    background: white;
}

.users-list {
    flex: 1;
    overflow-y: auto;
    padding: 12px;
    background: var(--bg-light);
}

.users-list::-webkit-scrollbar {
    width: 6px;
}

.users-list::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 10px;
}

.user-list-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: white;
    border-radius: 10px;
    margin-bottom: 10px;
    border: 2px solid transparent;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
}

.user-list-item:hover {
    border-color: var(--primary-color);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(255, 71, 87, 0.15);
}

.user-list-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--bg-light);
    flex-shrink: 0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.user-list-info {
    flex: 1;
    min-width: 0;
    overflow: hidden;
}

.user-list-name {
    font-size: 14px;
    font-weight: 700;
    color: var(--text-dark);
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.user-list-level {
    font-size: 11px;
    color: var(--text-muted);
    background: var(--bg-light);
    padding: 2px 8px;
    border-radius: 10px;
    display: inline-block;
    margin-bottom: 4px;
    font-weight: 600;
}

.user-list-lesson {
    font-size: 12px;
    color: var(--primary-color);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 5px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.user-list-lesson i {
    font-size: 11px;
    flex-shrink: 0;
}


/* ==================== DETALLE DE USUARIO (MEJORADO) ==================== */
.user-detail-view {
    display: flex;
    flex-direction: column;
    height: 100%;
    background: var(--bg-light);
}

.detail-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 15px 20px;
    background: white;
    border-bottom: 1px solid var(--border-color);
    flex-shrink: 0;
}

.back-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: none;
    background: var(--bg-light);
    color: var(--text-dark);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    flex-shrink: 0;
}

.back-btn:hover {
    background: var(--primary-color);
    color: white;
    transform: scale(1.05);
}

.detail-header h3 {
    font-size: 16px;
    font-weight: 800;
    color: var(--text-dark);
}

.user-detail-card {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.detail-user-info {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 20px;
    background: white;
    border-bottom: 1px solid var(--border-color);
    flex-shrink: 0;
}

.detail-avatar {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid var(--primary-color);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    flex-shrink: 0;
}

.detail-user-text {
    flex: 1;
    min-width: 0;
}

.detail-user-text h2 {
    font-size: 18px;
    font-weight: 800;
    color: var(--text-dark);
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.detail-user-text p {
    font-size: 12px;
    color: var(--text-muted);
    margin-bottom: 3px;
}

.detail-user-text p i {
    color: var(--primary-color);
    margin-right: 4px;
}

.detail-tabs {
    display: flex;
    background: white;
    border-bottom: 2px solid var(--border-color);
    padding: 0 10px;
    flex-shrink: 0;
}

.detail-tab-btn {
    flex: 1;
    padding: 12px 8px;
    border: none;
    background: transparent;
    color: var(--text-muted);
    font-weight: 600;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
    border-bottom: 3px solid transparent;
}

.detail-tab-btn i {
    font-size: 16px;
}

.detail-tab-btn:hover {
    color: var(--text-dark);
    background: rgba(255, 71, 87, 0.05);
}

.detail-tab-btn.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
}

.detail-tab-content {
    display: none;
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    background: var(--bg-light);
}

.detail-tab-content.active {
    display: block;
}

.detail-tab-content::-webkit-scrollbar {
    width: 6px;
}

.detail-tab-content::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 10px;
}

/* Info Tab - Ajustado */
.info-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px;
}

.info-item {
    background: white;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.info-label {
    font-size: 10px;
    font-weight: 700;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 5px;
}

.info-value {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-dark);
}

/* Stats Tab - Ajustado */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-bottom: 15px;
}

.stat-card {
    background: white;
    padding: 15px;
    border-radius: 10px;
    border: 1px solid var(--border-color);
    text-align: center;
}

.stat-icon {
    width: 40px;
    height: 40px;
    margin: 0 auto 10px;
    background: var(--bg-light);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    color: var(--primary-color);
}

.stat-value {
    font-size: 22px;
    font-weight: 800;
    color: var(--text-dark);
    margin-bottom: 4px;
}

.stat-label {
    font-size: 11px;
    color: var(--text-muted);
    font-weight: 600;
}

/* Tasks Tab - Mejorado */
.tasks-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.task-item {
    background: white;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    gap: 10px;
    transition: all 0.3s ease;
}

.task-item:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    border-color: var(--primary-color);
}



.task-checkbox {
    width: 22px;
    height: 22px;
    border: 2px solid var(--border-color);
    border-radius: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    flex-shrink: 0;
}

.task-checkbox.completed {
    background: var(--secondary-color);
    border-color: var(--secondary-color);
    color: white;
}

.task-info {
    flex: 1;
    min-width: 0;
}

.task-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 3px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.task-type {
    font-size: 10px;
    color: var(--text-muted);
    text-transform: uppercase;
    font-weight: 600;
    letter-spacing: 0.3px;
}

.task-audio-btn {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: none;
    background: var(--primary-color);
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    flex-shrink: 0;
}

.task-audio-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(255, 71, 87, 0.3);
}

/* ==================== REPRODUCTOR DE AUDIO EN TAREAS ==================== */
.task-item.has-audio {
    flex-direction: column;
    align-items: stretch;
}

.task-main-content {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
}

.audio-player-container {
    width: 100%;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border-color);
    display: none;
}

.audio-player-container.active {
    display: block;
}

.audio-player-controls {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}

.audio-play-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: none;
    background: var(--primary-color);
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    transition: all 0.3s ease;
    flex-shrink: 0;
}

.audio-play-btn:hover {
    transform: scale(1.08);
    box-shadow: 0 4px 12px rgba(255, 71, 87, 0.3);
}

.audio-play-btn:disabled {
    background: var(--text-muted);
    cursor: not-allowed;
    opacity: 0.5;
}

.audio-time-display {
    font-size: 11px;
    font-weight: 600;
    color: var(--text-muted);
    min-width: 90px;
    font-variant-numeric: tabular-nums;
}

.audio-speed-selector {
    margin-left: auto;
    position: relative;
}

.audio-speed-btn {
    padding: 6px 12px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background: white;
    color: var(--text-dark);
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.audio-speed-btn:hover {
    border-color: var(--primary-color);
    color: var(--primary-color);
}

.audio-speed-menu {
    position: absolute;
    bottom: calc(100% + 5px);
    right: 0;
    background: white;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    padding: 5px;
    display: none;
    z-index: 100;
    min-width: 80px;
}

.audio-speed-menu.active {
    display: block;
}

.audio-speed-option {
    padding: 8px 12px;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-dark);
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.2s ease;
    text-align: center;
}

.audio-speed-option:hover {
    background: var(--bg-light);
}

.audio-speed-option.active {
    background: var(--primary-color);
    color: white;
}

.audio-progress-container {
    width: 100%;
    height: 6px;
    background: var(--border-color);
    border-radius: 3px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.audio-progress-bar {
    height: 100%;
    background: var(--primary-color);
    border-radius: 3px;
    width: 0%;
    transition: width 0.1s linear;
    position: relative;
}

.audio-progress-bar::after {
    content: '';
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 12px;
    height: 12px;
    background: var(--primary-color);
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.audio-progress-container:hover .audio-progress-bar::after {
    width: 14px;
    height: 14px;
}

.task-audio-status {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    color: var(--text-muted);
    font-weight: 600;
    margin-top: 8px;
}

.task-audio-status i {
    color: var(--secondary-color);
}

.task-no-audio {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 8px;
    font-style: italic;
}

.task-no-audio i {
    color: var(--primary-color);
}

.task-audio-toggle {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: none;
    background: var(--primary-color);
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    flex-shrink: 0;
}

.task-audio-toggle:hover {
    transform: scale(1.08);
    box-shadow: 0 4px 12px rgba(255, 71, 87, 0.3);
}

.task-audio-toggle.no-audio {
    background: var(--text-muted);
    cursor: not-allowed;
    opacity: 0.5;
}

#detailMessagesTab {
    /* Elimina display: flex; de aquí */
    display: none; /* Opcional: asegura que esté oculto por defecto */
    flex-direction: column;
    padding: 0;
}

#detailMessagesTab.active {
    display: flex;
}

#detailMessagesTab .chat-messages {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
}

#detailMessagesTab .chat-input-container {
    border-top: 1px solid var(--border-color);
    background: white;
}


/* ==================== MINI CHAT EN MODAL ==================== */
.modal-mini-chat {
    position: absolute;
    bottom: 80px;
    right: 20px;
    width: 300px;
    height: 400px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
    display: none;
    flex-direction: column;
    z-index: 150;
    overflow: hidden;
    border: 2px solid var(--primary-color);
}

.modal-mini-chat.active {
    display: flex;
    animation: slideUpChat 0.3s ease;
}

@keyframes slideUpChat {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.mini-chat-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, #ff6b81 100%);
    color: white;
    padding: 12px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
}

.mini-chat-header h4 {
    font-size: 14px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 8px;
}

.mini-chat-close {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.mini-chat-close:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
}

.mini-chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    background: var(--bg-light);
}

.mini-chat-messages::-webkit-scrollbar {
    width: 4px;
}

.mini-chat-messages::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 10px;
}

.mini-chat-input-container {
    padding: 12px;
    background: white;
    border-top: 1px solid var(--border-color);
    display: flex;
    gap: 8px;
}

.mini-chat-input-container input {
    flex: 1;
    padding: 10px 12px;
    border: 2px solid var(--border-color);
    border-radius: 20px;
    font-size: 13px;
    outline: none;
    transition: all 0.3s ease;
}

.mini-chat-input-container input:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(255, 71, 87, 0.1);
}

.mini-chat-send {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: none;
    background: var(--secondary-color);
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    transition: all 0.2s ease;
}

.mini-chat-send:hover {
    background: #26d07c;
    transform: scale(1.05);
}

/* CHAT TAB */
.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    background: var(--bg-light);
}

.chat-messages::-webkit-scrollbar {
    width: 6px;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 10px;
}

.message {
    padding: 12px 16px;
    border-radius: 16px;
    max-width: 80%;
    word-break: break-word;
    font-size: 14px;
    line-height: 1.5;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.message.self {
    align-self: flex-end;
    background: var(--primary-color);
    color: white;
    border-bottom-right-radius: 4px;
}

.message.other {
    align-self: flex-start;
    background: white;
    color: var(--text-dark);
    border: 1px solid var(--border-color);
    border-bottom-left-radius: 4px;
}

.message-sender {
    font-size: 11px;
    font-weight: 700;
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.message.self .message-sender {
    opacity: 0.9;
}

.message.other .message-sender {
    color: var(--primary-color);
}

.chat-input-container {
    padding: 15px;
    background: white;
    border-top: 1px solid var(--border-color);
    display: flex;
    gap: 10px;
}

#chatInput {
    flex: 1;
    padding: 12px 16px;
    border: 2px solid var(--border-color);
    border-radius: 24px;
    font-size: 14px;
    outline: none;
    transition: all 0.3s ease;
    font-family: 'Inter', sans-serif;
}

#chatInput:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(255, 71, 87, 0.1);
}

#chatInput:disabled {
    background: var(--bg-light);
    cursor: not-allowed;
}

.send-button {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: none;
    background: var(--secondary-color);
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(46, 213, 115, 0.3);
}

.send-button:hover {
    background: #26d07c;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(46, 213, 115, 0.4);
}

.send-button:disabled {
    background: var(--text-muted);
    cursor: not-allowed;
    opacity: 0.5;
    transform: none;
    box-shadow: none;
}



.files-list {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    background: var(--bg-light);
}

.files-list::-webkit-scrollbar {
    width: 6px;
}

.files-list::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 10px;
}

.file-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: white;
    border-radius: 8px;
    margin-bottom: 10px;
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
}

.file-item:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transform: translateY(-2px);
}

.file-icon {
    width: 40px;
    height: 40px;
    background: var(--bg-light);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    color: var(--primary-color);
}

.file-info {
    flex: 1;
}

.file-name {
    font-weight: 600;
    font-size: 14px;
    color: var(--text-dark);
    margin-bottom: 4px;
}

.file-size {
    font-size: 12px;
    color: var(--text-muted);
}

.file-actions {
    display: flex;
    gap: 8px;
}

.file-action-btn {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    border: none;
    background: var(--bg-light);
    color: var(--text-dark);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.file-action-btn:hover {
    background: var(--primary-color);
    color: white;
}



/* ==================== TABS DE ARCHIVOS ==================== */
.files-tabs {
    display: flex;
    background: white;
    border-bottom: 2px solid var(--border-color);
    padding: 0 15px;
    flex-shrink: 0;
}

.files-tab-btn {
    flex: 1;
    padding: 15px 12px;
    border: none;
    background: transparent;
    color: var(--text-muted);
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    border-bottom: 3px solid transparent;
    position: relative;
}

.files-tab-btn:hover {
    color: var(--text-dark);
    background: rgba(255, 71, 87, 0.05);
}

.files-tab-btn.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
}

.files-count {
    background: var(--primary-color);
    color: white;
    font-size: 10px;
    font-weight: 700;
    padding: 2px 6px;
    border-radius: 10px;
    min-width: 18px;
    text-align: center;
}

.files-tab-container {
    display: none;
    flex: 1;
    overflow: hidden;
    position: relative;
}

.files-tab-container.active {
    display: flex;
    flex-direction: column;
}

/* ==================== ARCHIVOS SUBIDOS ==================== */
.uploaded-files-view {
    display: flex;
    flex-direction: column;
    height: 100%;
    background: var(--bg-light);
}

.uploaded-header {
    padding: 20px;
    background: white;
    border-bottom: 2px solid var(--border-color);
    flex-shrink: 0;
}

.uploaded-header h3 {
    font-size: 16px;
    font-weight: 800;
    color: var(--text-dark);
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
}

.uploaded-header h3 i {
    color: var(--primary-color);
}

.uploaded-subtitle {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 4px;
}

.uploaded-files-list {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
}

.uploaded-files-list::-webkit-scrollbar {
    width: 6px;
}

.uploaded-files-list::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 10px;
}

.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 20px;
    text-align: center;
    color: var(--text-muted);
}

.empty-state i {
    font-size: 64px;
    margin-bottom: 20px;
    opacity: 0.3;
}

.empty-state p {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text-dark);
}

.empty-state small {
    font-size: 13px;
}

.uploaded-file-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: white;
    border-radius: 10px;
    margin-bottom: 10px;
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
}

.uploaded-file-item:hover {
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    transform: translateY(-2px);
    border-color: var(--primary-color);
}

.uploaded-file-icon {
    width: 45px;
    height: 45px;
    background: var(--bg-light);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: var(--primary-color);
    flex-shrink: 0;
}

.uploaded-file-info {
    flex: 1;
    min-width: 0;
}

.uploaded-file-name {
    font-weight: 600;
    font-size: 13px;
    color: var(--text-dark);
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.uploaded-file-size {
    font-size: 11px;
    color: var(--text-muted);
}

.uploaded-file-actions {
    display: flex;
    gap: 6px;
}

.uploaded-file-action-btn {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    border: none;
    background: var(--bg-light);
    color: var(--text-dark);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    font-size: 13px;
}

.uploaded-file-action-btn:hover {
    background: var(--primary-color);
    color: white;
    transform: scale(1.05);
}

/* ==================== VISTA DE CATEGORÍAS ==================== */
.files-categories-view {
    display: none;
    flex-direction: column;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--bg-light);
}

.files-categories-view.active {
    display: flex;
}

.categories-header {
    padding: 20px;
    background: white;
    border-bottom: 2px solid var(--border-color);
    flex-shrink: 0;
}

.categories-header h3 {
    font-size: 16px;
    font-weight: 800;
    color: var(--text-dark);
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
}

.categories-header h3 i {
    color: var(--primary-color);
}

.categories-subtitle {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 4px;
}

.categories-grid {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    background: var(--bg-light);
    display: grid;
    grid-template-columns: 1fr;
    gap: 12px;
    align-content: start;
}

.categories-grid::-webkit-scrollbar {
    width: 6px;
}

.categories-grid::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 10px;
}

.category-card {
    background: white;
    padding: 16px;
    border-radius: 12px;
    border: 2px solid transparent;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    display: flex;
    align-items: center;
    gap: 15px;
}

.category-card:hover {
    border-color: var(--primary-color);
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
}

.category-icon-wrapper {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    color: white;
    flex-shrink: 0;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.category-info {
    flex: 1;
    min-width: 0;
}

.category-name {
    font-size: 14px;
    font-weight: 700;
    color: var(--text-dark);
    margin-bottom: 4px;
}

.category-description {
    font-size: 11px;
    color: var(--text-muted);
    line-height: 1.4;
}

.category-count {
    background: var(--bg-light);
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 700;
    color: var(--text-dark);
    flex-shrink: 0;
}

/* ==================== VISTA DE ARCHIVOS DE CATEGORÍA ==================== */
.category-files-view {
    display: none;
    flex-direction: column;
    height: 100%;
}

.category-files-view.active {
    display: flex;
}

.category-files-header {
    padding: 15px 20px;
    background: white;
    border-bottom: 2px solid var(--border-color);
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
}

.category-back-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: none;
    background: var(--bg-light);
    color: var(--text-dark);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    flex-shrink: 0;
}

.category-back-btn:hover {
    background: var(--primary-color);
    color: white;
    transform: scale(1.05);
}

.category-files-title {
    flex: 1;
}

.category-files-title h3 {
    font-size: 16px;
    font-weight: 800;
    color: var(--text-dark);
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 2px;
}

.category-files-title p {
    font-size: 11px;
    color: var(--text-muted);
}

.category-files-list {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    background: var(--bg-light);
}

.category-files-list::-webkit-scrollbar {
    width: 6px;
}

.category-files-list::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 10px;
}

.category-file-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: white;
    border-radius: 10px;
    margin-bottom: 10px;
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
}

.category-file-item:hover {
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    transform: translateY(-2px);
    border-color: var(--primary-color);
}

.category-file-icon {
    width: 45px;
    height: 45px;
    background: var(--bg-light);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: var(--primary-color);
    flex-shrink: 0;
}

.category-file-info {
    flex: 1;
    min-width: 0;
}

.category-file-name {
    font-weight: 600;
    font-size: 13px;
    color: var(--text-dark);
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.category-file-size {
    font-size: 11px;
    color: var(--text-muted);
}

.category-file-actions {
    display: flex;
    gap: 6px;
}

.category-file-action-btn {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    border: none;
    background: var(--bg-light);
    color: var(--text-dark);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    font-size: 13px;
}

.category-file-action-btn:hover {
    background: var(--primary-color);
    color: white;
    transform: scale(1.05);
}

/* ==================== ZONA DE SUBIDA (Mejorada) ==================== */
.files-upload-zone {
    padding: 15px 20px;
    background: white;
    border-bottom: 1px solid var(--border-color);
    flex-shrink: 0;
}

.upload-btn {
    width: 100%;
    padding: 12px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.3s ease;
}

.upload-btn:hover {
    background: #ff3344;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 71, 87, 0.3);
}

/* ==================== TOOLTIP ==================== */
.tooltip {
    position: absolute;
    bottom: calc(100% + 8px);
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.85);
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 11px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
    z-index: 1000;
    font-weight: 600;
}

.tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 5px solid transparent;
    border-top-color: rgba(0, 0, 0, 0.85);
}

.student-action-btn:hover .tooltip {
    opacity: 1;
}


@media (max-width: 768px) {
    .main-layout {
        grid-template-columns: 1fr;
    }

    .right-sidebar {
        display: none;
    }

    .students-grid {
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    }

}

/* ==================== MODAL DRAGGABLE ==================== */
/* ==================== MODAL DRAGGABLE (MÚLTIPLES) ==================== */
.pdf-modal {
    position: fixed;
    top: 10%;
    left: 10%;
    width: 490px;
    height: 610px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    display: none;
    flex-direction: column;
    z-index: 2000; /* Se incrementará dinámicamente */
    overflow: hidden;
    border: 2px solid var(--border-color);
}

.pdf-modal.active {
    display: flex;
}

/* Clase para el modal que está al frente */
.pdf-modal.focused {
    z-index: 3000;
    box-shadow: 0 25px 70px rgba(0,0,0,0.4);
    border-color: var(--primary-color);
}

/* Header cambia cuando está enfocado */
.pdf-modal.focused .pdf-modal-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, #ff3344 100%);
}

.pdf-modal-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, #ff6b81 100%);
    color: white;
    padding: 12px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: move;
    user-select: none;
}

.pdf-modal-header h4 {
    font-size: 15px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 0;
    
    /* --- NUEVAS PROPIEDADES PARA ACORTAR TEXTO --- */
    flex: 1;                /* Ocupa el espacio disponible */
    min-width: 0;           /* Truco vital para que flexbox permita acortar */
    white-space: nowrap;    /* No permitir saltos de línea */
    overflow: hidden;       /* Ocultar lo que sobra */
    text-overflow: ellipsis;/* Poner '...' al final */
    margin-right: 10px;     /* Espacio de seguridad con el botón X */
}

.pdf-modal-close {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.pdf-modal-close:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
}

.pdf-modal-body {
    flex: 1;
    background: #eee;
    overflow: hidden;
    position: relative;
    display: flex;
    flex-direction: column;
}

.pdf-modal-body iframe {
    width: 100%;
    height: 100%;
    border: none;
    display: none; /* Oculto por defecto, se muestra solo para imágenes/otros */
}

.pdf-viewer-container {
    flex: 1;
    display: none; /* Se muestra solo para PDFs */
    flex-direction: column;
    background: #525659;
    overflow: hidden;
}

.pdf-viewer-container.active {
    display: flex;
}

.pdf-toolbar {
    background: #2d2d2d;
    padding: 10px 15px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    border-bottom: 1px solid #444;
    flex-shrink: 0;
}

.pdf-toolbar-left,
.pdf-toolbar-center,
.pdf-toolbar-right {
    display: flex;
    align-items: center;
    gap: 8px;
}

.pdf-toolbar-center {
    flex: 1;
    justify-content: center;
}

.pdf-tool-btn {
    width: 32px;
    height: 32px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    transition: all 0.2s ease;
}

.pdf-tool-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.pdf-tool-btn.active {
    background: var(--primary-color);
    border-color: var(--primary-color);
    box-shadow: 0 0 10px rgba(255, 71, 87, 0.5);
}

.pdf-tool-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
}

.pdf-page-info {
    color: white;
    font-size: 13px;
    font-weight: 600;
    padding: 0 10px;
    white-space: nowrap;
}

.pdf-zoom-control {
    display: flex;
    align-items: center;
    gap: 8px;
}

.pdf-zoom-display {
    color: white;
    font-size: 12px;
    font-weight: 600;
    min-width: 50px;
    text-align: center;
}

.color-picker-btn {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    border: 2px solid white;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.color-picker-input {
    position: absolute;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
}

.pdf-canvas {
    display: block;
    cursor: crosshair;
}

.annotation-canvas {
    position: absolute;
    top: 0;
    left: 0;
    cursor: crosshair;
}

.modal-iframe {
    width: 100%;
    height: 100%;
    border: none;
    display: none;
}

.pdf-canvas-container {
    flex: 1;
    overflow: auto;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 20px;
    position: relative;
}

.pdf-canvas-wrapper {
    position: relative;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    background: white;
}

#pdfCanvas {
    display: block;
    cursor: crosshair;
}

#annotationCanvas {
    position: absolute;
    top: 0;
    left: 0;
    cursor: crosshair;
}

.annotation-cursor-pen {
    cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><circle cx="10" cy="10" r="2" fill="black"/></svg>') 10 10, crosshair;
}

.annotation-cursor-eraser {
    cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><rect x="5" y="5" width="10" height="10" fill="white" stroke="black"/></svg>') 10 10, crosshair;
}

/* Overlay oscuro cuando hay modal */
.modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1999;
    display: none;
}

.modal-backdrop.active {
    display: block;
}



/* ==================== BARRA DE ESTADO DE COMPARTIR ==================== */
.modal-sharing-status {
    width: 100%;
    background: #2d2d2d;
    border-bottom: 1px solid #444;
    padding: 8px 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all 0.3s ease;
}

.sharing-status-content {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    font-weight: 600;
    color: #999;
    transition: all 0.3s ease;
}

.modal-sharing-status i {
    font-size: 13px;
    transition: all 0.3s ease;
}

/* Estado: Compartiendo */
.modal-sharing-status.active {
    background: linear-gradient(135deg, rgba(46, 213, 115, 0.15) 0%, rgba(46, 213, 115, 0.25) 100%);
    border-bottom: 2px solid var(--secondary-color);
}

.modal-sharing-status.active .sharing-status-content {
    color: var(--secondary-color);
}

.modal-sharing-status.active i {
    animation: pulse-sharing 2s infinite;
}

@keyframes pulse-sharing {
    0%, 100% { 
        opacity: 1; 
        transform: scale(1);
    }
    50% { 
        opacity: 0.6;
        transform: scale(1.1);
    }
}

/* Botón para detener compartir */
.sharing-stop-btn {
    margin-left: 12px;
    padding: 4px 12px;
    background: rgba(255, 71, 87, 0.2);
    border: 1px solid var(--primary-color);
    color: var(--primary-color);
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 6px;
}

.sharing-stop-btn:hover {
    background: var(--primary-color);
    color: white;
    transform: scale(1.05);
}

.sharing-stop-btn i {
    font-size: 10px;
    animation: none !important;
}

/* Lista de espectadores (si hay múltiples) */
.sharing-viewers-list {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: 15px;
    padding-left: 15px;
    border-left: 1px solid rgba(46, 213, 115, 0.3);
}

.viewer-badge {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    background: rgba(46, 213, 115, 0.1);
    border: 1px solid rgba(46, 213, 115, 0.3);
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    color: var(--secondary-color);
}

.viewer-badge i {
    font-size: 10px;
}


/* ==================== CONTROLES DE MEDIOS EN MODAL ==================== */
.modal-media-controls {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 15px;
    padding: 12px 20px;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(10px);
    border-radius: 50px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    z-index: 100;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}

.media-control-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
 background: #6c757d;
    transition: all 0.3s ease;
    color: white;
    position: relative;
    overflow: hidden;
}

.media-control-btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: #5a6268;
    transform: translate(-50%, -50%);
    transition: width 0.3s ease, height 0.3s ease;
}

.media-control-btn:hover::before {
    width: 100%;
    height: 100%;
}

.media-control-btn i {
    position: relative;
    z-index: 1;
}

/* Nuevo estilo para el botón de conectar */
.btn-connect-primary {
    background: linear-gradient(135deg, var(--primary-color) 0%, #ff6b81 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 25px; /* Bordes muy redondeados */
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%; /* Que ocupe todo el ancho de la tarjeta */
    transition: all 0.3s ease;
    box-shadow: 0 4px 10px rgba(255, 71, 87, 0.3);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.btn-connect-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(255, 71, 87, 0.4);
    filter: brightness(1.1);
}

.btn-connect-primary:disabled {
    opacity: 0.7;
    cursor: wait;
    transform: none;
    box-shadow: none;
    background: #a4b0be; /* Gris mientras carga o mantén el gradiente si prefieres */
}

/* Animación para el icono de carga */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.fa-spinner-animate {
    animation: spin 1s linear infinite;
}

/* Botón de micrófono */
.btn-microphone {
    background: var(--secondary-color);
}

.btn-microphone.active {
    background: var(--primary-color);
    animation: pulse-mic 1.5s infinite;
}

.btn-microphone:hover {
    background: #26d07c;
    transform: scale(1.1);
}

/* Botón de cámara */
.btn-camera {
    background: #5c80bc;
}

.btn-camera.active {
    background: var(--primary-color);
    animation: pulse-cam 1.5s infinite;
}

.btn-camera:hover {
    background: #4a6a9f;
    transform: scale(1.1);
}

/* Botón de compartir pantalla */
.btn-screen-share {
    background: #6c5ce7;
}

.btn-screen-share.active {
    background: var(--primary-color);
    box-shadow: 0 0 20px rgba(255, 71, 87, 0.5);
}

.btn-screen-share:hover {
    background: #5b4bc4;
    transform: scale(1.1);
}

.btn-chat-modal {
    background: #ff9800;
}

.btn-chat-modal:hover {
    background: #f57c00;
    transform: scale(1.1);
}

.btn-midi-share {
    background: #6c5ce7;
}

.btn-midi-share.active {
    background: var(--primary-color);
    box-shadow: 0 0 20px rgba(255, 71, 87, 0.5);
    animation: pulse-midi 1.5s infinite;
}

@keyframes pulse-midi {
    0%, 100% { box-shadow: 0 0 0 0 rgba(108, 92, 231, 0.7); }
    50% { box-shadow: 0 0 0 10px rgba(108, 92, 231, 0); }
}

@keyframes pulse-mic {
    0%, 100% { box-shadow: 0 0 0 0 rgba(46, 213, 115, 0.7); }
    50% { box-shadow: 0 0 0 10px rgba(46, 213, 115, 0); }
}

@keyframes pulse-cam {
    0%, 100% { box-shadow: 0 0 0 0 rgba(92, 128, 188, 0.7); }
    50% { box-shadow: 0 0 0 10px rgba(92, 128, 188, 0); }
}

/* ==================== PIP VIDEO (CÁMARA DEL USUARIO) ==================== */
.modal-pip-video {
    position: absolute;
    top: 60px;
    right: 20px;
    width: 180px;
    height: 135px;
    background: rgba(0, 0, 0, 0.8);
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    overflow: hidden;
    z-index: 99;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    transition: all 0.3s ease;
    display: none; /* Oculto por defecto */
}

.modal-pip-video.active {
    display: block;
}

.modal-pip-video:hover {
    transform: scale(1.05);
    border-color: var(--primary-color);
    box-shadow: 0 12px 35px rgba(0, 0, 0, 0.5);
}

.modal-pip-video video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
}

.pip-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 14px;
    text-align: center;
    padding: 10px;
}

.pip-placeholder i {
    font-size: 32px;
    margin-bottom: 8px;
    opacity: 0.5;
}

.pip-status {
    position: absolute;
    bottom: 8px;
    left: 8px;
    background: rgba(0, 0, 0, 0.7);
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    color: white;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 6px;
}

.pip-status i {
    font-size: 8px;
    color: var(--secondary-color);
}

/* Indicador de audio activo */
.audio-indicator {
    position: absolute;
    top: 8px;
    left: 8px;
    width: 30px;
    height: 30px;
    background: rgba(46, 213, 115, 0.9);
    border-radius: 50%;
    display: none;
    align-items: center;
    justify-content: center;
    animation: pulse-audio 1s infinite;
}

.audio-indicator.active {
    display: flex;
}

.audio-indicator i {
    color: white;
    font-size: 14px;
}

@keyframes pulse-audio {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.8; }
}


@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
}

@keyframes slideUp {
    from {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
    to {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
    }
}

</style>
<body>
    <div class="professor-container">
        
        <!-- HEADER -->
        <header class="professor-header">
            <div class="header-content">
                <h1>
                    <i class="fas fa-chalkboard-teacher"></i> 
                   Mozart Academy
                </h1>
                <div class="midi-status-header">
                <button onclick="manualCleanupGhosts()" 
                style="padding: 6px 12px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 6px; cursor: pointer; font-size: 12px; margin-right: 10px;">
            <i class="fas fa-broom"></i> Limpiar Fantasmas
        </button>
                    <span id="midiHeaderStatus" class="midi-indicator">
                        <i class="fas fa-circle"></i> Sin piano MIDI
                    </span>
                </div>
            </div>
        </header>

        <!-- MAIN LAYOUT -->
        <div class="main-layout">
            
            <!-- MAIN CENTER: STUDENTS + PIANO -->
            <main class="main-center">
                
                <!-- STUDENTS SECTION -->
                <section class="students-section">
                    <div class="section-header">
                        <h2>
                            <i class="fas fa-users"></i> 
                            Alumnos Conectados
                        </h2>
                        <div class="student-info-badge" id="selectedStudentInfo">
                            <i class="fas fa-info-circle"></i>
                            <span>Selecciona un alumno para iniciar</span>
                        </div>
                    </div>
                    
                    <div id="studentsContainer" class="students-grid">
                        <!-- Los estudiantes se cargarán dinámicamente aquí -->
                    </div>
                </section>

                <!-- PIANO SECTION -->
              <section class="piano-section">
    <div class="piano-header-bar">
        <h3><i class="fas fa-piano"></i> Piano Virtual</h3>
        <div class="piano-controls">
            <span id="transmissionStatus" class="transmission-badge">
                Transmisión inactiva
            </span>
        </div>
    </div>

    <div class="piano-wrapper">
        <div id="piano-top-casing"></div>
        <div id="piano-container">
            <div id="piano-keys"></div>
        </div>
    </div>
</section>
                
            </main>
            <aside class="right-sidebar">
                <div class="sidebar-tabs">
                    <button class="tab-btn active" data-tab="chat">
                        <i class="fas fa-users"></i> Alumnos
                    </button>
                    <button class="tab-btn" data-tab="files">
                        <i class="fas fa-folder"></i> Archivos
                    </button>
                </div>


<div class="tab-content active" id="chatTab">
    <div class="users-directory-view" id="usersDirectoryView">
        <div class="directory-header">
            <h3>
                Directorio de Alumnos
            </h3>
            <div class="directory-search">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Buscar alumno..." id="directorySearch">
            </div>
        </div>
        <div class="users-list" id="usersList">
            <!-- Los usuarios se cargarán aquí -->
        </div>
    </div>

    <!-- Vista Detalle de Usuario -->
    <div class="user-detail-view" id="userDetailView" style="display: none;">
        <div class="detail-header">
            <button class="back-btn" onclick="backToDirectory()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h3>Perfil del Alumno</h3>
        </div>

        <div class="user-detail-card">
            <div class="detail-user-info">
                <img id="detailAvatar" class="detail-avatar" src="" alt="">
                <div class="detail-user-text">
                    <h2 id="detailName"></h2>
                    <p id="detailLevel"></p>
                    <p id="detailLesson"><i class="fas fa-book-open"></i> <span></span></p>
                </div>
            </div>

            <!-- Tabs del detalle -->
            <div class="detail-tabs">
                <button class="detail-tab-btn active" data-detail-tab="info">
                    <i class="fas fa-info-circle"></i> Info
                </button>
                <button class="detail-tab-btn" data-detail-tab="stats">
                    <i class="fas fa-chart-line"></i> Estadísticas
                </button>
                <button class="detail-tab-btn" data-detail-tab="tasks">
                    <i class="fas fa-tasks"></i> Tareas
                </button>
                <button class="detail-tab-btn" data-detail-tab="messages">
                    <i class="fas fa-comments"></i> Mensajes
                </button>
            </div>

            <!-- Contenido de tabs -->
            <div class="detail-tab-content active" id="detailInfoTab">
                <!-- Información General -->
            </div>

            <div class="detail-tab-content" id="detailStatsTab">
                <!-- Estadísticas -->
            </div>

            <div class="detail-tab-content" id="detailTasksTab">
                <!-- Tareas -->
            </div>

            <div class="detail-tab-content" id="detailMessagesTab">
                <!-- Chat con el usuario -->
                <div class="chat-messages" id="userChatLog"></div>
              
            </div>
        </div>
    </div>
</div>

   

  <div class="tab-content" id="filesTab">
    <!-- Zona de subida (siempre visible) -->
    <div class="files-upload-zone">
        <input type="file" id="fileInput" style="display: none;" multiple>
        <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
            <i class="fas fa-cloud-upload-alt"></i>
            Subir Nuevo Archivo
        </button>
    </div>
    
    <!-- Tabs para Categorías vs Mis Archivos -->
    <div class="files-tabs">
        <button class="files-tab-btn active" data-files-tab="categories">
            <i class="fas fa-folder-open"></i>
            Biblioteca
        </button>
        <button class="files-tab-btn" data-files-tab="uploaded">
            <i class="fas fa-cloud-upload-alt"></i>
            Mis Archivos
            <span class="files-count" id="uploadedFilesCount" style="display: none;">0</span>
        </button>
    </div>
    
    <!-- ✅ CONTENEDOR DE CATEGORÍAS -->
    <div class="files-tab-container active" id="categoriesContainer">
        <!-- Vista de Lista de Categorías -->
        <div class="files-categories-view active" id="categoriesView">
            <div class="categories-header">
                <h3>
                    <i class="fas fa-folder-open"></i>
                    Biblioteca de Piano
                </h3>
                <p class="categories-subtitle">Explora recursos organizados por categoría</p>
            </div>
            <div class="categories-grid" id="categoriesGrid">
                <!-- Las categorías se cargarán aquí -->
            </div>
        </div>
        
        <!-- Vista de Archivos de una Categoría -->
        <div class="category-files-view" id="categoryFilesView">
            <div class="category-files-header">
                <button class="category-back-btn" onclick="backToCategories()">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="category-files-title">
                    <h3 id="categoryTitle">
                        <i class="fas fa-music"></i>
                        <span></span>
                    </h3>
                    <p id="categoryFileCount"></p>
                </div>
            </div>
            <div class="category-files-list" id="categoryFilesList">
                <!-- Los archivos de la categoría se cargarán aquí -->
            </div>
        </div>
    </div>
    
    <!-- ✅ CONTENEDOR DE ARCHIVOS SUBIDOS -->
    <div class="files-tab-container" id="uploadedContainer">
        <div class="uploaded-files-view">
            <div class="uploaded-header">
                <h3>
                    <i class="fas fa-cloud-upload-alt"></i>
                    Mis Archivos Subidos
                </h3>
                <p class="uploaded-subtitle">Archivos que has subido a la plataforma</p>
            </div>
            <div class="uploaded-files-list" id="uploadedFilesList">
                <div class="empty-state">
                    <i class="fas fa-folder-open"></i>
                    <p>No has subido ningún archivo</p>
                    <small>Usa el botón "Subir Nuevo Archivo" para comenzar</small>
                </div>
            </div>
        </div>
    </div>
</div>




            </aside>
        </div>
    <div class="modal-backdrop" id="modalBackdrop"></div>

  




    </div>

    <script >
        // ==================== CONFIGURACIÓN FIREBASE ====================
const fb_config = {
    apiKey: "AIzaSyCiYZ-_3zXQCu6DIkOd_HRGLCS3s6bIYiE",
    authDomain: "jcubic-webrtc.firebaseapp.com",
    databaseURL: "https://jcubic-webrtc.firebaseio.com",
    projectId: "jcubic-webrtc",
    storageBucket: "jcubic-webrtc.appspot.com",
    messagingSenderId: "530153588319"
};
firebase.initializeApp(fb_config);

const db = firebase.database();
const room = "piano-class";
const usersRef = db.ref(`${room}/users`);
const signalsRef = db.ref(`${room}/signals`);
const chatsRef = db.ref(`${room}/chats`);

// ==================== VARIABLES GLOBALES ====================
let myId = "profesor-" + Math.floor(Math.random() * 10000);
let myName = "Profesor";
let localStream = null;
let peers = {};
let selectedStudent = null;
let connectedStudents = {};
let studentConnections = {};

// Variables MIDI
let midiAccess = null;
let midiInput = null;
let midiTransmissionEnabled = false;
let activeMidiStudent = null;

// Variables Piano Visual
let sampler = null;
let activeNotes = {};

let individualAudioStreams = {};
let individualScreenStreams = {};


let pdfDoc = null;
let currentPageNum = 1;
let totalPagesNum = 0;
let pdfScale = 0.75;
let currentTool = 'pen';
let currentColor = '#FF4757';
let isDrawing = false;
let lastX = 0;
let lastY = 0;
let annotations = {}; 

let openModals = {}; // { modalId: { element, pdfDoc, annotations, etc. } }
let modalCounter = 0;
let highestZIndex = 2000;


const keyMap = {
    'a': 'C4', 'w': 'Db4', 's': 'D4', 'e': 'Eb4', 'd': 'E4', 'f': 'F4', 't': 'Gb4',
    'g': 'G4', 'y': 'Ab4', 'h': 'A4', 'u': 'Bb4', 'j': 'B4', 'k': 'C5', 'o': 'Db5',
    'l': 'D5', 'p': 'Eb5', ';': 'E5'
};


// ==================== CATEGORÍAS Y ARCHIVOS ====================
const fileCategories = [
    {
        id: 'partituras',
        name: 'Partituras',
        icon: 'fas fa-music',
        color: '#FF4757',
        description: 'Partituras y obras musicales',
        files: [
            { 
                name: "Nocturno Op.9 No.2 - Chopin.pdf", 
                type: "application/pdf", 
                size: 1250000,
                url: "https://storage.googleapis.com/mozartacademy-files/pdf/Level1%20-%20Unit1.pdf"
            },
            { 
                name: "Für Elise - Beethoven.pdf", 
                type: "application/pdf", 
                size: 890000,
                url: "https://storage.googleapis.com/mozartacademy-files/pdf/Level1%20-%20Unit2.pdf"
            },
            { 
                name: "Claro de Luna - Debussy.pdf", 
                type: "application/pdf", 
                size: 1100000,
                url: "https://dashboard.mozartacademy.mx/media/Lectura%20de%20las%20Claves%20-%20Dandelot.pdf"
            }
        ]
    },
    {
        id: 'ejercicios',
        name: 'Ejercicios Técnicos',
        icon: 'fas fa-dumbbell',
        color: '#2ed573',
        description: 'Ejercicios de técnica y digitación',
        files: [
            { 
                name: "Hanon - El Pianista Virtuoso.pdf", 
                type: "application/pdf", 
                size: 2100000,
                url: "https://storage.googleapis.com/mozartacademy-files/pdf/Level1%20-%20Unit1.pdf"
            },
            { 
                name: "Czerny - Ejercicios Op.299.pdf", 
                type: "application/pdf", 
                size: 1800000,
                url: "https://storage.googleapis.com/mozartacademy-files/pdf/Level1%20-%20Unit2.pdf"
            },
            { 
                name: "Escalas y Arpegios.pdf", 
                type: "application/pdf", 
                size: 950000,
                url: "https://dashboard.mozartacademy.mx/media/Lectura%20de%20las%20Claves%20-%20Dandelot.pdf"
            }
        ]
    },
    {
        id: 'metodo',
        name: 'Métodos de Aprendizaje',
        icon: 'fas fa-book-open',
        color: '#5c80bc',
        description: 'Métodos progresivos para piano',
        files: [
            { 
                name: "Mikrokosmos Vol.1 - Bartok.pdf", 
                type: "application/pdf", 
                size: 1450000,
                url: "https://storage.googleapis.com/mozartacademy-files/pdf/Level1%20-%20Unit1.pdf"
            },
            { 
                name: "Método Suzuki - Piano Vol.1.pdf", 
                type: "application/pdf", 
                size: 1600000,
                url: "https://storage.googleapis.com/mozartacademy-files/pdf/Level1%20-%20Unit2.pdf"
            },
            { 
                name: "John Thompson - Curso Moderno.pdf", 
                type: "application/pdf", 
                size: 1300000,
                url: "https://dashboard.mozartacademy.mx/media/Lectura%20de%20las%20Claves%20-%20Dandelot.pdf"
            }
        ]
    },
    {
        id: 'teoria',
        name: 'Teoría Musical',
        icon: 'fas fa-graduation-cap',
        color: '#6c5ce7',
        description: 'Teoría, armonía y lectura musical',
        files: [
            { 
                name: "Lectura de las Claves - Dandelot.pdf", 
                type: "application/pdf", 
                size: 1200000,
                url: "https://dashboard.mozartacademy.mx/media/Lectura%20de%20las%20Claves%20-%20Dandelot.pdf"
            },
            { 
                name: "Armonía Básica - Teoría.pdf", 
                type: "application/pdf", 
                size: 980000,
                url: "https://storage.googleapis.com/mozartacademy-files/pdf/Level1%20-%20Unit1.pdf"
            },
            { 
                name: "Círculo de Quintas - Guía Visual.pdf", 
                type: "application/pdf", 
                size: 450000,
                url: "https://storage.googleapis.com/mozartacademy-files/pdf/Level1%20-%20Unit2.pdf"
            }
        ]
    },
    {
        id: 'recursos',
        name: 'Recursos Visuales',
        icon: 'fas fa-images',
        color: '#ff9800',
        description: 'Diagramas, acordes y referencias',
        files: [
            { 
                name: "Diagrama de Acordes Mayores.jpg", 
                type: "image/jpeg", 
                size: 320000,
                url: "https://i.pinimg.com/originals/3d/8f/3e/3d8f3e3e3f3e3f3e3f3e3f3e3f3e3f3e.jpg"
            },
            { 
                name: "Posiciones de Manos - Guía.jpg", 
                type: "image/jpeg", 
                size: 280000,
                url: "https://i.pinimg.com/originals/3d/8f/3e/3d8f3e3e3f3e3f3e3f3e3f3e3f3e3f3e.jpg"
            },
            { 
                name: "Tabla de Digitación.pdf", 
                type: "application/pdf", 
                size: 550000,
                url: "https://storage.googleapis.com/mozartacademy-files/pdf/Level1%20-%20Unit1.pdf"
            }
        ]
    },
    {
        id: 'jazz',
        name: 'Jazz y Improvisación',
        icon: 'fas fa-guitar',
        color: '#ff6b81',
        description: 'Recursos para jazz y improvisación',
        files: [
            { 
                name: "Progresiones de Jazz - Real Book.pdf", 
                type: "application/pdf", 
                size: 1900000,
                url: "https://storage.googleapis.com/mozartacademy-files/pdf/Level1%20-%20Unit1.pdf"
            },
            { 
                name: "Escalas para Improvisación.pdf", 
                type: "application/pdf", 
                size: 750000,
                url: "https://storage.googleapis.com/mozartacademy-files/pdf/Level1%20-%20Unit2.pdf"
            },
            { 
                name: "Voicings de Acordes - Jazz.pdf", 
                type: "application/pdf", 
                size: 890000,
                url: "https://dashboard.mozartacademy.mx/media/Lectura%20de%20las%20Claves%20-%20Dandelot.pdf"
            }
        ]
    }
];

// Variable para trackear la categoría seleccionada
let selectedCategory = null;

const fictitiousUsers = [
    {
        id: 'student-001',
        name: 'Ana García',
        level: 'Intermedio',
        lesson: 'Nocturno Op.9',
        avatar: 'https://ui-avatars.com/api/?name=Ana+Garcia&background=FF4757&color=fff&size=128',
        age: 24,
        email: 'ana.garcia@example.com',
        phone: '+52 55 1234 5678',
        startDate: '2024-01-15',
        hoursCompleted: 45,
        lessonsCompleted: 12,
        nextLesson: '2024-12-10',
        tasks: [
            { id: 1, title: 'Practicar escalas mayores', completed: true, type: 'practice' },
            { 
                id: 2, 
                title: 'Ejercicio rítmico - Compás 3/4', 
                completed: true, 
                type: 'audio', 
                audioUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3',
                duration: 180
            },
            { id: 3, title: 'Leer partitura Bartok', completed: true, type: 'reading' },
            { 
                id: 4, 
                title: 'Improvisación sobre Do Mayor', 
                completed: false, 
                type: 'audio', 
                audioUrl: '',
                duration: 0
            },
            { id: 5, title: 'Teoría: Círculo de quintas', completed: false, type: 'theory' }
        ],
        stats: {
            attendance: 95,
            practiceHours: 120,
            averageScore: 8.5,
            improvementRate: 15
        },
        messages: []
    },
    {
        id: 'student-002',
        name: 'Carlos Mendoza',
        level: 'Avanzado',
        lesson: 'Acordes 7ma',
        avatar: 'https://ui-avatars.com/api/?name=Carlos+Mendoza&background=2ed573&color=fff&size=128',
        age: 28,
        email: 'carlos.mendoza@example.com',
        phone: '+52 55 2345 6789',
        startDate: '2023-08-20',
        hoursCompleted: 120,
        lessonsCompleted: 35,
        nextLesson: '2024-12-08',
        tasks: [
            { id: 1, title: 'Composición original', completed: false, type: 'practice' },
            { 
                id: 2, 
                title: 'Improvisación Jazz - Take 1', 
                completed: true, 
                type: 'audio', 
                audioUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3',
                duration: 240
            },
            { id: 3, title: 'Analizar sonata Mozart', completed: false, type: 'reading' },
            { 
                id: 4, 
                title: 'Progresión ii-V-I en todas las tonalidades', 
                completed: true, 
                type: 'audio', 
                audioUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3',
                duration: 300
            }
        ],
        stats: {
            attendance: 88,
            practiceHours: 250,
            averageScore: 9.2,
            improvementRate: 22
        },
        messages: []
    },
    {
        id: 'student-003',
        name: 'Laura Sánchez',
        level: 'Principiante',
        lesson: 'Escalas Mayores',
        avatar: 'https://ui-avatars.com/api/?name=Laura+Sanchez&background=5c80bc&color=fff&size=128',
        age: 19,
        email: 'laura.sanchez@example.com',
        phone: '+52 55 3456 7890',
        startDate: '2024-09-01',
        hoursCompleted: 15,
        lessonsCompleted: 4,
        nextLesson: '2024-12-09',
        tasks: [
            { id: 1, title: 'Memorizar Do Mayor', completed: true, type: 'practice' },
            { 
                id: 2, 
                title: 'Ejercicio de digitación mano derecha', 
                completed: false, 
                type: 'audio', 
                audioUrl: '',
                duration: 0
            },
            { id: 3, title: 'Revisar teoría musical básica', completed: true, type: 'theory' },
            { 
                id: 4, 
                title: 'Práctica: Himno a la Alegría', 
                completed: true, 
                type: 'audio', 
                audioUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3',
                duration: 120
            }
        ],
        stats: {
            attendance: 100,
            practiceHours: 40,
            averageScore: 7.8,
            improvementRate: 35
        },
        messages: []
    }
];

// Variable para el usuario seleccionado en el directorio
let selectedDirectoryUser = null;

// ==================== INICIALIZACIÓN ====================
document.addEventListener('DOMContentLoaded', function() {
    // ==================== INICIALIZACIÓN PRINCIPAL ====================
    
   
    
    // Tabs principales del sidebar
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => switchTab(btn.dataset.tab));
    });

    document.querySelectorAll('.files-tab-btn').forEach(btn => {
        btn.addEventListener('click', () => switchFilesTab(btn.dataset.filesTab));
    });

    // Files
    document.getElementById('fileInput').addEventListener('change', handleFileUpload);
    loadFileCategories();

    document.addEventListener('keydown', (e) => {
    // Evitar que se active si escribes en un input o chat
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    if (e.repeat) return; // Evitar repetición automática

    const key = e.key.toLowerCase();
    if (keyMap[key]) {
        triggerNoteOn(keyMap[key]);
    }
});

document.addEventListener('keyup', (e) => {
    const key = e.key.toLowerCase();
    if (keyMap[key]) {
        triggerNoteOff(keyMap[key]);
    }
});

    // ==================== DIRECTORIO DE USUARIOS ====================
    
    // Cargar directorio al inicio
    loadUsersDirectory();
    
    // Listener para búsqueda en el directorio
    const searchInput = document.getElementById('directorySearch');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            document.querySelectorAll('.user-list-item').forEach(item => {
                const name = item.querySelector('.user-list-name').textContent.toLowerCase();
                item.style.display = name.includes(query) ? 'flex' : 'none';
            });
        });
    }
    
    // ==================== TABS DEL DETALLE DE USUARIO ====================
    
    document.querySelectorAll('.detail-tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            if (!selectedDirectoryUser) return;
            
            const tabName = btn.dataset.detailTab;
            
            // Activar botón
            document.querySelectorAll('.detail-tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // Activar contenido
            document.querySelectorAll('.detail-tab-content').forEach(c => c.classList.remove('active'));
            const targetTab = document.getElementById(`detail${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Tab`);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // Cargar contenido según tab
            switch(tabName) {
                case 'info':
                    loadInfoTab(selectedDirectoryUser);
                    break;
                case 'stats':
                    loadStatsTab(selectedDirectoryUser);
                    break;
                case 'tasks':
                    loadTasksTab(selectedDirectoryUser);
                    break;
                case 'messages':
                    loadMessagesTab(selectedDirectoryUser);
                    break;
            }
        });
    });
    
    // ==================== MENSAJES EN DETALLE DE USUARIO ====================
    
    const userSendBtn = document.getElementById('userSendBtn');
    const userChatInput = document.getElementById('userChatInput');
    
    if (userSendBtn) {
        userSendBtn.addEventListener('click', sendUserMessage);
    }
    
    if (userChatInput) {
        userChatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendUserMessage();
        });
    }

    // ==================== INICIALIZACIÓN DE SISTEMAS ====================
    
    init();
});

async function init() {
    try {
        // ✅ NUEVO: Limpiar conexiones fantasma al iniciar
        await cleanupGhostConnections();
        
        // Stream básico (silencioso)
        localStream = await navigator.mediaDevices.getUserMedia({
            audio: true,
            video: false
        });
        
        localStream.getAudioTracks().forEach(track => {
            track.enabled = false;
        });

        // Registrar en Firebase
        usersRef.child(myId).set({ id: myId, role: "master", name: myName });
        usersRef.child(myId).onDisconnect().remove();

        // Listeners
        listenForStudents();
        listenForSignals();
        
        // Inicializar piano y MIDI
        await initPianoVisual();
        await initMIDI();

        
    } catch (error) {
        console.error("Error al inicializar:", error);
        alert('Error: No se pudo acceder al micrófono.');
    }
}


async function cleanupGhostConnections() {
    try {
        const snapshot = await usersRef.once('value');
        const users = snapshot.val() || {};
        
        const now = Date.now();
        const TIMEOUT_MS = 60000; // 1 minuto sin actividad = fantasma
        
        for (let userId in users) {
            const user = users[userId];
            
            // Si es alumno (role: "user") y no tiene timestamp o es muy antiguo
            if (user.role === "user") {
                const lastActive = user.lastActive || 0;
                
                if (now - lastActive > TIMEOUT_MS || !user.lastActive) {
                    console.log(`🧹 Limpiando conexión fantasma: ${userId}`);
                    await usersRef.child(userId).remove();
                }
            }
        }
        
        console.log('✅ Limpieza de conexiones fantasma completada');
    } catch (error) {
        console.error('Error limpiando conexiones:', error);
    }
}







function addPreloadedFileToList(fileName, fileType, fileSize, fileUrl) {
    const filesList = document.getElementById('filesList');
    const fileItem = document.createElement('div');
    fileItem.className = 'file-item';

    const fileIcon = getFileIcon(fileType);
    const fileSizeFormatted = formatFileSize(fileSize);
    
    // Guardar datos del archivo
    fileItem.dataset.fileName = fileName;
    fileItem.dataset.fileUrl = fileUrl;
    fileItem.dataset.fileType = fileType;
    fileItem.dataset.isPreloaded = 'true'; // Marcar como precargado

    fileItem.innerHTML = `
        <div class="file-icon">
            <i class="${fileIcon}"></i>
        </div>
        <div class="file-info">
            <div class="file-name">${fileName}</div>
            <div class="file-size">${fileSizeFormatted}</div>
        </div>
        <div class="file-actions">
            <button class="file-action-btn" onclick="openFileInModal(this)" title="Ver">
                <i class="fas fa-eye"></i>
            </button>
            <button class="file-action-btn" onclick="removeFile(this)" title="Eliminar">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;

    filesList.appendChild(fileItem);
}

// ==================== TABS ====================
function switchTab(tabName) {
    // Update buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
    if (activeBtn) {
        activeBtn.classList.add('active');
    }

    // Update content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    const activeTab = document.getElementById(`${tabName}Tab`);
    if (activeTab) {
        activeTab.classList.add('active');
    }
}

// ==================== FILES ====================
function handleFileUpload(event) {
    const files = event.target.files;
    
    for (let file of files) {
        addUploadedFile(file);
    }
    
    event.target.value = ''; 
    switchFilesTab('uploaded');
}

function addUploadedFile(file) {
    const filesList = document.getElementById('uploadedFilesList');
    
    // Remover empty state si existe
    const emptyState = filesList.querySelector('.empty-state');
    if (emptyState) {
        emptyState.remove();
    }
    
    const fileItem = document.createElement('div');
    fileItem.className = 'uploaded-file-item';

    const fileIcon = getFileIcon(file.type);
    const fileSize = formatFileSize(file.size);
    
    // Crear URL temporal para el archivo
    const fileUrl = URL.createObjectURL(file);
    
    // Guardar referencia del archivo
    fileItem.dataset.fileName = file.name;
    fileItem.dataset.fileUrl = fileUrl;
    fileItem.dataset.fileType = file.type;

    fileItem.innerHTML = `
        <div class="uploaded-file-icon">
            <i class="${fileIcon}"></i>
        </div>
        <div class="uploaded-file-info">
            <div class="uploaded-file-name">${file.name}</div>
            <div class="uploaded-file-size">${fileSize}</div>
        </div>
        <div class="uploaded-file-actions">
            <button class="uploaded-file-action-btn" onclick="openFileInModal(this)" title="Ver">
                <i class="fas fa-eye"></i>
            </button>
            <button class="uploaded-file-action-btn" onclick="downloadUploadedFile(this)" title="Descargar">
                <i class="fas fa-download"></i>
            </button>
            <button class="uploaded-file-action-btn" onclick="removeUploadedFile(this)" title="Eliminar">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;

    filesList.appendChild(fileItem);
    updateUploadedFilesCount();
}

function updateUploadedFilesCount() {
    const filesList = document.getElementById('uploadedFilesList');
    const count = filesList.querySelectorAll('.uploaded-file-item').length;
    const countBadge = document.getElementById('uploadedFilesCount');
    
    if (countBadge) {
        countBadge.textContent = count;
        // ✅ CORRECCIÓN: Usar visibility en lugar de display
        countBadge.style.visibility = count > 0 ? 'visible' : 'hidden';
    }
}

function downloadUploadedFile(btn) {
    const fileItem = btn.closest('.uploaded-file-item');
    const fileName = fileItem.dataset.fileName;
    const fileUrl = fileItem.dataset.fileUrl;
    
    const a = document.createElement('a');
    a.href = fileUrl;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

function removeUploadedFile(btn) {
    if (!confirm('¿Eliminar este archivo?')) return;
    
    const fileItem = btn.closest('.uploaded-file-item');
    fileItem.remove();
    
    updateUploadedFilesCount();
    
    // Mostrar empty state si no hay archivos
    const filesList = document.getElementById('uploadedFilesList');
    if (filesList.querySelectorAll('.uploaded-file-item').length === 0) {
        filesList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-folder-open"></i>
                <p>No has subido ningún archivo</p>
                <small>Usa el botón "Subir Nuevo Archivo" para comenzar</small>
            </div>
        `;
    }
}

function switchFilesTab(tabName) {
    // Activar botón
    document.querySelectorAll('.files-tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    const activeBtn = document.querySelector(`[data-files-tab="${tabName}"]`);
    if (activeBtn) {
        activeBtn.classList.add('active');
    }
    
    // Activar contenedor
    document.querySelectorAll('.files-tab-container').forEach(container => {
        container.classList.remove('active');
    });
    
    const activeContainer = document.getElementById(`${tabName}Container`);
    if (activeContainer) {
        activeContainer.classList.add('active');
    }
}

function getFileIcon(fileType) {
    if (fileType.includes('pdf')) return 'fas fa-file-pdf';
    if (fileType.includes('image')) return 'fas fa-file-image';
    if (fileType.includes('audio')) return 'fas fa-file-audio';
    if (fileType.includes('video')) return 'fas fa-file-video';
    if (fileType.includes('word')) return 'fas fa-file-word';
    if (fileType.includes('excel') || fileType.includes('spreadsheet')) return 'fas fa-file-excel';
    return 'fas fa-file';
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// ==================== MODAL DRAGGABLE ====================
function openFileInModal(btn) {
    // ✅ CORRECCIÓN: Agregar .uploaded-file-item a la búsqueda
    const fileItem = btn.closest('.file-item, .category-file-item, .uploaded-file-item');
    if (!fileItem) {
        console.error('No se encontró el elemento padre del archivo');
        return;
    }
    
    const fileName = fileItem.dataset.fileName;
    const fileUrl = fileItem.dataset.fileUrl;
    const fileType = fileItem.dataset.fileType;
    
    console.log(`📂 Abriendo archivo: ${fileName} (${fileType})`);
    console.log(`🔗 URL: ${fileUrl}`);
    
    // Crear un ID único para este modal
    const modalId = `modal-${modalCounter++}`;
    
    // Crear el modal dinámicamente
    const modal = createModal(modalId, fileName);
    document.body.appendChild(modal);
    
    console.log(`✅ Modal ${modalId} creado y agregado al DOM`);
    
    openModals[modalId] = {
        element: modal,
        fileName: fileName,
        fileType: fileType,
        pdfDoc: null,
        currentPage: 1,
        totalPages: 0,
        scale: 0.75,
        annotations: {},
        currentTool: 'pen',
        currentColor: '#FF4757',
        isDrawing: false,
        micEnabled: false,
        cameraEnabled: false,
        screenShareEnabled: false,
        localStream: null,
        screenStream: null
    };
    
    // Mostrar modal
    modal.classList.add('active');
    focusModal(modalId);
    
    // Esperar un tick para que el navegador renderice el modal
    setTimeout(() => {
        // Configurar el modal según el tipo de archivo
        if (fileType.includes('pdf')) {
            setupPDFModal(modalId, fileUrl, fileName);
        } else if (fileType.includes('image')) {
            setupImageModal(modalId, fileUrl, fileName);
        } else {
            setupGenericModal(modalId, fileUrl, fileName);
        }
        
        // Inicializar draggable
        initModalDraggable(modalId);
    }, 50);
}

async function manualCleanupGhosts() {
    if (!confirm('¿Eliminar todas las conexiones inactivas?')) return;
    
    const snapshot = await usersRef.once('value');
    const users = snapshot.val() || {};
    let cleaned = 0;
    
    for (let userId in users) {
        if (users[userId].role === "user") {
            // Verificar si tiene peer activo
            if (!peers[userId] || !peers[userId].connected) {
                await usersRef.child(userId).remove();
                cleaned++;
                console.log(`🧹 Removido: ${userId}`);
            }
        }
    }
    
    alert(`✅ Se limpiaron ${cleaned} conexiones fantasma`);
}

function createModal(modalId, fileName) {
    const modal = document.createElement('div');
    modal.className = 'pdf-modal';
    modal.id = modalId;
    
    const offset = (Object.keys(openModals).length * 30) % 200;
    modal.style.top = `${10 + offset}px`;
    modal.style.left = `${10 + offset}px`;
    
    modal.innerHTML = `
        <div class="pdf-modal-header" data-modal-id="${modalId}">
            <h4>
                <i class="fas fa-file-alt"></i>
                <span class="modal-title">${fileName}</span>
            </h4>
            <button class="pdf-modal-close" onclick="closeModalById('${modalId}')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="pdf-modal-body">
            <!-- PIP Video (Cámara del usuario) -->
            <div class="modal-pip-video" data-modal="${modalId}">
                <video class="pip-video-element" autoplay muted playsinline></video>
                <div class="pip-placeholder">
                    <i class="fas fa-video-slash"></i>
                    <span>Cámara apagada</span>
                </div>
                <div class="audio-indicator">
                    <i class="fas fa-microphone"></i>
                </div>
                <div class="pip-status">
                    <i class="fas fa-circle"></i>
                    <span>En vivo</span>
                </div>
            </div>

            <!-- Mini Chat -->
            <div class="modal-mini-chat" data-modal="${modalId}">
                <div class="mini-chat-header">
                    <h4>
                        <i class="fas fa-comments"></i>
                        Chat Rápido
                    </h4>
                    <button class="mini-chat-close" onclick="closeMiniChat('${modalId}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="mini-chat-messages" id="miniChatMessages-${modalId}">
                    <div style="text-align: center; color: var(--text-muted); padding: 20px; font-size: 13px;">
                        Inicia una conversación
                    </div>
                </div>
                <div class="mini-chat-input-container">
                    <input type="text" placeholder="Escribe..." id="miniChatInput-${modalId}" onkeypress="if(event.key==='Enter') sendMiniChatMessage('${modalId}')">
                    <button class="mini-chat-send" onclick="sendMiniChatMessage('${modalId}')">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>

            <!-- Visor PDF -->
            <div class="pdf-viewer-container">
                <div class="pdf-toolbar">
                    <div class="pdf-toolbar-left">
                        <button class="pdf-tool-btn active tool-pen" onclick="selectToolForModal('${modalId}', 'pen')" title="Lápiz">
                            <i class="fas fa-pen"></i>
                        </button>
                        <button class="pdf-tool-btn tool-highlighter" onclick="selectToolForModal('${modalId}', 'highlighter')" title="Resaltador">
                            <i class="fas fa-highlighter"></i>
                        </button>
                        <button class="pdf-tool-btn tool-eraser" onclick="selectToolForModal('${modalId}', 'eraser')" title="Borrador">
                            <i class="fas fa-eraser"></i>
                        </button>
                        
                        <div class="color-picker-btn" style="background: #FF4757;" title="Color">
                            <input type="color" class="color-picker-input" value="#FF4757" onchange="changeColorForModal('${modalId}', this.value)">
                        </div>
                        
                        <button class="pdf-tool-btn" onclick="clearAnnotationsForModal('${modalId}')" title="Limpiar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    
                    <div class="pdf-toolbar-center">
                        <button class="pdf-tool-btn btn-prev" onclick="changePageForModal('${modalId}', -1)">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span class="pdf-page-info">
                            <span class="page-current">1</span> de <span class="page-total">1</span>
                        </span>
                        <button class="pdf-tool-btn btn-next" onclick="changePageForModal('${modalId}', 1)">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    
                    <div class="pdf-toolbar-right">
                        <div class="pdf-zoom-control">
                            <button class="pdf-tool-btn" onclick="changeZoomForModal('${modalId}', -0.25)">
                                <i class="fas fa-search-minus"></i>
                            </button>
                            <button class="pdf-tool-btn" onclick="changeZoomForModal('${modalId}', 0.25)">
                                <i class="fas fa-search-plus"></i>
                            </button>
                            <span class="pdf-zoom-display">75%</span>
                        </div>
                    </div>
                </div>
                
                <!-- ✅ NUEVA BARRA DE ESTADO COMPARTIR -->
                <div class="modal-sharing-status" id="sharingStatus-${modalId}">
                    <div class="sharing-status-content">
                        <i class="fas fa-eye-slash"></i>
                        <span>Sin compartir</span>
                    </div>
                </div>
                
                <div class="pdf-canvas-container">
                    <div class="pdf-canvas-wrapper">
                        <canvas class="pdf-canvas"></canvas>
                        <canvas class="annotation-canvas"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Iframe para otros tipos -->
            <iframe class="modal-iframe" style="display: none; width: 100%; height: 100%; border: none;"></iframe>

            <!-- Controles de medios -->
            <div class="modal-media-controls">
                <button class="media-control-btn btn-microphone" onclick="toggleModalMicrophone('${modalId}')" title="Micrófono">
                    <i class="fas fa-microphone"></i>
                </button>
                <button class="media-control-btn btn-camera" onclick="toggleModalCamera('${modalId}')" title="Cámara">
                    <i class="fas fa-video"></i>
                </button>
                <button class="media-control-btn btn-midi-share" onclick="toggleModalMIDI('${modalId}')" title="Transmitir Piano MIDI">
    <i class="fas fa-music"></i>
</button>
                <button class="media-control-btn btn-chat-modal" onclick="openChatFromModal('${modalId}')" title="Chat">
                    <i class="fas fa-comments"></i>
                </button>
            </div>
        </div>
    `;
    
    modal.addEventListener('mousedown', () => focusModal(modalId));
    
    return modal;
}


// ==================== CONTROLES DE MEDIOS EN MODAL ====================
async function toggleModalMicrophone(modalId) {
    const modalData = openModals[modalId];
    if (!modalData) return;
    
    const modal = modalData.element;
    const btn = modal.querySelector('.btn-microphone');
    const audioIndicator = modal.querySelector('.audio-indicator');
    
    // Obtener studentId del modal
    const studentId = Object.keys(individualScreenStreams).find(id => 
        individualScreenStreams[id].modalId === modalId
    );
    
    if (!studentId || !peers[studentId]) {
        alert('No hay alumno conectado a este modal');
        return;
    }
    
    if (!modalData.micEnabled) {
        try {
            // ✅ Obtener stream de audio
            const audioStream = await navigator.mediaDevices.getUserMedia({ 
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                }, 
                video: false 
            });
            
            const audioTrack = audioStream.getAudioTracks()[0];
            
            // ✅ CRÍTICO: Agregar track directamente al peer
            const sender = peers[studentId].addTrack(audioTrack, audioStream);
            
            // Guardar referencias
            modalData.audioTrack = audioTrack;
            modalData.audioStream = audioStream;
            modalData.audioSender = sender; // Importante para removerlo después
            
            modalData.micEnabled = true;
            btn.classList.add('active');
            btn.querySelector('i').className = 'fas fa-microphone';
            audioIndicator.classList.add('active');
            
            console.log(`🎤 Micrófono activado y enviado a ${getStudentName(studentId)}`);
            
        } catch (error) {
            console.error('Error al activar micrófono:', error);
            alert('No se pudo acceder al micrófono: ' + error.message);
        }
    } else {
        // ✅ Desactivar micrófono
        if (modalData.audioSender && peers[studentId]) {
            try {
                // Remover el sender del peer
                peers[studentId].removeTrack(modalData.audioSender);
            } catch (error) {
                console.error('Error al remover track:', error);
            }
        }
        
        if (modalData.audioTrack) {
            modalData.audioTrack.stop();
        }
        
        if (modalData.audioStream) {
            modalData.audioStream.getTracks().forEach(track => track.stop());
        }
        
        delete modalData.audioTrack;
        delete modalData.audioStream;
        delete modalData.audioSender;
        
        modalData.micEnabled = false;
        btn.classList.remove('active');
        btn.querySelector('i').className = 'fas fa-microphone-slash';
        audioIndicator.classList.remove('active');
        
        console.log(`🎤 Micrófono desactivado`);
    }
}

async function toggleModalCamera(modalId) {
    const modalData = openModals[modalId];
    if (!modalData) return;
    
    const modal = modalData.element;
    const btn = modal.querySelector('.btn-camera');
    const pipContainer = modal.querySelector('.modal-pip-video');
    const video = pipContainer.querySelector('.pip-video-element');
    const placeholder = pipContainer.querySelector('.pip-placeholder');
    
    // ✅ NUEVO: Obtener studentId
    const studentId = Object.keys(individualScreenStreams).find(id => 
        individualScreenStreams[id].modalId === modalId
    );
    
    if (!studentId || !peers[studentId]) {
        alert('No hay alumno conectado a este modal');
        return;
    }
    
    if (!modalData.cameraEnabled) {
        try {
            // Obtener stream de video
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }, 
                audio: false 
            });
            
            // ✅ CRÍTICO: Enviar track al peer
            const videoTrack = stream.getVideoTracks()[0];
            if (videoTrack) {
                modalData.videoSender = peers[studentId].addTrack(videoTrack, stream);
            }
            
            modalData.localStream = stream;
            modalData.cameraEnabled = true;
            
            // Mostrar video localmente
            video.srcObject = stream;
            video.style.display = 'block';
            placeholder.style.display = 'none';
            pipContainer.classList.add('active');
            
            btn.classList.add('active');
            btn.querySelector('i').className = 'fas fa-video';
            
            console.log(`📹 Cámara activada y enviada a ${getStudentName(studentId)}`);
            
        } catch (error) {
            console.error('Error al activar cámara:', error);
            alert('No se pudo acceder a la cámara');
        }
    } else {
        // Desactivar
        if (modalData.videoSender && peers[studentId]) {
            peers[studentId].removeTrack(modalData.videoSender.track, modalData.localStream);
        }
        
        if (modalData.localStream) {
            modalData.localStream.getVideoTracks().forEach(track => track.stop());
            modalData.localStream = null;
        }
        
        modalData.cameraEnabled = false;
        video.srcObject = null;
        video.style.display = 'none';
        placeholder.style.display = 'flex';
        pipContainer.classList.remove('active');
        
        btn.classList.remove('active');
        btn.querySelector('i').className = 'fas fa-video-slash';
        
        console.log(`📹 Cámara desactivada`);
    }
}

function toggleModalMIDI(modalId) {
    if (!midiInput) {
        alert('No hay piano MIDI conectado');
        return;
    }
    
    const modalData = openModals[modalId];
    if (!modalData) return;
    
    // Obtener studentId del modal
    const studentId = Object.keys(individualScreenStreams).find(id => 
        individualScreenStreams[id].modalId === modalId
    );
    
    if (!studentId || !peers[studentId]) {
        alert('No hay alumno conectado a este modal');
        return;
    }
    
    const modal = modalData.element;
    const btn = modal.querySelector('.btn-midi-share');
    
    // Si este modal ya está transmitiendo, apagar
    if (activeMidiStudent === studentId) {
        activeMidiStudent = null;
        midiTransmissionEnabled = false;
        btn.classList.remove('active');
        updateTransmissionStatus();
        console.log('🎹 Transmisión MIDI detenida');
    } else {
        // Activar para este estudiante
        activeMidiStudent = studentId;
        midiTransmissionEnabled = true;
        
        // Desactivar otros botones MIDI
        document.querySelectorAll('.btn-midi-share').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        updateTransmissionStatus();
        console.log(`🎹 Transmisión MIDI activa → ${getStudentName(studentId)}`);
    }
}

async function setupPDFModal(modalId, url, fileName) {
    const modalData = openModals[modalId];
    const modal = modalData.element;
    
    try {
        // ✅ Mostrar visor PDF y ocultar iframe
        const pdfContainer = modal.querySelector('.pdf-viewer-container');
        const iframe = modal.querySelector('.modal-iframe');
        
        pdfContainer.style.display = 'flex';
        iframe.style.display = 'none';
        
        // Configurar PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // Cargar PDF
        const loadingTask = pdfjsLib.getDocument(url);
        modalData.pdfDoc = await loadingTask.promise;
        modalData.totalPages = modalData.pdfDoc.numPages;
        
        // Actualizar UI
        modal.querySelector('.page-total').textContent = modalData.totalPages;
        modal.querySelector('.page-current').textContent = '1';
        modal.querySelector('.pdf-zoom-display').textContent = '75%';
        
        // Renderizar primera página
        await renderPageForModal(modalId, 1);
        
        // Inicializar canvas de anotaciones
        initAnnotationCanvasForModal(modalId);
        
        console.log(`✅ PDF cargado en ${modalId}:`, fileName);
        
    } catch (error) {
        console.error('❌ Error al cargar PDF:', error);
        alert('No se pudo cargar el PDF: ' + error.message);
    }
}

function setupImageModal(modalId, url, fileName) {
    const modal = openModals[modalId].element;
    
    modal.querySelector('.pdf-viewer-container').style.display = 'none';
    const iframe = modal.querySelector('.modal-iframe');
    iframe.style.display = 'block';
    
    iframe.srcdoc = `
        <html>
            <head>
                <style>
                    body { 
                        margin: 0; 
                        display: flex; 
                        justify-content: center; 
                        align-items: center; 
                        background: #000; 
                        height: 100vh;
                    }
                    img { 
                        max-width: 100%; 
                        max-height: 100vh; 
                        object-fit: contain;
                    }
                </style>
            </head>
            <body>
                <img src="${url}" alt="${fileName}">
            </body>
        </html>
    `;
}




async function renderPageForModal(modalId, pageNum) {
    const modalData = openModals[modalId];
    if (!modalData || !modalData.pdfDoc) return;
    
    try {
        const page = await modalData.pdfDoc.getPage(pageNum);
        
        // ✅ SEPARAR CALIDAD DE RENDERIZADO VS ZOOM VISUAL
        const INTERNAL_QUALITY = 2.0; // Siempre alta calidad
        const userScale = modalData.scale; // Lo que el usuario eligió (0.75, 1.0, etc)
        
        // Calcular escala final
        const renderScale = INTERNAL_QUALITY;
        const outputScale = window.devicePixelRatio || 1;
        
        const viewport = page.getViewport({ scale: renderScale });
        
        const modal = modalData.element;
        const canvas = modal.querySelector('.pdf-canvas');
        const context = canvas.getContext('2d');
        const annotationCanvas = modal.querySelector('.annotation-canvas');

        // Dimensiones físicas (alta resolución)
        canvas.width = Math.floor(viewport.width * outputScale);
        canvas.height = Math.floor(viewport.height * outputScale);
        
        // Dimensiones visuales (según zoom del profesor)
        const displayWidth = Math.floor(viewport.width * (userScale / INTERNAL_QUALITY));
        const displayHeight = Math.floor(viewport.height * (userScale / INTERNAL_QUALITY));
        
        canvas.style.width = displayWidth + "px";
        canvas.style.height = displayHeight + "px";

        annotationCanvas.width = canvas.width;
        annotationCanvas.height = canvas.height;
        annotationCanvas.style.width = canvas.style.width;
        annotationCanvas.style.height = canvas.style.height;
        
        const ctxAnn = annotationCanvas.getContext('2d');
        ctxAnn.scale(outputScale * INTERNAL_QUALITY / userScale, outputScale * INTERNAL_QUALITY / userScale);

        const transform = outputScale !== 1 ? [outputScale, 0, 0, outputScale, 0, 0] : null;

        await page.render({
            canvasContext: context,
            transform: transform,
            viewport: viewport
        }).promise;
        
        restoreAnnotationsForModal(modalId, pageNum);
        updatePageButtonsForModal(modalId);
        
        console.log(`✨ Renderizado - Interno: ${INTERNAL_QUALITY}x, Visual: ${userScale}x, Display: ${displayWidth}x${displayHeight}`);
        
    } catch (error) {
        console.error('Error al renderizar página:', error);
    }
}

/*
async function renderPageForModal(modalId, pageNum) {
    const modalData = openModals[modalId];
    if (!modalData || !modalData.pdfDoc) return;
    
    try {
        const page = await modalData.pdfDoc.getPage(pageNum);
        
        const outputScale = window.devicePixelRatio || 1;
        const viewport = page.getViewport({ scale: modalData.scale });
        
        const modal = modalData.element;
        const canvas = modal.querySelector('.pdf-canvas');
        const context = canvas.getContext('2d');
        const annotationCanvas = modal.querySelector('.annotation-canvas');

        canvas.width = Math.floor(viewport.width * outputScale);
        canvas.height = Math.floor(viewport.height * outputScale);
        
        canvas.style.width = Math.floor(viewport.width) + "px";
        canvas.style.height = Math.floor(viewport.height) + "px";

        annotationCanvas.width = canvas.width;
        annotationCanvas.height = canvas.height;
        annotationCanvas.style.width = canvas.style.width;
        annotationCanvas.style.height = canvas.style.height;
        
        const ctxAnn = annotationCanvas.getContext('2d');
        ctxAnn.scale(outputScale, outputScale);

        const transform = outputScale !== 1 
            ? [outputScale, 0, 0, outputScale, 0, 0] 
            : null;

        const renderContext = {
            canvasContext: context,
            transform: transform,
            viewport: viewport
        };
        
        await page.render(renderContext).promise;
        
        // ✅ NUEVO: Actualizar canvas del stream si existe
        if (modalData.streamCanvas && modalData.updateStreamCanvas) {
            modalData.streamCanvas.width = canvas.width;
            modalData.streamCanvas.height = canvas.height;
            modalData.updateStreamCanvas();
        }
        
        restoreAnnotationsForModal(modalId, pageNum);
        updatePageButtonsForModal(modalId);
        
    } catch (error) {
        console.error('Error al renderizar página:', error);
    }
}
*/


function stopScreenShare(studentId) {
    const streamData = individualScreenStreams[studentId];
    if (!streamData) return;
    
    const modalId = streamData.modalId;
    
    // Detener animationFrame solo si NO es compartir pantalla nativo
    if (!streamData.isNativeScreenShare && streamData.animationFrameId) {
        cancelAnimationFrame(streamData.animationFrameId);
    }
    
    if (streamData.sender && peers[studentId]) {
        try {
            peers[studentId].removeTrack(streamData.sender.track, streamData.stream);
        } catch (error) {
            console.error('Error removiendo track:', error);
        }
    }
    
    streamData.stream.getTracks().forEach(track => track.stop());
    
    const modalData = openModals[modalId];
    if (modalData && !streamData.isNativeScreenShare) {
        delete modalData.streamCanvas;
        delete modalData.updateStreamCanvas;
    }
    
    delete individualScreenStreams[studentId];
    
    if (openModals[modalId]) {
        updateSharingStatusBar(modalId, studentId, 'remove');
    }
}

/*
async function renderPageForModal(modalId, pageNum) {
    const modalData = openModals[modalId];
    if (!modalData || !modalData.pdfDoc) return;
    
    try {
        const page = await modalData.pdfDoc.getPage(pageNum);
        const viewport = page.getViewport({ scale: modalData.scale });
        
        const modal = modalData.element;
        const canvas = modal.querySelector('.pdf-canvas');
        const context = canvas.getContext('2d');
        
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        
        await page.render({
            canvasContext: context,
            viewport: viewport
        }).promise;
        
        // Actualizar canvas de anotaciones
        const annotationCanvas = modal.querySelector('.annotation-canvas');
        annotationCanvas.width = viewport.width;
        annotationCanvas.height = viewport.height;
        
        restoreAnnotationsForModal(modalId, pageNum);
        updatePageButtonsForModal(modalId);
        
    } catch (error) {
        console.error('Error al renderizar página:', error);
    }
}
*/


function updatePageButtonsForModal(modalId) {
    const modalData = openModals[modalId];
    const modal = modalData.element;
    
    modal.querySelector('.btn-prev').disabled = modalData.currentPage <= 1;
    modal.querySelector('.btn-next').disabled = modalData.currentPage >= modalData.totalPages;
}

async function changePageForModal(modalId, delta) {
    const modalData = openModals[modalId];
    if (!modalData) return;
    
    const newPage = modalData.currentPage + delta;
    if (newPage < 1 || newPage > modalData.totalPages) return;
    
    modalData.currentPage = newPage;
    modalData.element.querySelector('.page-current').textContent = newPage;
    
    await renderPageForModal(modalId, newPage);
}

async function changeZoomForModal(modalId, delta) {
    const modalData = openModals[modalId];
    if (!modalData) return;
    
    modalData.scale += delta;
    if (modalData.scale < 0.5) modalData.scale = 0.5;
    if (modalData.scale > 3) modalData.scale = 3;
    
    modalData.element.querySelector('.pdf-zoom-display').textContent = 
        Math.round(modalData.scale * 100) + '%';
    
    await renderPageForModal(modalId, modalData.currentPage);
}

function initAnnotationCanvasForModal(modalId) {
    const modal = openModals[modalId].element;
    const canvas = modal.querySelector('.annotation-canvas');
    
    canvas.addEventListener('mousedown', (e) => startDrawingForModal(modalId, e));
    canvas.addEventListener('mousemove', (e) => drawForModal(modalId, e));
    canvas.addEventListener('mouseup', () => stopDrawingForModal(modalId));
    canvas.addEventListener('mouseleave', () => stopDrawingForModal(modalId));
}

function startDrawingForModal(modalId, e) {
    const modalData = openModals[modalId];
    modalData.isDrawing = true;
    
    const rect = e.target.getBoundingClientRect();
    modalData.lastX = e.clientX - rect.left;
    modalData.lastY = e.clientY - rect.top;
}

function drawForModal(modalId, e) {
    const modalData = openModals[modalId];
    if (!modalData.isDrawing) return;
    
    const modal = modalData.element;
    const canvas = modal.querySelector('.annotation-canvas');
    const ctx = canvas.getContext('2d');
    const rect = canvas.getBoundingClientRect();
    
    const currentX = e.clientX - rect.left;
    const currentY = e.clientY - rect.top;
    
    ctx.beginPath();
    ctx.moveTo(modalData.lastX, modalData.lastY);
    ctx.lineTo(currentX, currentY);
    
    if (modalData.currentTool === 'pen') {
        ctx.strokeStyle = modalData.currentColor;
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.globalCompositeOperation = 'source-over';
    } else if (modalData.currentTool === 'highlighter') {
        ctx.strokeStyle = modalData.currentColor;
        ctx.lineWidth = 15;
        ctx.lineCap = 'round';
        ctx.globalAlpha = 0.3;
        ctx.globalCompositeOperation = 'source-over';
    } else if (modalData.currentTool === 'eraser') {
        ctx.lineWidth = 20;
        ctx.globalCompositeOperation = 'destination-out';
    }
    
    ctx.stroke();
    ctx.globalAlpha = 1.0;
    
    modalData.lastX = currentX;
    modalData.lastY = currentY;
    
    saveAnnotationForModal(modalId);
    
    // ✅ NUEVO: Actualizar stream si está compartiendo
    if (modalData.updateStreamCanvas) {
        modalData.updateStreamCanvas();
    }
}

function stopDrawingForModal(modalId) {
    if (openModals[modalId]) {
        openModals[modalId].isDrawing = false;
    }
}

function selectToolForModal(modalId, tool) {
    const modalData = openModals[modalId];
    modalData.currentTool = tool;
    
    const modal = modalData.element;
    modal.querySelectorAll('.pdf-tool-btn').forEach(btn => btn.classList.remove('active'));
    modal.querySelector(`.tool-${tool}`).classList.add('active');
}

function changeColorForModal(modalId, color) {
    openModals[modalId].currentColor = color;
}

function saveAnnotationForModal(modalId) {
    const modalData = openModals[modalId];
    const canvas = modalData.element.querySelector('.annotation-canvas');
    
    if (!modalData.annotations[modalData.currentPage]) {
        modalData.annotations[modalData.currentPage] = [];
    }
    modalData.annotations[modalData.currentPage] = canvas.toDataURL();
}

function restoreAnnotationsForModal(modalId, pageNum) {
    const modalData = openModals[modalId];
    const canvas = modalData.element.querySelector('.annotation-canvas');
    const ctx = canvas.getContext('2d');
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if (modalData.annotations[pageNum]) {
        const img = new Image();
        img.onload = () => ctx.drawImage(img, 0, 0);
        img.src = modalData.annotations[pageNum];
    }
}

function clearAnnotationsForModal(modalId) {
    if (!confirm('¿Borrar todas las anotaciones de esta página?')) return;
    
    const modalData = openModals[modalId];
    const canvas = modalData.element.querySelector('.annotation-canvas');
    const ctx = canvas.getContext('2d');
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    delete modalData.annotations[modalData.currentPage];
}

function setupGenericModal(modalId, url, fileName) {
    const modal = openModals[modalId].element;
    
    modal.querySelector('.pdf-viewer-container').style.display = 'none';
    const iframe = modal.querySelector('.modal-iframe');
    iframe.style.display = 'block';
    iframe.src = url;
}

function focusModal(modalId) {
    // Remover focus de todos
    Object.keys(openModals).forEach(id => {
        const modal = openModals[id].element;
        modal.classList.remove('focused');
        modal.style.zIndex = 2000;
    });
    
    // Dar focus al seleccionado
    highestZIndex += 10;
    const modal = openModals[modalId].element;
    modal.style.zIndex = highestZIndex;
    modal.classList.add('focused');
}

function closeModalById(modalId) {
    if (!openModals[modalId]) return;
    
    const modalData = openModals[modalId];
    const modal = modalData.element;
    
    // ✅ Detener todos los streams
    if (modalData.localStream) {
        modalData.localStream.getTracks().forEach(track => track.stop());
    }
    
    if (modalData.screenStream) {
        modalData.screenStream.getTracks().forEach(track => track.stop());
    }
    
    // Remover del DOM
    modal.remove();
    
    // Eliminar del registro
    delete openModals[modalId];
    
    // Ocultar backdrop si no hay más modales
    if (Object.keys(openModals).length === 0) {
        const backdrop = document.getElementById('modalBackdrop');
        backdrop.classList.remove('active');
    }
    
    console.log(`❌ Modal cerrado: ${modalId}`);
}

function closeAllModals() {
    Object.keys(openModals).forEach(modalId => {
        closeModalById(modalId);
    });
}


function initModalDraggable(modalId) {
    const modal = openModals[modalId].element;
    const header = modal.querySelector('.pdf-modal-header');

    let isDragging = false;
    let startX, startY, initialLeft, initialTop;

    function dragStart(e) {
        // Evitar arrastrar si se pulsa el botón de cerrar
        if (e.target.closest('.pdf-modal-close')) return;
        
        // Traer al frente
        focusModal(modalId);

        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;

        const rect = modal.getBoundingClientRect();
        initialLeft = rect.left;
        initialTop = rect.top;

        header.style.cursor = 'grabbing';

        // IMPORTANTE: Añadimos los eventos al documento SOLO al empezar a arrastrar
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', dragEnd);
    }

    function dragEnd() {
        isDragging = false;
        header.style.cursor = 'move';
        
        // IMPORTANTE: Limpiamos los eventos al soltar para no afectar otros modales
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('mouseup', dragEnd);
    }

    function drag(e) {
        if (!isDragging) return;
        e.preventDefault();

        const dx = e.clientX - startX;
        const dy = e.clientY - startY;

        modal.style.left = `${initialLeft + dx}px`;
        modal.style.top = `${initialTop + dy}px`;
    }

    // Solo escuchamos el mousedown permanentemente en el header
    header.addEventListener('mousedown', dragStart);
}

function downloadFile(btn) {
    const fileItem = btn.closest('.file-item');
    const fileName = fileItem.dataset.fileName;
    const fileUrl = fileItem.dataset.fileUrl;
    
    const a = document.createElement('a');
    a.href = fileUrl;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

function removeFile(btn) {
    btn.closest('.file-item').remove();
}

function listenForStudents() {
    usersRef.on("value", snap => {
        const users = snap.val() || {};
        const studentsContainer = document.getElementById("studentsContainer");

        studentsContainer.innerHTML = '';
        connectedStudents = {};
        
        const now = Date.now();
        const TIMEOUT_MS = 30000; // 30 segundos sin heartbeat = desconectado
        
        for (let key in users) {
            if (users[key].role === "user") {
                const lastHeartbeat = users[key].lastHeartbeat || 0;
                
                // ✅ Solo mostrar alumnos con heartbeat reciente
                if (now - lastHeartbeat < TIMEOUT_MS) {
                    connectedStudents[key] = users[key];
                    createStudentUI(key, users[key].name || users[key].id);
                } else {
                    // Limpiar conexión fantasma
                    console.log(`👻 Removiendo fantasma: ${key}`);
                    usersRef.child(key).remove();
                }
            }
        }
        
        // Limpiar selección si el estudiante se desconectó
        if (selectedStudent && !connectedStudents[selectedStudent]) {
            selectedStudent = null;
            updateStudentInfo(null);
            disableChat();
        }
        
        // Limpiar peers de estudiantes desconectados
        for (let studentId in peers) {
            if (!connectedStudents[studentId]) {
                cleanupStudentConnection(studentId);
            }
        }
    });
    
    // ✅ NUEVO: Verificar heartbeats periódicamente
    setInterval(() => {
        checkHeartbeats();
    }, 10000); // Cada 10 segundos
}


function checkHeartbeats() {
    usersRef.once('value', snapshot => {
        const users = snapshot.val() || {};
        const now = Date.now();
        const TIMEOUT_MS = 30000;
        
        for (let userId in users) {
            if (users[userId].role === "user") {
                const lastHeartbeat = users[userId].lastHeartbeat || 0;
                
                if (now - lastHeartbeat > TIMEOUT_MS) {
                    console.log(`💀 Heartbeat timeout: ${userId}`);
                    usersRef.child(userId).remove();
                }
            }
        }
    });
}

function createStudentUI(studentId, name) {
    const studentsContainer = document.getElementById("studentsContainer");
    const existingElement = document.getElementById(`student-${studentId}`);
    
    if (existingElement) {
        existingElement.remove();
    }

    // Datos simulados (En el futuro, sácalos de snapshot.val())
    const niveles = ["Principiante", "Intermedio", "Avanzado"];
    const lecciones = ["Escalas Mayores", "Acordes 7ma", "Nocturno Op.9", "Lectura Rítmica"];
    // Generamos datos 'random' consistentes basados en el ID para que no cambien al refrescar
    const randomLvl = niveles[studentId.charCodeAt(0) % 3];
    const randomLesson = lecciones[studentId.charCodeAt(studentId.length-1) % 4];
    // Avatar random (usando UI Avatars con el nombre)
    const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random&color=fff&size=128`;

    const isConnected = studentConnections[studentId]?.connected || false;
    const isSelected = selectedStudent === studentId;
    const isMidiActive = activeMidiStudent === studentId;
    const isAudioActive = individualAudioStreams[studentId]?.active || false;
    const isScreenActive = individualScreenStreams[studentId]?.active || false;
    const audioMuted = document.getElementById(`audio-${studentId}`)?.muted || false;

    const studentItem = document.createElement("div");
    studentItem.className = `student-item ${isConnected ? 'connected' : ''} ${isSelected ? 'selected' : ''}`;
    studentItem.id = `student-${studentId}`;

    studentItem.innerHTML = `
        <div class="card-avatar-container">
            <img src="${avatarUrl}" class="card-avatar" alt="${name}">
            <div class="card-status-dot ${isConnected ? 'connected' : ''}"></div>
        </div>

        <div class="card-info">
            <div class="card-name">${name}</div>
            <div class="card-meta">${randomLvl}</div>
            <div class="card-lesson"><i class="fas fa-book-open"></i> ${randomLesson}</div>
        </div>

        <div class="student-actions">
            ${!isConnected ? `
                <button id="btn-connect-${studentId}" class="btn-connect-primary" onclick="handleConnectClick('${studentId}')">
            <i class="fas fa-plug"></i> 
            <span>Conectar</span>
        </button>
                <br>
            ` : `
                <button class="student-action-btn action-desktop ${isScreenActive ? 'active' : ''}" 
                onclick="selectModalForScreenShare('${studentId}')" 
                title="Compartir Modal">
            <i class="fas fa-window-restore"></i>
        </button>
        <button class="student-action-btn action-close" 
                onclick="disconnectStudent('${studentId}')" 
                title="Desconectar">
            <i class="fas fa-times"></i>
        </button>
            `}
        </div>
    `;

    // Animación de entrada suave
    studentItem.style.opacity = '0';
    studentsContainer.appendChild(studentItem);
    
    // Pequeño timeout para activar la transición de opacidad
    setTimeout(() => {
        studentItem.style.opacity = '1';
    }, 10);
}


function handleConnectClick(studentId) {
    // 1. Obtener el botón específico
    const btn = document.getElementById(`btn-connect-${studentId}`);
    
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = `
            <i class="fas fa-circle-notch fa-spinner-animate"></i> 
            <span>Conectando...</span>
        `;
    }
    setTimeout(() => {
        connectToStudent(studentId);
    }, 50);
}

async function connectToStudent(studentId) {
    console.log(`Conectando con ${getStudentName(studentId)}...`);
    startPeer(studentId, true);
}

function disconnectStudent(studentId) {
    cleanupStudentConnection(studentId);
    signalsRef.push({ from: myId, to: studentId, type: 'close' });
    console.log(`Desconectado de ${getStudentName(studentId)}`);
    createStudentUI(studentId, getStudentName(studentId));
}

function cleanupStudentConnection(studentId) {
    if (peers[studentId]) {
        peers[studentId].destroy();
        delete peers[studentId];
    }
    
    // Limpiar streams individuales
    if (individualAudioStreams[studentId]?.stream) {
        individualAudioStreams[studentId].stream.getTracks().forEach(track => track.stop());
        delete individualAudioStreams[studentId];
    }

    // ✅ USAR LA NUEVA FUNCIÓN
    if (individualScreenStreams[studentId]) {
        stopScreenShare(studentId);
    }

    studentConnections[studentId] = { connected: false };

    const audioEl = document.getElementById(`audio-${studentId}`);
    if (audioEl) audioEl.remove();

    if (activeMidiStudent === studentId) {
        activeMidiStudent = null;
        midiTransmissionEnabled = false;
        updateTransmissionStatus();
    }

    if (selectedStudent === studentId) {
        selectedStudent = null;
        updateStudentInfo(null);
        disableChat();
    }
}

function selectStudentForChat(studentId) {
    document.querySelectorAll('.student-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    selectedStudent = studentId;
    
    const studentElement = document.getElementById(`student-${studentId}`);
    if (studentElement) {
        studentElement.classList.add('selected');
    }
    
    updateStudentInfo(studentId);
    enableChat();

    document.querySelectorAll('.action-chat').forEach(btn => {
        btn.classList.remove('active');
    });
    
    const chatBtn = document.querySelector(`#student-${studentId} .action-chat`);
    if (chatBtn) {
        chatBtn.classList.add('active');
    }

    loadChatHistory(studentId);

    // Switch to chat tab
    switchTab('chat');
}

function loadChatHistory(studentId) {
    const chatLog = document.getElementById("chatLog");
    chatLog.innerHTML = '';
    
    const chatId = [myId, studentId].sort().join('-');
    chatsRef.child(chatId).off();
    
    chatsRef.child(chatId).on('child_added', snap => {
        const msg = snap.val();
        const senderName = msg.sender === myId ? "Tú" : getStudentName(msg.sender);
        logChat(senderName, msg.text);
    });
}

// ==================== CONTROL DE AUDIO INDIVIDUAL ====================
async function toggleIndividualAudio(studentId) {
    if (!peers[studentId] || !peers[studentId].connected) {
        alert('El alumno no está conectado');
        return;
    }
    
    const isActive = individualAudioStreams[studentId]?.active || false;

    if (!isActive) {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            
            individualAudioStreams[studentId] = { stream: stream, active: true };
            
            const audioTrack = stream.getAudioTracks()[0];
            peers[studentId].addTrack(audioTrack, stream);
            
            console.log(`🎤 Audio activado para ${getStudentName(studentId)}`);
            createStudentUI(studentId, getStudentName(studentId));
            
        } catch (error) {
            console.error('Error al activar audio:', error);
            alert('No se pudo acceder al micrófono');
        }
    } else {
        const stream = individualAudioStreams[studentId].stream;
        
        const senders = peers[studentId]._pc.getSenders();
        senders.forEach(sender => {
            if (sender.track && sender.track.kind === 'audio' && stream.getAudioTracks().includes(sender.track)) {
                peers[studentId].removeTrack(sender.track, stream);
            }
        });
        
        stream.getTracks().forEach(track => track.stop());
        delete individualAudioStreams[studentId];
        
        console.log(`🎤 Audio desactivado para ${getStudentName(studentId)}`);
        createStudentUI(studentId, getStudentName(studentId));
    }
}

// ==================== CONTROL DE PANTALLA INDIVIDUAL ====================
async function toggleIndividualScreen(studentId) {
    // Esta función ya no se usa desde el card, pero la mantenemos para uso interno
    const isActive = individualScreenStreams[studentId]?.active || false;
    
    if (isActive) {
        const stream = individualScreenStreams[studentId].stream;
        
        const senders = peers[studentId]._pc.getSenders();
        senders.forEach(sender => {
            if (sender.track && stream.getTracks().includes(sender.track)) {
                peers[studentId].removeTrack(sender.track, stream);
            }
        });
        
        stream.getTracks().forEach(track => track.stop());
        delete individualScreenStreams[studentId];
        
        console.log(`🖥️ Compartir pantalla detenido para ${getStudentName(studentId)}`);
        createStudentUI(studentId, getStudentName(studentId));
    }
}


function selectModalForScreenShare(studentId) {
    // ✅ CORRECCIÓN: Verificar en studentConnections, NO en individualScreenStreams
    if (!peers[studentId] || !studentConnections[studentId]?.connected) {
        alert('El alumno no está conectado');
        console.error(`❌ Estado de conexión:`, {
            peerExists: !!peers[studentId],
            connected: studentConnections[studentId]?.connected,
            studentId: studentId
        });
        return;
    }
    
    const openModalIds = Object.keys(openModals);
    
    if (openModalIds.length === 0) {
        alert('No hay modales abiertos. Abre un archivo primero.');
        return;
    }
    
    // Si solo hay un modal, compartirlo directamente
    if (openModalIds.length === 1) {
        shareModalWithStudent(studentId, openModalIds[0]);
        return;
    }
    
    // Si hay múltiples modales, mostrar selector
    showModalSelector(studentId, openModalIds);
}

function showModalSelector(studentId, modalIds) {
    const selectorHTML = modalIds.map(modalId => {
        const modalData = openModals[modalId];
        return `
            <div style="padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; 
                        margin-bottom: 10px; cursor: pointer; transition: all 0.3s ease;"
                 onmouseover="this.style.borderColor='var(--primary-color)'"
                 onmouseout="this.style.borderColor='var(--border-color)'"
                 onclick="shareModalWithStudent('${studentId}', '${modalId}'); closeModalSelector()">
                <i class="fas fa-file-alt" style="margin-right: 8px; color: var(--primary-color);"></i>
                <strong>${modalData.fileName}</strong>
            </div>
        `;
    }).join('');
    
    const overlay = document.createElement('div');
    overlay.id = 'modalSelector';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    `;
    
    overlay.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 16px; 
                    max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
            <h3 style="margin: 0 0 20px 0; color: var(--text-dark); font-size: 20px;">
                <i class="fas fa-share-square" style="color: var(--primary-color); margin-right: 10px;"></i>
                Selecciona el Modal a Compartir
            </h3>
            <div style="max-height: 400px; overflow-y: auto;">
                ${selectorHTML}
            </div>
            <button onclick="closeModalSelector()" 
                    style="margin-top: 20px; width: 100%; padding: 12px; background: var(--text-muted); 
                           color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                Cancelar
            </button>
        </div>
    `;
    
    document.body.appendChild(overlay);
}

function closeModalSelector() {
    const selector = document.getElementById('modalSelector');
    if (selector) selector.remove();
}

async function shareModalWithStudent(studentId, modalId) {
    const modalData = openModals[modalId];
    if (!modalData) {
        alert('Modal no encontrado');
        return;
    }
    
    // ✅ VERIFICACIÓN MEJORADA
    if (!peers[studentId]) {
        alert('Peer no existe para este alumno');
        console.error('❌ Peer no encontrado:', studentId);
        return;
    }
    
    if (!peers[studentId].connected) {
        alert('El peer no está en estado conectado');
        console.error('❌ Peer no conectado:', {
            studentId,
            peerState: peers[studentId]._pc?.connectionState,
            iceState: peers[studentId]._pc?.iceConnectionState
        });
        return;
    }
    
    try {
        // Detener stream anterior si existe
        if (individualScreenStreams[studentId]?.stream) {
            stopScreenShare(studentId);
        }
        
        console.log(`📺 Solicitando compartir pantalla para ${getStudentName(studentId)}`);
        
        // Captura de pantalla nativa
        const stream = await navigator.mediaDevices.getDisplayMedia({
            video: {
                displaySurface: 'window',
                width: { ideal: 1920 },
                height: { ideal: 1080 },
                frameRate: { ideal: 30, max: 60 }
            },
            audio: false
        });
        
        console.log('✅ Stream de pantalla obtenido:', stream.id);
        
        // Detectar cuando el usuario deja de compartir manualmente
        stream.getVideoTracks()[0].onended = () => {
            console.log('📺 Usuario detuvo compartir pantalla');
            stopScreenShare(studentId);
            createStudentUI(studentId, getStudentName(studentId));
        };
        
        // Si hay audio activo del modal, agregarlo
        if (modalData.micEnabled && modalData.audioTrack) {
            stream.addTrack(modalData.audioTrack);
            console.log('🎤 Audio del micrófono agregado');
        }
        
        // ✅ CRÍTICO: Usar replaceTrack en lugar de addTrack para video
        const videoTrack = stream.getVideoTracks()[0];
        const senders = peers[studentId]._pc.getSenders();
        const videoSender = senders.find(s => s.track?.kind === 'video');
        
        if (videoSender) {
            // Ya existe un sender de video, reemplazar track
            await videoSender.replaceTrack(videoTrack);
            console.log('✅ Track de video reemplazado');
        } else {
            // No existe sender de video, agregarlo
            const sender = peers[studentId].addTrack(videoTrack, stream);
            console.log('✅ Track de video agregado');
        }
        
        // Guardar referencia
        individualScreenStreams[studentId] = { 
            stream: stream, 
            active: true,
            modalId: modalId,
            isNativeScreenShare: true,
            sender: videoSender || peers[studentId]._pc.getSenders().find(s => s.track === videoTrack)
        };
        
        createStudentUI(studentId, getStudentName(studentId));
        updateSharingStatusBar(modalId, studentId, 'add');
        updateModalControls(modalId, studentId);
        
        console.log(`✅ Pantalla compartida exitosamente con ${getStudentName(studentId)}`);
        
    } catch (error) {
        console.error('❌ Error al compartir pantalla:', error);
        
        if (error.name === 'NotAllowedError') {
            alert('❌ Compartir pantalla cancelado o no permitido por el navegador.');
        } else if (error.name === 'NotFoundError') {
            alert('❌ No se encontró ninguna pantalla/ventana para compartir.');
        } else if (error.name === 'NotReadableError') {
            alert('❌ Error de hardware. Cierra otras aplicaciones que usen la pantalla.');
        } else {
            alert('Error al compartir contenido: ' + error.message);
        }
    }
}



function updateModalControls(modalId, studentId) {
    const modal = openModals[modalId]?.element;
    if (!modal) return;
    
    const isConnected = studentId && peers[studentId] && peers[studentId].connected;
    
    // Obtener todos los botones de control
    const micBtn = modal.querySelector('.btn-microphone');
    const camBtn = modal.querySelector('.btn-camera');
    const midiBtn = modal.querySelector('.btn-midi-share');
    const chatBtn = modal.querySelector('.btn-chat-modal');
    
    // Los botones siempre están habilitados, solo cambian de estilo
    if (isConnected) {
        console.log(`✅ Controles listos para ${getStudentName(studentId)}`);
    } else {
        // Remover clases activas si no hay conexión
        micBtn.classList.remove('active');
        camBtn.classList.remove('active');
        midiBtn.classList.remove('active');
        chatBtn.classList.remove('active');
        
        console.log('❌ Sin conexión activa');
    }
}


function updateSharingStatusBar(modalId, studentId, action) {
    const modal = openModals[modalId]?.element;
    if (!modal) return;
    
    const statusBar = modal.querySelector('.modal-sharing-status');
    if (!statusBar) return;
    
    // Obtener lista de estudiantes viendo este modal
    const viewingStudents = Object.keys(individualScreenStreams).filter(id => 
        individualScreenStreams[id].active && 
        individualScreenStreams[id].modalId === modalId
    );
    
    if (action === 'add' || viewingStudents.length > 0) {
        // Modo: Compartiendo
        statusBar.classList.add('active');
        
        let content = `
            <i class="fas fa-eye"></i>
            <span>Compartiendo con:</span>
        `;
        
        // Agregar lista de espectadores
        if (viewingStudents.length > 0) {
            content += `<div class="sharing-viewers-list">`;
            viewingStudents.forEach(id => {
                content += `
                    <div class="viewer-badge">
                        <i class="fas fa-user"></i>
                        <span>${getStudentName(id)}</span>
                    </div>
                `;
            });
            content += `</div>`;
            
            // Botón para detener todo
            content += `
                <button class="sharing-stop-btn" onclick="stopAllSharingForModal('${modalId}')">
                    <i class="fas fa-stop"></i>
                    Detener Todo
                </button>
            `;
        }
        
        statusBar.querySelector('.sharing-status-content').outerHTML = `
            <div class="sharing-status-content">
                ${content}
            </div>
        `;
        
    } else {
        // Modo: Sin compartir
        statusBar.classList.remove('active');
        statusBar.innerHTML = `
            <div class="sharing-status-content">
                <i class="fas fa-eye-slash"></i>
                <span>Sin compartir</span>
            </div>
        `;
    }
}

function stopAllSharingForModal(modalId) {
    if (!confirm('¿Detener compartir con todos los estudiantes?')) return;
    const viewingStudents = Object.keys(individualScreenStreams).filter(id => 
        individualScreenStreams[id].active && 
        individualScreenStreams[id].modalId === modalId
    );
    viewingStudents.forEach(studentId => {
        stopScreenShare(studentId);
        createStudentUI(studentId, getStudentName(studentId));
    });
    updateSharingStatusBar(modalId, null, 'remove');
}


async function capturePDFCanvas(modalId) {
    const modalData = openModals[modalId];
    const modal = modalData.element;
    
    const pdfCanvas = modal.querySelector('.pdf-canvas');
    const annotationCanvas = modal.querySelector('.annotation-canvas');
    
    if (!pdfCanvas) {
        throw new Error('No se encontró el canvas del PDF');
    }
    
    // Crear un canvas temporal que combine PDF + anotaciones
    const combinedCanvas = document.createElement('canvas');
    combinedCanvas.width = pdfCanvas.width;
    combinedCanvas.height = pdfCanvas.height;
    const ctx = combinedCanvas.getContext('2d');
    
    // Función para actualizar el canvas combinado
    function updateCombinedCanvas() {
        ctx.clearRect(0, 0, combinedCanvas.width, combinedCanvas.height);
        ctx.drawImage(pdfCanvas, 0, 0);
        if (annotationCanvas) {
            ctx.drawImage(annotationCanvas, 0, 0);
        }
    }
    
    // Actualizar inmediatamente
    updateCombinedCanvas();
    
    // Capturar stream del canvas combinado
    const stream = combinedCanvas.captureStream(30); // 30 FPS
    
    // Guardar función de actualización para usarla después
    modalData.updateStreamCanvas = updateCombinedCanvas;
    modalData.streamCanvas = combinedCanvas;
    
    return stream;
}


async function captureIframeContent(iframe) {
    try {
        // Intentar capturar el contenido del iframe
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        const iframeBody = iframeDoc.body;
        
        if (!iframeBody) {
            throw new Error('No se puede acceder al contenido del iframe');
        }
        
        // Crear canvas para renderizar
        const canvas = document.createElement('canvas');
        canvas.width = iframe.offsetWidth || 640;
        canvas.height = iframe.offsetHeight || 480;
        
        const ctx = canvas.getContext('2d');
        
        // Usar html2canvas si está disponible, sino alternativa
        if (typeof html2canvas !== 'undefined') {
            const rendered = await html2canvas(iframeBody);
            ctx.drawImage(rendered, 0, 0, canvas.width, canvas.height);
        } else {
            // Alternativa: dibujar color sólido con texto
            ctx.fillStyle = '#f0f0f0';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#333';
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Contenido del Archivo', canvas.width / 2, canvas.height / 2);
        }
        
        return canvas.captureStream(15); // 15 FPS para imágenes estáticas
        
    } catch (error) {
        console.error('Error capturando iframe:', error);
        throw new Error('No se pudo capturar el contenido del archivo');
    }
}


function startPDFStreamUpdates(studentId, modalId) {
    const modalData = openModals[modalId];
    
    if (!modalData.updateStreamCanvas) return;
    
    // Función que se ejecuta en cada frame
    function updateFrame() {
        if (!individualScreenStreams[studentId] || 
            individualScreenStreams[studentId].modalId !== modalId) {
            return; // Detener si ya no está compartiendo
        }
        
        // Actualizar canvas combinado
        modalData.updateStreamCanvas();
        
        // Continuar en el siguiente frame
        const frameId = requestAnimationFrame(updateFrame);
        individualScreenStreams[studentId].animationFrameId = frameId;
    }
    
    // Iniciar el loop
    updateFrame();
}



function toggleIncomingAudio(studentId) {
    const audioEl = document.getElementById(`audio-${studentId}`);
    if (audioEl) {
        audioEl.muted = !audioEl.muted;
        createStudentUI(studentId, getStudentName(studentId));
    }
}

function updateStudentInfo(studentId) {
    const infoBox = document.getElementById('selectedStudentInfo');
    
    if (studentId) {
        const isConnected = studentConnections[studentId]?.connected || false;
        infoBox.innerHTML = `
            <i class="fas fa-user"></i>
            <span><strong>${getStudentName(studentId)}</strong> - ${isConnected ? 'Conectado' : 'Desconectado'}</span>
        `;
        infoBox.classList.add('active');
    } else {
        infoBox.innerHTML = `
            <i class="fas fa-info-circle"></i>
            <span>Selecciona un alumno para iniciar</span>
        `;
        infoBox.classList.remove('active');
    }
}

function getStudentName(studentId) {
    const student = connectedStudents[studentId];
    return student ? (student.name || studentId) : studentId;
}

// ==================== WEBRTC ====================
function startPeer(targetId, initiator) {
    const peer = new SimplePeer({
        initiator,
        stream: localStream,
        trickle: false,
        config: {
            iceServers: [
                { urls: "stun:stun.relay.metered.ca:80" },
                { 
                    urls: "turn:a.relay.metered.ca:80", 
                    username: "fad444a63bcf5c8176a3e139", 
                    credential: "MQm2u8W0l1TCVMm0" 
                },
                { 
                    urls: "turn:a.relay.metered.ca:443", 
                    username: "fad444a63bcf5c8176a3e139", 
                    credential: "MQm2u8W0l1TCVMm0" 
                }
            ]
        }
    });


    
    peers[targetId] = peer;
    studentConnections[targetId] = { connected: false };

    peer._pc.oniceconnectionstatechange = () => {
        const state = peer._pc.iceConnectionState;
        console.log(`🧊 ICE State [${getStudentName(targetId)}]: ${state}`);
        
        if (state === 'connected' || state === 'completed') {
            studentConnections[targetId].connected = true;
            createStudentUI(targetId, getStudentName(targetId));
        } else if (state === 'failed' || state === 'disconnected') {
            console.warn(`⚠️ ICE ${state} para ${getStudentName(targetId)}`);
            
            if (state === 'failed') {
                studentConnections[targetId].connected = false;
                createStudentUI(targetId, getStudentName(targetId));
            }
        }
    };

    peer.on("signal", data => {
        signalsRef.push({ from: myId, to: targetId, data });
    });

    peer.on("connect", () => {
        // ✅ CRÍTICO: Cambiar estado inmediatamente
        studentConnections[targetId].connected = true;
        console.log(`✅ Conexión WebRTC con ${getStudentName(targetId)}`);
        
        // ✅ NUEVO: Actualizar UI del estudiante
        createStudentUI(targetId, getStudentName(targetId));
        
        // ✅ NUEVO: Cancelar timeout si existe
        const btnConnect = document.getElementById(`btn-connect-${targetId}`);
        if (btnConnect) {
            btnConnect.disabled = false;
            btnConnect.innerHTML = `
                <i class="fas fa-check-circle"></i> 
                <span>Conectado</span>
            `;
        }
    });

    peer.on("data", msg => {
        try {
            const data = JSON.parse(msg.toString());
            
            if (data.type === 'chat') {
                // Chat en sidebar
                if (selectedStudent === targetId) {
                    logChat(getStudentName(targetId), data.text);
                }
                
                // Chat en modal
                const modalId = individualScreenStreams[targetId]?.modalId;
                if (modalId && openModals[modalId]) {
                    const messagesContainer = document.getElementById(`miniChatMessages-${modalId}`);
                    if (messagesContainer) {
                        const messageElement = document.createElement('div');
                        messageElement.className = 'message other';
                        messageElement.innerHTML = `
                            <div class="message-sender">${getStudentName(targetId)}</div>
                            <div>${data.text}</div>
                        `;
                        messagesContainer.appendChild(messageElement);
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                }
            }
            
            // Recibir MIDI del alumno
            else if (data.type === 'midi') {
                console.log(`🎹 MIDI recibido de ${getStudentName(targetId)}: ${data.note}`);
                
                if (data.action === 'noteOn') {
                    triggerNoteOn(data.note);
                } else if (data.action === 'noteOff') {
                    triggerNoteOff(data.note);
                }
            }
            
        } catch (error) {
            console.error("Error parsing peer data:", error);
        }
    });

    peer.on("stream", stream => {
        console.log(`Stream recibido de ${getStudentName(targetId)}`);
        
        let audioEl = document.getElementById(`audio-${targetId}`);
        if (!audioEl) {
            audioEl = document.createElement('audio');
            audioEl.id = `audio-${targetId}`;
            audioEl.autoplay = true;
            audioEl.style.display = 'none';
            document.body.appendChild(audioEl);
        }
        audioEl.srcObject = stream;
        
        // ✅ NUEVO: Marcar como conectado al recibir stream
        if (!studentConnections[targetId].connected) {
            studentConnections[targetId].connected = true;
            createStudentUI(targetId, getStudentName(targetId));
        }
    });

    peer.on("close", () => {
        studentConnections[targetId] = { connected: false };
        console.log(`Conexión cerrada con ${getStudentName(targetId)}`);
        
        // ✅ Remover de Firebase
        usersRef.child(targetId).remove();
        
        createStudentUI(targetId, getStudentName(targetId));
    });

    peer.on("error", (err) => {
        console.error("Error en peer:", err);
        studentConnections[targetId] = { connected: false };
        
        // ✅ Remover de Firebase en caso de error
        usersRef.child(targetId).remove();
        
        // ✅ NUEVO: Resetear botón de conexión
        const btnConnect = document.getElementById(`btn-connect-${targetId}`);
        if (btnConnect) {
            btnConnect.disabled = false;
            btnConnect.innerHTML = `
                <i class="fas fa-plug"></i> 
                <span>Conectar</span>
            `;
        }
        
        createStudentUI(targetId, getStudentName(targetId));
    });
}

function listenForSignals() {
    signalsRef.on("child_added", snap => {
        const { from, to, data, type } = snap.val();

        if (to === myId) {
            if (type === 'close') {
                if (peers[from]) {
                    peers[from].destroy();
                    delete peers[from];
                }
                studentConnections[from] = { connected: false };
                createStudentUI(from, getStudentName(from));
            } else if (data) {
                if (!peers[from]) {
                    startPeer(from, false);
                }
                peers[from].signal(data);
            }
        }
        
        signalsRef.child(snap.key).remove();
    });
}

// ==================== CHAT ====================
function sendMessage() {
    if (!selectedStudent) return;
    
    const input = document.getElementById("chatInput");
    const msg = input.value.trim();
    if (!msg) return;

    input.value = "";

    const chatId = [myId, selectedStudent].sort().join('-');
    const messageData = {
        text: msg,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        sender: myId,
        recipient: selectedStudent
    };
    chatsRef.child(chatId).push(messageData);

    if (peers[selectedStudent] && peers[selectedStudent].connected) {
        peers[selectedStudent].send(JSON.stringify({ 
            type: 'chat', 
            text: msg 
        }));
    }
}

function logChat(sender, message) {
    const chatLog = document.getElementById("chatLog");
    const messageElement = document.createElement("div");
    messageElement.classList.add("message");
    messageElement.classList.add(sender === "Tú" ? "self" : "other");
    messageElement.innerHTML = `
        <div class="message-sender">${sender}</div>
        <div>${message}</div>
    `;
    chatLog.appendChild(messageElement);
    chatLog.scrollTop = chatLog.scrollHeight;
}

function enableChat() {
    document.getElementById("chatInput").disabled = false;
    document.getElementById("sendBtn").disabled = false;
}

function disableChat() {
    document.getElementById("chatInput").disabled = true;
    document.getElementById("sendBtn").disabled = true;
}

// ==================== MIDI ====================
async function initMIDI() {
    if (navigator.requestMIDIAccess) {
        try {
            midiAccess = await navigator.requestMIDIAccess();
            console.log('✅ MIDI Acceso concedido');

            const inputs = midiAccess.inputs.values();
            for (let input of inputs) {
                console.log(`🎹 Piano MIDI: ${input.name}`);
                midiInput = input;
                midiInput.onmidimessage = handleMIDIMessage;
                updateMIDIStatus(true, input.name);
            }

            if (!midiInput) {
                console.warn('⚠️ No se detectó piano MIDI');
                updateMIDIStatus(false);
            }

            midiAccess.onstatechange = (e) => {
                if (e.port.type === 'input') {
                    if (e.port.state === 'connected') {
                        console.log(`🔌 Piano conectado: ${e.port.name}`);
                        midiInput = e.port;
                        midiInput.onmidimessage = handleMIDIMessage;
                        updateMIDIStatus(true, e.port.name);
                    } else {
                        console.log('🔌 Piano desconectado');
                        updateMIDIStatus(false);
                        if (midiTransmissionEnabled) {
                            activeMidiStudent = null;
                            midiTransmissionEnabled = false;
                            updateTransmissionStatus();
                        }
                    }
                }
            };

        } catch (err) {
            console.error('❌ Error MIDI:', err);
        }
    } else {
        console.warn('Web MIDI API no soportada');
    }
}

function updateMIDIStatus(connected, deviceName = '') {
    const statusEl = document.getElementById('midiHeaderStatus');
    if (connected) {
        statusEl.innerHTML = `<i class="fas fa-circle"></i> Piano: ${deviceName}`;
        statusEl.classList.add('connected');
    } else {
        statusEl.innerHTML = '<i class="fas fa-circle"></i> Sin piano MIDI';
        statusEl.classList.remove('connected');
    }
}

function handleMIDIMessage(message) {
    const [command, note, velocity] = message.data;
    const noteName = midiNoteToName(note);

    // Reproducir visual local
    if (command === 144 && velocity > 0) {
        triggerNoteOn(noteName);
    } else if (command === 128 || (command === 144 && velocity === 0)) {
        triggerNoteOff(noteName);
    }

    // Enviar a alumno si está activo
    if (midiTransmissionEnabled && activeMidiStudent) {
        sendMIDIToStudent(activeMidiStudent, command === 144 && velocity > 0 ? 'noteOn' : 'noteOff', noteName, velocity);
    }
}

function midiNoteToName(midiNote) {
    const noteNames = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
    const octave = Math.floor(midiNote / 12) - 1;
    const noteName = noteNames[midiNote % 12];
    return `${noteName}${octave}`;
}

function sendMIDIToStudent(studentId, type, note, velocity) {
    if (peers[studentId] && peers[studentId].connected) {
        try {
            const midiData = {
                type: 'midi',
                action: type,
                note: note,
                velocity: velocity,
                timestamp: Date.now()
            };
            peers[studentId].send(JSON.stringify(midiData));
        } catch (error) {
            console.error('Error sending MIDI:', error);
        }
    }
}

function toggleMidiTransmission(studentId) {
    if (!midiInput) {
        alert('No hay piano MIDI conectado');
        return;
    }
    
    if (!studentConnections[studentId]?.connected) {
        alert('El alumno no está conectado');
        return;
    }

    if (activeMidiStudent === studentId) {
        activeMidiStudent = null;
        midiTransmissionEnabled = false;
        console.log('🎹 Transmisión MIDI detenida');
    } else {
        activeMidiStudent = studentId;
        midiTransmissionEnabled = true;
        console.log(`🎹 Transmisión MIDI activa → ${getStudentName(studentId)}`);
    }

    updateTransmissionStatus();
    createStudentUI(studentId, getStudentName(studentId));
}

function updateTransmissionStatus() {
    const statusBadge = document.getElementById('transmissionStatus');
    if (midiTransmissionEnabled && activeMidiStudent) {
        statusBadge.textContent = `Transmitiendo a ${getStudentName(activeMidiStudent)}`;
        statusBadge.classList.add('active');
    } else {
        statusBadge.textContent = 'Transmisión inactiva';
        statusBadge.classList.remove('active');
    }
}

// ==================== PIANO VISUAL ====================
async function initPianoVisual() {
    await Tone.start();
    
    sampler = new Tone.Sampler({
        urls: {
            A0: "A0.mp3", C1: "C1.mp3", "D#1": "Ds1.mp3", "F#1": "Fs1.mp3", A1: "A1.mp3",
            C2: "C2.mp3", "D#2": "Ds2.mp3", "F#2": "Fs2.mp3", A2: "A2.mp3", C3: "C3.mp3",
            "D#3": "Ds3.mp3", "F#3": "Fs3.mp3", A3: "A3.mp3", C4: "C4.mp3", "D#4": "Ds4.mp3",
            "F#4": "Fs4.mp3", A4: "A4.mp3", C5: "C5.mp3", "D#5": "Ds5.mp3", "F#5": "Fs5.mp3",
            A5: "A5.mp3", C6: "C6.mp3", "D#6": "Ds6.mp3", "F#6": "Fs6.mp3", A6: "A6.mp3",
            C7: "C7.mp3", "D#7": "Ds7.mp3", "F#7": "Fs7.mp3", A7: "A7.mp3", C8: "C8.mp3"
        },
        release: 1,
        baseUrl: "https://tonejs.github.io/audio/salamander/"
    }).toDestination();

    renderPianoKeys();
}

function renderPianoKeys() {
    const container = document.getElementById('piano-keys');
    if (!container) return;
    
    container.innerHTML = '';

    const pattern = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
    const blackKeys = { 'C': 'Db', 'D': 'Eb', 'F': 'Gb', 'G': 'Ab', 'A': 'Bb' };

    // Funciones helper para el mouse
    const handleMouseName = (note) => {
        triggerNoteOn(note);
    };
    const handleMouseUp = (note) => {
        triggerNoteOff(note);
    };

    for (let octave = 1; octave <= 7; octave++) {
        for (let i = 0; i <= 6; i++) {
            const note = pattern[i];
            const noteName = `${note}${octave}`;
            
            // Tecla Blanca
            const whiteKey = document.createElement('div');
            whiteKey.className = 'piano-key white';
            whiteKey.dataset.note = noteName;
            whiteKey.id = `key-${noteName}`;
            
            // --- NUEVO: Eventos Mouse para tecla blanca ---
            whiteKey.addEventListener('mousedown', () => handleMouseName(noteName));
            whiteKey.addEventListener('mouseup', () => handleMouseUp(noteName));
            whiteKey.addEventListener('mouseleave', () => handleMouseUp(noteName));
            // ---------------------------------------------

            container.appendChild(whiteKey);
            
            // Tecla Negra
            if (blackKeys[note]) {
                const blackNoteName = `${blackKeys[note]}${octave}`;
                const blackKey = document.createElement('div');
                blackKey.className = 'piano-key black';
                blackKey.dataset.note = blackNoteName;
                blackKey.id = `key-${blackNoteName}`;

                // --- NUEVO: Eventos Mouse para tecla negra ---
                blackKey.addEventListener('mousedown', () => handleMouseName(blackNoteName));
                blackKey.addEventListener('mouseup', () => handleMouseUp(blackNoteName));
                blackKey.addEventListener('mouseleave', () => handleMouseUp(blackNoteName));
                // ---------------------------------------------

                container.appendChild(blackKey);
            }
        }
    }
}

function triggerNoteOn(noteName) {
    if (activeNotes[noteName]) return;
    
    if (sampler && Tone.context.state === 'running') {
        sampler.triggerAttack(noteName, Tone.now());
    }

    const key = document.getElementById(`key-${noteName}`);
    if (key) {
        key.classList.add('active');
        createFloatingLabel(noteName, key);
    }

    activeNotes[noteName] = true;
}

function triggerNoteOff(noteName) {
    if (!activeNotes[noteName]) return;
    
    if (sampler) {
        sampler.triggerRelease(noteName);
    }

    const key = document.getElementById(`key-${noteName}`);
    if (key) {
        key.classList.remove('active');
    }

    removeFloatingLabel(noteName);
    delete activeNotes[noteName];
}

function createFloatingLabel(noteName, keyElement) {
    const casing = document.getElementById('piano-top-casing');
    if (!casing) return;
    
    const keyRect = keyElement.getBoundingClientRect();
    const casingRect = casing.getBoundingClientRect();
    const keyCenterX = keyRect.left + (keyRect.width / 2);
    const relativeX = keyCenterX - casingRect.left;

    const lbl = document.createElement('div');
    lbl.className = 'casing-note-label';
    lbl.id = `lbl-${noteName}`;
    lbl.textContent = noteName.replace(/[0-9]/g, '');
    lbl.style.left = `${relativeX}px`;
    casing.appendChild(lbl);
}

function removeFloatingLabel(noteName) {
    const lbl = document.getElementById(`lbl-${noteName}`);
    if (lbl) lbl.remove();
}


// ==================== DIRECTORIO DE USUARIOS ====================
function loadUsersDirectory() {
    const usersList = document.getElementById('usersList');
    usersList.innerHTML = '';
    
    fictitiousUsers.forEach(user => {
        const userItem = document.createElement('div');
        userItem.className = 'user-list-item';
        userItem.onclick = () => showUserDetail(user.id);
        
        userItem.innerHTML = `
            <img src="${user.avatar}" class="user-list-avatar" alt="${user.name}">
            <div class="user-list-info">
                <div class="user-list-name">${user.name}</div>
                <div class="user-list-level">${user.level}</div>
                <div class="user-list-lesson">
                    <i class="fas fa-book-open"></i>
                    ${user.lesson}
                </div>
            </div>
        `;
        
        usersList.appendChild(userItem);
    });
}

function showUserDetail(userId) {
    const user = fictitiousUsers.find(u => u.id === userId);
    if (!user) return;
    
    selectedDirectoryUser = user;
    
    // Ocultar directorio, mostrar detalle
    document.getElementById('usersDirectoryView').style.display = 'none';
    document.getElementById('userDetailView').style.display = 'flex';
    
    // Llenar información
    document.getElementById('detailAvatar').src = user.avatar;
    document.getElementById('detailName').textContent = user.name;
    document.getElementById('detailLevel').textContent = user.level;
    document.querySelector('#detailLesson span').textContent = user.lesson;
    
    // Cargar tab activo
    loadInfoTab(user);
    
    // Activar primera tab
    document.querySelectorAll('.detail-tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector('[data-detail-tab="info"]').classList.add('active');
    
    document.querySelectorAll('.detail-tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById('detailInfoTab').classList.add('active');
}

function backToDirectory() {
    document.getElementById('userDetailView').style.display = 'none';
    document.getElementById('usersDirectoryView').style.display = 'flex';
    selectedDirectoryUser = null;
}

function loadInfoTab(user) {
    const infoTab = document.getElementById('detailInfoTab');
    
    infoTab.innerHTML = `
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">Edad</div>
                <div class="info-value">${user.age} años</div>
            </div>
            <div class="info-item">
                <div class="info-label">Email</div>
                <div class="info-value">${user.email}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Teléfono</div>
                <div class="info-value">${user.phone}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Fecha de Inicio</div>
                <div class="info-value">${user.startDate}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Horas Completadas</div>
                <div class="info-value">${user.hoursCompleted}h</div>
            </div>
            <div class="info-item">
                <div class="info-label">Lecciones Completadas</div>
                <div class="info-value">${user.lessonsCompleted}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Próxima Lección</div>
                <div class="info-value">${user.nextLesson}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Estado</div>
                <div class="info-value" style="color: var(--secondary-color);">Activo</div>
            </div>
        </div>
    `;
}

function loadStatsTab(user) {
    const statsTab = document.getElementById('detailStatsTab');
    
    statsTab.innerHTML = `
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <div class="stat-value">${user.stats.attendance}%</div>
                <div class="stat-label">Asistencia</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-value">${user.stats.practiceHours}h</div>
                <div class="stat-label">Horas de Práctica</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-star"></i>
                </div>
                <div class="stat-value">${user.stats.averageScore}</div>
                <div class="stat-label">Promedio</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-value">+${user.stats.improvementRate}%</div>
                <div class="stat-label">Mejora</div>
            </div>
        </div>
    `;
}

function loadTasksTab(user) {
    const tasksTab = document.getElementById('detailTasksTab');
    
    let tasksHTML = '<div class="tasks-list">';
    
    user.tasks.forEach(task => {
        const hasAudio = task.type === 'audio' && task.audioUrl;
        const needsRecording = task.type === 'audio' && !task.audioUrl;
        
        tasksHTML += `
            <div class="task-item ${task.type === 'audio' ? 'has-audio' : ''}" id="task-${user.id}-${task.id}">
                <div class="task-main-content">
                    <div class="task-checkbox ${task.completed ? 'completed' : ''}" onclick="toggleTask('${user.id}', ${task.id})">
                        ${task.completed ? '<i class="fas fa-check"></i>' : ''}
                    </div>
                    <div class="task-info">
                        <div class="task-title">${task.title}</div>
                        <div class="task-type">${getTaskTypeLabel(task.type)}</div>
                    </div>
                    ${task.type === 'audio' ? `
                        <button class="task-audio-toggle ${!hasAudio ? 'no-audio' : ''}" 
                                onclick="toggleAudioPlayer('${user.id}', ${task.id})"
                                ${!hasAudio ? 'disabled' : ''}>
                            <i class="fas fa-${hasAudio ? 'volume-up' : 'microphone-slash'}"></i>
                        </button>
                    ` : ''}
                </div>
                
                ${task.type === 'audio' ? `
                    ${hasAudio ? `
                        <div class="audio-player-container" id="player-${user.id}-${task.id}">
                            <div class="audio-progress-container" onclick="seekAudio(event, '${user.id}', ${task.id})">
                                <div class="audio-progress-bar" id="progress-${user.id}-${task.id}"></div>
                            </div>
                            <div class="audio-player-controls">
                                <button class="audio-play-btn" id="play-btn-${user.id}-${task.id}" 
                                        onclick="togglePlayPause('${user.id}', ${task.id})">
                                    <i class="fas fa-play"></i>
                                </button>
                                <span class="audio-time-display" id="time-${user.id}-${task.id}">
                                    0:00 / ${formatTime(task.duration)}
                                </span>
                                <div class="audio-speed-selector">
                                    <button class="audio-speed-btn" id="speed-btn-${user.id}-${task.id}" 
                                            onclick="toggleSpeedMenu('${user.id}', ${task.id})">
                                        1.0x
                                    </button>
                                    <div class="audio-speed-menu" id="speed-menu-${user.id}-${task.id}">
                                        <div class="audio-speed-option" onclick="setPlaybackSpeed('${user.id}', ${task.id}, 0.5)">0.5x</div>
                                        <div class="audio-speed-option" onclick="setPlaybackSpeed('${user.id}', ${task.id}, 0.75)">0.75x</div>
                                        <div class="audio-speed-option active" onclick="setPlaybackSpeed('${user.id}', ${task.id}, 1.0)">1.0x</div>
                                        <div class="audio-speed-option" onclick="setPlaybackSpeed('${user.id}', ${task.id}, 1.25)">1.25x</div>
                                        <div class="audio-speed-option" onclick="setPlaybackSpeed('${user.id}', ${task.id}, 1.5)">1.5x</div>
                                        <div class="audio-speed-option" onclick="setPlaybackSpeed('${user.id}', ${task.id}, 2.0)">2.0x</div>
                                    </div>
                                </div>
                            </div>
                            <audio id="audio-${user.id}-${task.id}" src="${task.audioUrl}" preload="metadata"></audio>
                        </div>
                        <div class="task-audio-status">
                            <i class="fas fa-check-circle"></i>
                            Audio enviado
                        </div>
                    ` : `
                        <div class="task-no-audio">
                            <i class="fas fa-exclamation-circle"></i>
                            Pendiente de grabación
                        </div>
                    `}
                ` : ''}
            </div>
        `;
    });
    
    tasksHTML += '</div>';
    tasksTab.innerHTML = tasksHTML;
    
    // Inicializar listeners de audio
    user.tasks.forEach(task => {
        if (task.type === 'audio' && task.audioUrl) {
            initAudioPlayer(user.id, task.id);
        }
    });
}

function getTaskTypeLabel(type) {
    const labels = {
        'practice': 'Práctica',
        'audio': 'Audio',
        'reading': 'Lectura',
        'theory': 'Teoría'
    };
    return labels[type] || type;
}

function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function toggleTask(userId, taskId) {
    const user = fictitiousUsers.find(u => u.id === userId);
    if (!user) return;
    
    const task = user.tasks.find(t => t.id === taskId);
    if (!task) return;
    
    task.completed = !task.completed;
    loadTasksTab(user);
}

function playTaskAudio(audioUrl) {
    if (!audioUrl) {
        alert('No hay audio disponible');
        return;
    }
    
    const audio = new Audio(audioUrl);
    audio.play();
}

function loadMessagesTab(user) {
    const chatLog = document.getElementById('userChatLog');
    chatLog.innerHTML = '';
    
    if (user.messages && user.messages.length > 0) {
        user.messages.forEach(msg => {
            logUserChat(msg.sender, msg.text);
        });
    } else {
        chatLog.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 40px;">No hay mensajes</div>';
    }
}

function logUserChat(sender, message) {
    const chatLog = document.getElementById('userChatLog');
    const messageElement = document.createElement("div");
    messageElement.classList.add("message");
    messageElement.classList.add(sender === myName ? "self" : "other");
    messageElement.innerHTML = `
        <div class="message-sender">${sender}</div>
        <div>${message}</div>
    `;
    chatLog.appendChild(messageElement);
    chatLog.scrollTop = chatLog.scrollHeight;
}

function sendUserMessage() {
    if (!selectedDirectoryUser) return;
    
    const input = document.getElementById('userChatInput');
    const msg = input.value.trim();
    if (!msg) return;
    
    input.value = '';
    
    // Agregar mensaje al array del usuario
    if (!selectedDirectoryUser.messages) {
        selectedDirectoryUser.messages = [];
    }
    
    selectedDirectoryUser.messages.push({
        sender: myName,
        text: msg,
        timestamp: Date.now()
    });
    
    logUserChat(myName, msg);
}



 function openChatFromModal(modalId) {
    const miniChat = document.querySelector(`.modal-mini-chat[data-modal="${modalId}"]`);
    if (miniChat) {
        miniChat.classList.toggle('active');
    }
}

function closeMiniChat(modalId) {
    const miniChat = document.querySelector(`.modal-mini-chat[data-modal="${modalId}"]`);
    if (miniChat) {
        miniChat.classList.remove('active');
    }
}

function sendMiniChatMessage(modalId) {
    const input = document.getElementById(`miniChatInput-${modalId}`);
    const messagesContainer = document.getElementById(`miniChatMessages-${modalId}`);
    
    const msg = input.value.trim();
    if (!msg) return;
    
    input.value = '';
    
    // ✅ NUEVO: Obtener studentId del modal
    const studentId = Object.keys(individualScreenStreams).find(id => 
        individualScreenStreams[id].modalId === modalId
    );
    
    if (!studentId || !peers[studentId]) {
        alert('No hay alumno conectado a este modal');
        return;
    }
    
    // Crear mensaje localmente
    const messageElement = document.createElement('div');
    messageElement.className = 'message self';
    messageElement.innerHTML = `
        <div class="message-sender">Tú</div>
        <div>${msg}</div>
    `;
    
    messagesContainer.appendChild(messageElement);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // ✅ CRÍTICO: Enviar por WebRTC
    if (peers[studentId] && peers[studentId].connected) {
        try {
            peers[studentId].send(JSON.stringify({ 
                type: 'chat', 
                text: msg 
            }));
            console.log(`💬 Mensaje enviado a ${getStudentName(studentId)}: ${msg}`);
        } catch (error) {
            console.error('Error enviando mensaje:', error);
        }
    }
}



// ==================== REPRODUCTOR DE AUDIO ====================
const audioPlayers = {};

function initAudioPlayer(userId, taskId) {
    const audioId = `${userId}-${taskId}`;
    const audioElement = document.getElementById(`audio-${audioId}`);
    
    if (!audioElement) return;
    
    audioPlayers[audioId] = {
        audio: audioElement,
        isPlaying: false,
        currentSpeed: 1.0
    };
    
    // Listener para actualizar progreso
    audioElement.addEventListener('timeupdate', () => {
        updateAudioProgress(userId, taskId);
    });
    
    // Listener cuando termina el audio
    audioElement.addEventListener('ended', () => {
        const playBtn = document.getElementById(`play-btn-${audioId}`);
        playBtn.innerHTML = '<i class="fas fa-play"></i>';
        audioPlayers[audioId].isPlaying = false;
    });
    
    // Listener cuando se carga metadata
    audioElement.addEventListener('loadedmetadata', () => {
        const timeDisplay = document.getElementById(`time-${audioId}`);
        if (timeDisplay) {
            timeDisplay.textContent = `0:00 / ${formatTime(audioElement.duration)}`;
        }
    });
}

function toggleAudioPlayer(userId, taskId) {
    const audioId = `${userId}-${taskId}`;
    const playerContainer = document.getElementById(`player-${audioId}`);
    
    if (playerContainer) {
        playerContainer.classList.toggle('active');
    }
}

function togglePlayPause(userId, taskId) {
    const audioId = `${userId}-${taskId}`;
    const player = audioPlayers[audioId];
    
    if (!player) return;
    
    const playBtn = document.getElementById(`play-btn-${audioId}`);
    
    if (player.isPlaying) {
        player.audio.pause();
        playBtn.innerHTML = '<i class="fas fa-play"></i>';
        player.isPlaying = false;
    } else {
        // Pausar otros audios
        Object.keys(audioPlayers).forEach(id => {
            if (id !== audioId && audioPlayers[id].isPlaying) {
                audioPlayers[id].audio.pause();
                audioPlayers[id].isPlaying = false;
                const otherBtn = document.getElementById(`play-btn-${id}`);
                if (otherBtn) {
                    otherBtn.innerHTML = '<i class="fas fa-play"></i>';
                }
            }
        });
        
        player.audio.play();
        playBtn.innerHTML = '<i class="fas fa-pause"></i>';
        player.isPlaying = true;
    }
}

function updateAudioProgress(userId, taskId) {
    const audioId = `${userId}-${taskId}`;
    const player = audioPlayers[audioId];
    
    if (!player) return;
    
    const progress = (player.audio.currentTime / player.audio.duration) * 100;
    const progressBar = document.getElementById(`progress-${audioId}`);
    const timeDisplay = document.getElementById(`time-${audioId}`);
    
    if (progressBar) {
        progressBar.style.width = `${progress}%`;
    }
    
    if (timeDisplay) {
        timeDisplay.textContent = `${formatTime(player.audio.currentTime)} / ${formatTime(player.audio.duration)}`;
    }
}

function seekAudio(event, userId, taskId) {
    const audioId = `${userId}-${taskId}`;
    const player = audioPlayers[audioId];
    
    if (!player) return;
    
    const progressContainer = event.currentTarget;
    const rect = progressContainer.getBoundingClientRect();
    const clickX = event.clientX - rect.left;
    const percentage = clickX / rect.width;
    
    player.audio.currentTime = percentage * player.audio.duration;
}

function toggleSpeedMenu(userId, taskId) {
    const audioId = `${userId}-${taskId}`;
    const speedMenu = document.getElementById(`speed-menu-${audioId}`);
    
    if (speedMenu) {
        speedMenu.classList.toggle('active');
    }
    
    // Cerrar otros menús
    document.querySelectorAll('.audio-speed-menu').forEach(menu => {
        if (menu.id !== `speed-menu-${audioId}`) {
            menu.classList.remove('active');
        }
    });
}

function setPlaybackSpeed(userId, taskId, speed) {
    const audioId = `${userId}-${taskId}`;
    const player = audioPlayers[audioId];
    
    if (!player) return;
    
    player.audio.playbackRate = speed;
    player.currentSpeed = speed;
    
    // Actualizar botón
    const speedBtn = document.getElementById(`speed-btn-${audioId}`);
    if (speedBtn) {
        speedBtn.textContent = `${speed}x`;
    }
    
    // Actualizar opciones activas
    const speedMenu = document.getElementById(`speed-menu-${audioId}`);
    if (speedMenu) {
        speedMenu.querySelectorAll('.audio-speed-option').forEach(option => {
            option.classList.remove('active');
            if (option.textContent === `${speed}x`) {
                option.classList.add('active');
            }
        });
        speedMenu.classList.remove('active');
    }
}

// Cerrar menús de velocidad al hacer click fuera
document.addEventListener('click', (e) => {
    if (!e.target.closest('.audio-speed-selector')) {
        document.querySelectorAll('.audio-speed-menu').forEach(menu => {
            menu.classList.remove('active');
        });
    }
});



// ==================== SISTEMA DE CATEGORÍAS DE ARCHIVOS ====================
function loadFileCategories() {
    const categoriesGrid = document.getElementById('categoriesGrid');
    if (!categoriesGrid) return;
    
    categoriesGrid.innerHTML = '';
    
    fileCategories.forEach(category => {
        const categoryCard = document.createElement('div');
        categoryCard.className = 'category-card';
        categoryCard.onclick = () => openCategory(category.id);
        
        categoryCard.innerHTML = `
            <div class="category-icon-wrapper" style="background: ${category.color};">
                <i class="${category.icon}"></i>
            </div>
            <div class="category-info">
                <div class="category-name">${category.name}</div>
                <div class="category-description">${category.description}</div>
            </div>
            <div class="category-count">
                ${category.files.length}
            </div>
        `;
        
        categoriesGrid.appendChild(categoryCard);
    });
}

function openCategory(categoryId) {
    const category = fileCategories.find(cat => cat.id === categoryId);
    if (!category) return;
    
    selectedCategory = category;
    
    // ✅ CORRECCIÓN: Ocultar vista de categorías, mostrar vista de archivos
    document.getElementById('categoriesView').classList.remove('active');
    document.getElementById('categoryFilesView').classList.add('active');
    
    // Actualizar título
    const titleSpan = document.querySelector('#categoryTitle span');
    const titleIcon = document.querySelector('#categoryTitle i');
    const countText = document.getElementById('categoryFileCount');
    
    if (titleSpan) titleSpan.textContent = category.name;
    if (titleIcon) {
        titleIcon.className = category.icon;
        titleIcon.style.color = category.color;
    }
    if (countText) {
        countText.textContent = `${category.files.length} archivo${category.files.length !== 1 ? 's' : ''}`;
    }
    
    // Cargar archivos
    loadCategoryFiles(category);
}

function loadCategoryFiles(category) {
    const filesList = document.getElementById('categoryFilesList');
    if (!filesList) return;
    
    filesList.innerHTML = '';
    
    category.files.forEach((file, index) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'category-file-item';
        fileItem.dataset.fileName = file.name;
        fileItem.dataset.fileUrl = file.url;
        fileItem.dataset.fileType = file.type;
        fileItem.dataset.isPreloaded = 'true';
        
        const fileIcon = getFileIcon(file.type);
        const fileSize = formatFileSize(file.size);
        
        fileItem.innerHTML = `
            <div class="category-file-icon">
                <i class="${fileIcon}"></i>
            </div>
            <div class="category-file-info">
                <div class="category-file-name">${file.name}</div>
                <div class="category-file-size">${fileSize}</div>
            </div>
            <div class="category-file-actions">
                <button class="category-file-action-btn" onclick="openFileInModal(this)" title="Ver">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="category-file-action-btn" onclick="downloadCategoryFile(this)" title="Descargar">
                    <i class="fas fa-download"></i>
                </button>
            </div>
        `;
        
        filesList.appendChild(fileItem);
    });
}

function backToCategories() {
    document.getElementById('categoryFilesView').classList.remove('active');
    document.getElementById('categoriesView').classList.add('active');
    selectedCategory = null;
}

function downloadCategoryFile(btn) {
    const fileItem = btn.closest('.category-file-item');
    const fileName = fileItem.dataset.fileName;
    const fileUrl = fileItem.dataset.fileUrl;
    
    const a = document.createElement('a');
    a.href = fileUrl;
    a.download = fileName;
    a.target = '_blank';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}
    </script>
</body>
</html>   
