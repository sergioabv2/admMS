 
<html lang="es">
<head>   
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Profesor - Mozart Academy</title>
    <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
     <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
</head>

<style>
    :root {
    --primary-color: #FF4757;
    --secondary-color: #2ed573;
    --bg-light: #f8f9fa;
    --card-bg: #ffffff;
    --text-dark: #2f3542;
    --text-muted: #6c757d;
    --border-color: #dee2e6;
    --piano-bg: #1e1e1e;
    --piano-height: 110px; /* Antes era 150px, lo hacemos m√°s compacto */
    --key-white-height: 100%; /* Ahora ocupar√°n todo el alto del contenedor */
    --key-black-height: 60%;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', sans-serif;
    background: var(--bg-light);
    color: var(--text-dark);
    overflow: hidden;
}

.professor-container {
    width: 100vw;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* ==================== HEADER ==================== */
.professor-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, #ff6b81 100%);
    color: white;
    padding: 15px 25px;
    box-shadow: 0 4px 15px rgba(255, 71, 87, 0.2);
    flex-shrink: 0;
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    max-width: 100%;
}

.professor-header h1 {
    font-size: 20px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
}

.midi-status-header {
    display: flex;
    align-items: center;
    gap: 10px;
}

.midi-indicator {
    font-size: 13px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 20px;
}

.midi-indicator i {
    font-size: 8px;
}

.midi-indicator.connected {
    background: rgba(46, 213, 115, 0.3);
}

.midi-indicator.connected i {
    animation: pulse-midi 1.5s infinite;
}

@keyframes pulse-midi {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
}

/* ==================== MAIN LAYOUT ==================== */
.main-layout {
    display: grid;
    /* CAMBIO AQU√ç: Reduce de 380px a 260px */
    grid-template-columns: 1fr 290px; 
    gap: 0;
    flex: 1;
    overflow: hidden;
    height: calc(100vh - 70px);
}

/* ==================== MAIN CENTER ==================== */
.main-center {
    background: white;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}


.students-section {
    background: white;
    border-bottom: 1px solid var(--border-color);
    padding: 15px 0; /* Padding arriba/abajo, 0 a los lados para que el scroll llegue al borde */
    display: flex;
    flex-direction: column;
    flex-shrink: 0; 
}

.section-header {
    padding: 0 20px; /* Padding solo para el t√≠tulo */
    margin-bottom: 10px;
}

.section-header h2 {
    font-size: 16px;
    font-weight: 800;
    color: var(--text-dark);
    display: flex;
    align-items: center;
    gap: 8px;
}

.section-header i {
    color: var(--primary-color);
}

.student-info-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: var(--text-muted);
    padding: 8px 16px;
    background: var(--bg-light);
    border-radius: 20px;
}

.student-info-badge.active {
    background: rgba(46, 213, 115, 0.1);
    color: var(--secondary-color);
    font-weight: 600;
}

.students-grid {
    display: flex; /* Flex en fila */
    flex-direction: row; /* Horizontal */
    overflow-x: auto; /* Scroll horizontal */
    overflow-y: hidden;
    gap: 15px;
    padding: 10px 20px 20px 20px; /* Espacio para la sombra de abajo */
    scroll-behavior: smooth;
    /* Ocultar barra de scroll en Firefox */
    scrollbar-width: thin; 
}

.students-grid::-webkit-scrollbar {
    height: 8px; /* Altura de la barra horizontal */
}
.students-grid::-webkit-scrollbar-track {
    background: transparent;
}
.students-grid::-webkit-scrollbar-thumb {
    background: #ddd;
    border-radius: 4px;
}
.students-grid::-webkit-scrollbar-thumb:hover {
    background: #bbb;
}

.student-item {
    /* Dimensiones fijas para la tarjeta */
    min-width: 220px; 
    width: 220px;
    background: white;
    border-radius: 16px;
    border: 1px solid var(--border-color);
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.student-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    border-color: var(--primary-color);
}

.student-item.connected {
    border-color: var(--secondary-color);
    background: linear-gradient(to bottom, #fff 0%, rgba(46, 213, 115, 0.05) 100%);
}

.student-item.selected {
    border-color: var(--primary-color);
    background: linear-gradient(to bottom, #fff 0%, rgba(255, 71, 87, 0.05) 100%);
    box-shadow: 0 0 0 2px rgba(255, 71, 87, 0.1);
}

.student-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.student-name {
    font-weight: 600;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--text-dark);
}

.student-status {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--text-muted);
}

.student-status.connected {
    background: var(--secondary-color);
    box-shadow: 0 0 8px rgba(46, 213, 115, 0.5);
    animation: pulse-status 2s infinite;
}

@keyframes pulse-status {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

.card-avatar-container {
    position: relative;
    margin-bottom: 10px;
}

.card-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    background: #eee;
}

.card-status-dot {
    position: absolute;
    bottom: 2px;
    right: 2px;
    width: 14px;
    height: 14px;
    background: #ccc;
    border: 2px solid white;
    border-radius: 50%;
}
.card-status-dot.connected {
    background: var(--secondary-color);
    box-shadow: 0 0 5px rgba(46, 213, 115, 0.6);
}

/* Info del Estudiante */
.card-info {
    text-align: center;
    margin-bottom: 15px;
    width: 100%;
}

.card-name {
    font-weight: 700;
    font-size: 15px;
    color: var(--text-dark);
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.card-meta {
    font-size: 11px;
    color: var(--text-muted);
    background: var(--bg-light);
    padding: 4px 8px;
    border-radius: 12px;
    display: inline-block;
    margin-bottom: 4px;
}

.card-lesson {
    font-size: 12px;
    color: var(--primary-color);
    font-weight: 600;
}

.student-actions {
    margin-top: auto; /* Empuja los botones al final */
    width: 100%;
    display: flex;
    justify-content: center;
    gap: 8px;
    padding-top: 10px;
    border-top: 1px solid var(--bg-light);
}

.student-action-btn {
    width: 28px;
    height: 28px;
    font-size: 11px;
}

.student-action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.student-action-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
    transform: none;
}

.action-connect {
    background: var(--primary-color);
}

.action-microphone {
    background: var(--secondary-color);
}

.action-microphone.active {
    background: var(--primary-color);
    box-shadow: 0 0 15px rgba(255, 71, 87, 0.4);
}

.action-speaker {
    background: #ff9800;
}

.action-speaker.muted {
    background: var(--text-muted);
}

.action-desktop {
    background: #5c80bc;
}

.action-desktop.active {
    background: var(--primary-color);
    box-shadow: 0 0 15px rgba(255, 71, 87, 0.4);
}

.action-piano {
    background: #6c5ce7;
}

.action-piano.active {
    background: var(--primary-color);
    box-shadow: 0 0 15px rgba(255, 71, 87, 0.4);
    animation: pulse-piano 1.5s infinite;
}

@keyframes pulse-piano {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.08); }
}

.action-chat {
    background: #5c80bc;
}

.action-chat.active {
    background: var(--primary-color);
}

.action-close {
    background: var(--primary-color);
}


.piano-section {
    flex: 0 0 auto; 
    display: flex;
    flex-direction: column;
    padding: 10px 20px; /* Padding un poco m√°s peque√±o */
    overflow: hidden;
    background: var(--bg-light);
    border-top: 1px solid var(--border-color); /* Opcional: separador visual */
}

.piano-header-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--border-color);
}

.piano-header-bar h3 {
    font-size: 18px;
    font-weight: 800;
    color: var(--text-dark);
    display: flex;
    align-items: center;
    gap: 10px;
}

.piano-header-bar i {
    color: var(--primary-color);
}

.piano-controls {
    display: flex;
    align-items: center;
    gap: 12px;
}

.transmission-badge {
    font-size: 12px;
    font-weight: 700;
    padding: 6px 14px;
    background: var(--text-muted);
    color: white;
    border-radius: 20px;
}

.transmission-badge.active {
    background: var(--secondary-color);
    box-shadow: 0 0 15px rgba(46, 213, 115, 0.4);
    animation: pulse-badge 1.5s infinite;
}

@keyframes pulse-badge {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.piano-wrapper {
    /* flex: 1;  <-- ELIMINA ESTO */
    height: var(--piano-height, 180px); /* Usa una altura fija */
    background: var(--piano-bg);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    display: flex;
    flex-direction: column;
    flex-shrink: 0; /* Evita que se aplaste si falta espacio */
    margin-top: auto; /* Opcional: para centrarlo visualmente si sobra espacio */
    margin-bottom: auto;
}

#piano-top-casing {
    position: relative;
    width: 100%;
    height: 25px;
    background: #333;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-shrink: 0;
}

.casing-note-label {
    position: absolute;
    top: 50%;
    transform: translate(-50%, -50%);
    color: #fff;
    font-size: 11px;
    font-weight: 700;
    background: rgba(0, 0, 0, 0.7);
    padding: 3px 10px;
    border-radius: 4px;
    pointer-events: none;
    white-space: nowrap;
    z-index: 20;
}

#piano-container {
    position: relative;
    width: 100%;
    flex: 1;
    overflow-x: auto;
    overflow-y: hidden;
    background: #1a1a1a;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 0;
}

#piano-container::-webkit-scrollbar {
    height: 8px;
    background: #222;
}

#piano-container::-webkit-scrollbar-thumb {
    background: #444;
    border-radius: 4px;
}

#piano-keys {
    position: relative;
    display: flex;
    height: 100%;
    padding: 0 10px; /* Quitamos el padding vertical excesivo */
    align-items: flex-start; /* IMPORTANTE: Cambia de flex-end a flex-start */
}


.piano-key {
    position: relative;
    cursor: pointer;
    transition: all 0.05s ease;
    border: 1px solid #999;
    flex-shrink: 0;
}

.piano-key.white {
    width: 18px; /* ANTES: 40px -> AHORA: 18px (Esto permite ver m√°s octavas) */
    height: 100%;
    background: linear-gradient(to bottom, #ffffff 0%, #f5f5f5 100%);
    border-radius: 0 0 3px 3px; /* Bordes m√°s sutiles */
    z-index: 1;
    border-right: 1px solid #ccc;
    box-shadow: inset 0 -2px 5px rgba(0, 0, 0, 0.1);
    flex-shrink: 0;
}

.piano-key.white:hover {
    background: linear-gradient(to bottom, #f8f8f8 0%, #e8e8e8 100%);
}

.piano-key.white.active {
    background: var(--primary-color) !important;
    box-shadow: 0 0 20px rgba(255, 71, 87, 0.6), inset 0 2px 5px rgba(0, 0, 0, 0.3);
    transform: translateY(1px);
}

.piano-key.black {
    width: 12px; /* ANTES: 24px -> AHORA: 12px */
    height: 60%;
    background: linear-gradient(to bottom, #1a1a1a 0%, #000000 100%);
    
    /* Ajuste de m√°rgenes para centrar la tecla negra (mitad del ancho) */
    margin-left: -6px; 
    margin-right: -6px;
    
    z-index: 2;
    border-radius: 0 0 2px 2px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    flex-shrink: 0;
}

.piano-key.black:hover {
    background: linear-gradient(to bottom, #2a2a2a 0%, #0a0a0a 100%);
}

.piano-key.black.active {
    background: var(--primary-color) !important;
    box-shadow: 0 0 15px rgba(255, 71, 87, 0.6), inset 0 2px 5px rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.3) !important;
}

/* ==================== RIGHT SIDEBAR ==================== */
.right-sidebar {
    background: white;
    border-left: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* TABS */
.sidebar-tabs {
    display: flex;
    border-bottom: 2px solid var(--border-color);
    background: var(--bg-light);
}

.tab-btn {
    flex: 1;
    padding: 15px;
    border: none;
    background: transparent;
    color: var(--text-muted);
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.tab-btn:hover {
    background: rgba(255, 71, 87, 0.05);
    color: var(--text-dark);
}

.tab-btn.active {
    background: white;
    color: var(--primary-color);
    border-bottom: 3px solid var(--primary-color);
}

.tab-content {
    display: none;
    flex: 1;
    flex-direction: column;
    overflow: hidden;
}

.tab-content.active {
    display: flex;
}

/* CHAT TAB */
.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    background: var(--bg-light);
}

.chat-messages::-webkit-scrollbar {
    width: 6px;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 10px;
}

.message {
    padding: 12px 16px;
    border-radius: 16px;
    max-width: 80%;
    word-break: break-word;
    font-size: 14px;
    line-height: 1.5;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.message.self {
    align-self: flex-end;
    background: var(--primary-color);
    color: white;
    border-bottom-right-radius: 4px;
}

.message.other {
    align-self: flex-start;
    background: white;
    color: var(--text-dark);
    border: 1px solid var(--border-color);
    border-bottom-left-radius: 4px;
}

.message-sender {
    font-size: 11px;
    font-weight: 700;
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.message.self .message-sender {
    opacity: 0.9;
}

.message.other .message-sender {
    color: var(--primary-color);
}

.chat-input-container {
    padding: 15px;
    background: white;
    border-top: 1px solid var(--border-color);
    display: flex;
    gap: 10px;
}

#chatInput {
    flex: 1;
    padding: 12px 16px;
    border: 2px solid var(--border-color);
    border-radius: 24px;
    font-size: 14px;
    outline: none;
    transition: all 0.3s ease;
    font-family: 'Inter', sans-serif;
}

#chatInput:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(255, 71, 87, 0.1);
}

#chatInput:disabled {
    background: var(--bg-light);
    cursor: not-allowed;
}

.send-button {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: none;
    background: var(--secondary-color);
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(46, 213, 115, 0.3);
}

.send-button:hover {
    background: #26d07c;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(46, 213, 115, 0.4);
}

.send-button:disabled {
    background: var(--text-muted);
    cursor: not-allowed;
    opacity: 0.5;
    transform: none;
    box-shadow: none;
}

/* FILES TAB */
.files-upload-zone {
    padding: 20px;
    background: white;
    border-bottom: 1px solid var(--border-color);
}

.upload-btn {
    width: 100%;
    padding: 15px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: all 0.3s ease;
}

.upload-btn:hover {
    background: #ff3344;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 71, 87, 0.3);
}

.files-list {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    background: var(--bg-light);
}

.files-list::-webkit-scrollbar {
    width: 6px;
}

.files-list::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 10px;
}

.file-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: white;
    border-radius: 8px;
    margin-bottom: 10px;
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
}

.file-item:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transform: translateY(-2px);
}

.file-icon {
    width: 40px;
    height: 40px;
    background: var(--bg-light);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    color: var(--primary-color);
}

.file-info {
    flex: 1;
}

.file-name {
    font-weight: 600;
    font-size: 14px;
    color: var(--text-dark);
    margin-bottom: 4px;
}

.file-size {
    font-size: 12px;
    color: var(--text-muted);
}

.file-actions {
    display: flex;
    gap: 8px;
}

.file-action-btn {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    border: none;
    background: var(--bg-light);
    color: var(--text-dark);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.file-action-btn:hover {
    background: var(--primary-color);
    color: white;
}

/* ==================== TOOLTIP ==================== */
.tooltip {
    position: absolute;
    bottom: calc(100% + 8px);
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.85);
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 11px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
    z-index: 1000;
    font-weight: 600;
}

.tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 5px solid transparent;
    border-top-color: rgba(0, 0, 0, 0.85);
}

.student-action-btn:hover .tooltip {
    opacity: 1;
}


@media (max-width: 768px) {
    .main-layout {
        grid-template-columns: 1fr;
    }

    .right-sidebar {
        display: none;
    }

    .students-grid {
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    }

}

/* ==================== MODAL DRAGGABLE ==================== */
/* ==================== MODAL DRAGGABLE (M√öLTIPLES) ==================== */
.pdf-modal {
    position: fixed;
    top: 10%;
    left: 10%;
    width: 480px;
    height: 530px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    display: none;
    flex-direction: column;
    z-index: 2000; /* Se incrementar√° din√°micamente */
    overflow: hidden;
    border: 2px solid var(--border-color);
}

.pdf-modal.active {
    display: flex;
}

/* Clase para el modal que est√° al frente */
.pdf-modal.focused {
    z-index: 3000;
    box-shadow: 0 25px 70px rgba(0,0,0,0.4);
    border-color: var(--primary-color);
}

/* Header cambia cuando est√° enfocado */
.pdf-modal.focused .pdf-modal-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, #ff3344 100%);
}

.pdf-modal-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, #ff6b81 100%);
    color: white;
    padding: 12px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: move;
    user-select: none;
}

.pdf-modal-header h4 {
    font-size: 15px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 0;
}

.pdf-modal-close {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.pdf-modal-close:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
}

.pdf-modal-body {
    flex: 1;
    background: #eee;
    overflow: hidden;
    position: relative;
    display: flex;
    flex-direction: column;
}

.pdf-modal-body iframe {
    width: 100%;
    height: 100%;
    border: none;
    display: none; /* Oculto por defecto, se muestra solo para im√°genes/otros */
}

.pdf-viewer-container {
    flex: 1;
    display: none; /* Se muestra solo para PDFs */
    flex-direction: column;
    background: #525659;
    overflow: hidden;
}

.pdf-viewer-container.active {
    display: flex;
}

.pdf-toolbar {
    background: #2d2d2d;
    padding: 10px 15px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    border-bottom: 1px solid #444;
    flex-shrink: 0;
}

.pdf-toolbar-left,
.pdf-toolbar-center,
.pdf-toolbar-right {
    display: flex;
    align-items: center;
    gap: 8px;
}

.pdf-toolbar-center {
    flex: 1;
    justify-content: center;
}

.pdf-tool-btn {
    width: 32px;
    height: 32px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    transition: all 0.2s ease;
}

.pdf-tool-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.pdf-tool-btn.active {
    background: var(--primary-color);
    border-color: var(--primary-color);
    box-shadow: 0 0 10px rgba(255, 71, 87, 0.5);
}

.pdf-tool-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
}

.pdf-page-info {
    color: white;
    font-size: 13px;
    font-weight: 600;
    padding: 0 10px;
    white-space: nowrap;
}

.pdf-zoom-control {
    display: flex;
    align-items: center;
    gap: 8px;
}

.pdf-zoom-display {
    color: white;
    font-size: 12px;
    font-weight: 600;
    min-width: 50px;
    text-align: center;
}

.color-picker-btn {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    border: 2px solid white;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.color-picker-input {
    position: absolute;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
}

.pdf-canvas {
    display: block;
    cursor: crosshair;
}

.annotation-canvas {
    position: absolute;
    top: 0;
    left: 0;
    cursor: crosshair;
}

.modal-iframe {
    width: 100%;
    height: 100%;
    border: none;
    display: none;
}

.pdf-canvas-container {
    flex: 1;
    overflow: auto;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 20px;
    position: relative;
}

.pdf-canvas-wrapper {
    position: relative;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    background: white;
}

#pdfCanvas {
    display: block;
    cursor: crosshair;
}

#annotationCanvas {
    position: absolute;
    top: 0;
    left: 0;
    cursor: crosshair;
}

.annotation-cursor-pen {
    cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><circle cx="10" cy="10" r="2" fill="black"/></svg>') 10 10, crosshair;
}

.annotation-cursor-eraser {
    cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><rect x="5" y="5" width="10" height="10" fill="white" stroke="black"/></svg>') 10 10, crosshair;
}

/* Overlay oscuro cuando hay modal */
.modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1999;
    display: none;
}

.modal-backdrop.active {
    display: block;
}

</style>
<body>
    <div class="professor-container">
        
        <!-- HEADER -->
        <header class="professor-header">
            <div class="header-content">
                <h1>
                    <i class="fas fa-chalkboard-teacher"></i> 
                   Mozart Academy
                </h1>
                <div class="midi-status-header">
                    <span id="midiHeaderStatus" class="midi-indicator">
                        <i class="fas fa-circle"></i> Sin piano MIDI
                    </span>
                </div>
            </div>
        </header>

        <!-- MAIN LAYOUT -->
        <div class="main-layout">
            
            <!-- MAIN CENTER: STUDENTS + PIANO -->
            <main class="main-center">
                
                <!-- STUDENTS SECTION -->
                <section class="students-section">
                    <div class="section-header">
                        <h2>
                            <i class="fas fa-users"></i> 
                            Alumnos Conectados
                        </h2>
                        <div class="student-info-badge" id="selectedStudentInfo">
                            <i class="fas fa-info-circle"></i>
                            <span>Selecciona un alumno para iniciar</span>
                        </div>
                    </div>
                    
                    <div id="studentsContainer" class="students-grid">
                        <!-- Los estudiantes se cargar√°n din√°micamente aqu√≠ -->
                    </div>
                </section>

                <!-- PIANO SECTION -->
              <section class="piano-section">
    <div class="piano-header-bar">
        <h3><i class="fas fa-piano"></i> Piano Virtual</h3>
        <div class="piano-controls">
            <span id="transmissionStatus" class="transmission-badge">
                Transmisi√≥n inactiva
            </span>
        </div>
    </div>

    <div class="piano-wrapper">
        <div id="piano-top-casing"></div>
        <div id="piano-container">
            <div id="piano-keys"></div>
        </div>
    </div>
</section>
                
            </main>
            <aside class="right-sidebar">
                <div class="sidebar-tabs">
                    <button class="tab-btn active" data-tab="chat">
                        <i class="fas fa-comments"></i> Chat
                    </button>
                    <button class="tab-btn" data-tab="files">
                        <i class="fas fa-folder"></i> Archivos
                    </button>
                </div>
                <div class="tab-content active" id="chatTab">
                    <div class="chat-messages" id="chatLog">
                        <!-- Los mensajes aparecer√°n aqu√≠ -->
                    </div>

                    <div class="chat-input-container">
                        <input 
                            id="chatInput" 
                            type="text" 
                            placeholder="Escribe un mensaje..." 
                            disabled 
                        />
                        <button id="sendBtn" class="send-button" disabled>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                <div class="tab-content" id="filesTab">
                    <div class="files-upload-zone">
                        <input type="file" id="fileInput" style="display: none;" multiple>
                        <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-cloud-upload-alt"></i>
                            Subir Archivos
                        </button>
                    </div>
                    
                    <div class="files-list" id="filesList">
                    </div>
                </div>
            </aside>
        </div>
    <div class="modal-backdrop" id="modalBackdrop"></div>

  




    </div>

    <script >
        // ==================== CONFIGURACI√ìN FIREBASE ====================
const fb_config = {
    apiKey: "AIzaSyCiYZ-_3zXQCu6DIkOd_HRGLCS3s6bIYiE",
    authDomain: "jcubic-webrtc.firebaseapp.com",
    databaseURL: "https://jcubic-webrtc.firebaseio.com",
    projectId: "jcubic-webrtc",
    storageBucket: "jcubic-webrtc.appspot.com",
    messagingSenderId: "530153588319"
};
firebase.initializeApp(fb_config);

const db = firebase.database();
const room = "piano-class";
const usersRef = db.ref(`${room}/users`);
const signalsRef = db.ref(`${room}/signals`);
const chatsRef = db.ref(`${room}/chats`);

// ==================== VARIABLES GLOBALES ====================
let myId = "profesor-" + Math.floor(Math.random() * 10000);
let myName = "Profesor";
let localStream = null;
let peers = {};
let selectedStudent = null;
let connectedStudents = {};
let studentConnections = {};

// Variables MIDI
let midiAccess = null;
let midiInput = null;
let midiTransmissionEnabled = false;
let activeMidiStudent = null;

// Variables Piano Visual
let sampler = null;
let activeNotes = {};

let individualAudioStreams = {};
let individualScreenStreams = {};


let pdfDoc = null;
let currentPageNum = 1;
let totalPagesNum = 0;
let pdfScale = 0.75;
let currentTool = 'pen';
let currentColor = '#FF4757';
let isDrawing = false;
let lastX = 0;
let lastY = 0;
let annotations = {}; 

let openModals = {}; // { modalId: { element, pdfDoc, annotations, etc. } }
let modalCounter = 0;
let highestZIndex = 2000;

// ==================== INICIALIZACI√ìN ====================
document.addEventListener('DOMContentLoaded', function() {
    // Chat
    document.getElementById("sendBtn").addEventListener("click", sendMessage);
    document.getElementById("chatInput").addEventListener("keypress", e => {
        if (e.key === "Enter") sendMessage();
    });
    
    // Tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => switchTab(btn.dataset.tab));
    });

    // Files
    document.getElementById('fileInput').addEventListener('change', handleFileUpload);

    init();
});

async function init() {
    try {
        // Stream b√°sico (silencioso)
        localStream = await navigator.mediaDevices.getUserMedia({
            audio: true,
            video: false
        });
        
        localStream.getAudioTracks().forEach(track => {
            track.enabled = false;
        });

        // Registrar en Firebase
        usersRef.child(myId).set({ id: myId, role: "master", name: myName });
        usersRef.child(myId).onDisconnect().remove();

        // Listeners
        listenForStudents();
        listenForSignals();
        
        // Inicializar piano y MIDI
        await initPianoVisual();
        await initMIDI();
        loadSampleFiles();
        
    } catch (error) {
        console.error("Error al inicializar:", error);
        alert('Error: No se pudo acceder al micr√≥fono.');
    }
}


function loadSampleFiles() {
    const sampleFiles = [
        { 
            name: "Partitura - Nocturno Op.9.pdf", 
            type: "application/pdf", 
            size: 1250000,
            url: "https://storage.googleapis.com/mozartacademy-files/pdf/Level1%20-%20Unit1.pdf"
        },
        { 
            name: "Mikrokosmos Vol1 - Bartok.pdf", 
            type: "application/pdf", 
            size: 850000,
            url: "https://storage.googleapis.com/mozartacademy-files/pdf/Level1%20-%20Unit2.pdf"
        },
        { 
            name: "Lectura de las Claves - Dandelot.pdf", 
            type: "application/pdf", 
            size: 1200000,
            url: "https://dashboard.mozartacademy.mx/media/Lectura%20de%20las%20Claves%20-%20Dandelot.pdf"
        },
        { 
            name: "Diagrama de Acordes", 
            type: "image/jpeg", 
            size: 320000,
            url: "https://i.pinimg.com/originals/3d/8f/3e/3d8f3e3e3f3e3f3e3f3e3f3e3f3e3f3e.jpg"
        }
    ];
    
    sampleFiles.forEach(file => {
        addPreloadedFileToList(file.name, file.type, file.size, file.url);
    });
}


function addPreloadedFileToList(fileName, fileType, fileSize, fileUrl) {
    const filesList = document.getElementById('filesList');
    const fileItem = document.createElement('div');
    fileItem.className = 'file-item';

    const fileIcon = getFileIcon(fileType);
    const fileSizeFormatted = formatFileSize(fileSize);
    
    // Guardar datos del archivo
    fileItem.dataset.fileName = fileName;
    fileItem.dataset.fileUrl = fileUrl;
    fileItem.dataset.fileType = fileType;
    fileItem.dataset.isPreloaded = 'true'; // Marcar como precargado

    fileItem.innerHTML = `
        <div class="file-icon">
            <i class="${fileIcon}"></i>
        </div>
        <div class="file-info">
            <div class="file-name">${fileName}</div>
            <div class="file-size">${fileSizeFormatted}</div>
        </div>
        <div class="file-actions">
            <button class="file-action-btn" onclick="openFileInModal(this)" title="Ver">
                <i class="fas fa-eye"></i>
            </button>
            <button class="file-action-btn" onclick="removeFile(this)" title="Eliminar">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;

    filesList.appendChild(fileItem);
}

// ==================== TABS ====================
function switchTab(tabName) {
    // Update buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
    if (activeBtn) {
        activeBtn.classList.add('active');
    }

    // Update content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    const activeTab = document.getElementById(`${tabName}Tab`);
    if (activeTab) {
        activeTab.classList.add('active');
    }
}

// ==================== FILES ====================
function handleFileUpload(event) {
    const files = event.target.files;
    for (let file of files) {
        addFileToList(file);
    }
    event.target.value = ''; // Reset input
}

function addFileToList(file) {
    const filesList = document.getElementById('filesList');
    const fileItem = document.createElement('div');
    fileItem.className = 'file-item';

    const fileIcon = getFileIcon(file.type);
    const fileSize = formatFileSize(file.size);
    
    // Crear URL temporal para el archivo
    const fileUrl = URL.createObjectURL(file);
    
    // Guardar referencia del archivo
    fileItem.dataset.fileName = file.name;
    fileItem.dataset.fileUrl = fileUrl;
    fileItem.dataset.fileType = file.type;

    fileItem.innerHTML = `
        <div class="file-icon">
            <i class="${fileIcon}"></i>
        </div>
        <div class="file-info">
            <div class="file-name">${file.name}</div>
            <div class="file-size">${fileSize}</div>
        </div>
        <div class="file-actions">
            <button class="file-action-btn" onclick="openFileInModal(this)" title="Ver">
                <i class="fas fa-eye"></i>
            </button>
            <button class="file-action-btn" onclick="removeFile(this)" title="Eliminar">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;

    filesList.appendChild(fileItem);
}

function getFileIcon(fileType) {
    if (fileType.includes('pdf')) return 'fas fa-file-pdf';
    if (fileType.includes('image')) return 'fas fa-file-image';
    if (fileType.includes('audio')) return 'fas fa-file-audio';
    if (fileType.includes('video')) return 'fas fa-file-video';
    if (fileType.includes('word')) return 'fas fa-file-word';
    if (fileType.includes('excel') || fileType.includes('spreadsheet')) return 'fas fa-file-excel';
    return 'fas fa-file';
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// ==================== MODAL DRAGGABLE ====================
function openFileInModal(btn) {
    const fileItem = btn.closest('.file-item');
    const fileName = fileItem.dataset.fileName;
    const fileUrl = fileItem.dataset.fileUrl;
    const fileType = fileItem.dataset.fileType;
    
    console.log(`üìÇ Abriendo archivo: ${fileName} (${fileType})`);
    console.log(`üîó URL: ${fileUrl}`);
    
    // Crear un ID √∫nico para este modal
    const modalId = `modal-${modalCounter++}`;
    
    // Crear el modal din√°micamente
    const modal = createModal(modalId, fileName);
    document.body.appendChild(modal);
    
    console.log(`‚úÖ Modal ${modalId} creado y agregado al DOM`);
    
    // Registrar el modal ANTES de configurarlo
    openModals[modalId] = {
        element: modal,
        fileName: fileName,
        fileType: fileType,
        pdfDoc: null,
        currentPage: 1,
        totalPages: 0,
        scale: 0.75,
        annotations: {},
        currentTool: 'pen',
        currentColor: '#FF4757',
        isDrawing: false
    };
    
    // Mostrar modal
    modal.classList.add('active');
    focusModal(modalId);
    
    // ‚úÖ Esperar un tick para que el navegador renderice el modal
    setTimeout(() => {
        // Configurar el modal seg√∫n el tipo de archivo
        if (fileType.includes('pdf')) {
            setupPDFModal(modalId, fileUrl, fileName);
        } else if (fileType.includes('image')) {
            setupImageModal(modalId, fileUrl, fileName);
        } else {
            setupGenericModal(modalId, fileUrl, fileName);
        }
        
        // Inicializar draggable
        initModalDraggable(modalId);
    }, 50);
}


function createModal(modalId, fileName) {
    const modal = document.createElement('div');
    modal.className = 'pdf-modal';
    modal.id = modalId;
    
    // Posici√≥n inicial escalonada
    const offset = (Object.keys(openModals).length * 30) % 200;
    modal.style.top = `${10 + offset}px`;
    modal.style.left = `${10 + offset}px`;
    
    modal.innerHTML = `
        <div class="pdf-modal-header" data-modal-id="${modalId}">
            <h4>
                <i class="fas fa-file-alt"></i>
                <span class="modal-title">${fileName}</span>
            </h4>
            <button class="pdf-modal-close" onclick="closeModalById('${modalId}')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="pdf-modal-body">
            <!-- Visor PDF -->
            <div class="pdf-viewer-container">
                <div class="pdf-toolbar">
                    <div class="pdf-toolbar-left">
                        <button class="pdf-tool-btn active tool-pen" onclick="selectToolForModal('${modalId}', 'pen')" title="L√°piz">
                            <i class="fas fa-pen"></i>
                        </button>
                        <button class="pdf-tool-btn tool-highlighter" onclick="selectToolForModal('${modalId}', 'highlighter')" title="Resaltador">
                            <i class="fas fa-highlighter"></i>
                        </button>
                        <button class="pdf-tool-btn tool-eraser" onclick="selectToolForModal('${modalId}', 'eraser')" title="Borrador">
                            <i class="fas fa-eraser"></i>
                        </button>
                        
                        <div class="color-picker-btn" style="background: #FF4757;" title="Color">
                            <input type="color" class="color-picker-input" value="#FF4757" onchange="changeColorForModal('${modalId}', this.value)">
                        </div>
                        
                        <button class="pdf-tool-btn" onclick="clearAnnotationsForModal('${modalId}')" title="Limpiar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    
                    <div class="pdf-toolbar-center">
                        <button class="pdf-tool-btn btn-prev" onclick="changePageForModal('${modalId}', -1)">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span class="pdf-page-info">
                            <span class="page-current">1</span> de <span class="page-total">1</span>
                        </span>
                        <button class="pdf-tool-btn btn-next" onclick="changePageForModal('${modalId}', 1)">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    
                    <div class="pdf-toolbar-right">
                        <div class="pdf-zoom-control">
                            <button class="pdf-tool-btn" onclick="changeZoomForModal('${modalId}', -0.25)">
                                <i class="fas fa-search-minus"></i>
                            </button>
                            <button class="pdf-tool-btn" onclick="changeZoomForModal('${modalId}', 0.25)">
                                <i class="fas fa-search-plus"></i>
                            </button>
                            <span class="pdf-zoom-display">75%</span>
                        </div>
                    </div>
                </div>
                
                <div class="pdf-canvas-container">
                    <div class="pdf-canvas-wrapper">
                        <canvas class="pdf-canvas"></canvas>
                        <canvas class="annotation-canvas"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Iframe para otros tipos -->
            <iframe class="modal-iframe" style="display: none; width: 100%; height: 100%; border: none;"></iframe>
        </div>
    `;
    
    // Click en el modal lo trae al frente
    modal.addEventListener('mousedown', () => focusModal(modalId));
    
    return modal;
}


async function setupPDFModal(modalId, url, fileName) {
    const modalData = openModals[modalId];
    const modal = modalData.element;
    
    try {
        // ‚úÖ Mostrar visor PDF y ocultar iframe
        const pdfContainer = modal.querySelector('.pdf-viewer-container');
        const iframe = modal.querySelector('.modal-iframe');
        
        pdfContainer.style.display = 'flex';
        iframe.style.display = 'none';
        
        // Configurar PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // Cargar PDF
        const loadingTask = pdfjsLib.getDocument(url);
        modalData.pdfDoc = await loadingTask.promise;
        modalData.totalPages = modalData.pdfDoc.numPages;
        
        // Actualizar UI
        modal.querySelector('.page-total').textContent = modalData.totalPages;
        modal.querySelector('.page-current').textContent = '1';
        modal.querySelector('.pdf-zoom-display').textContent = '75%';
        
        // Renderizar primera p√°gina
        await renderPageForModal(modalId, 1);
        
        // Inicializar canvas de anotaciones
        initAnnotationCanvasForModal(modalId);
        
        console.log(`‚úÖ PDF cargado en ${modalId}:`, fileName);
        
    } catch (error) {
        console.error('‚ùå Error al cargar PDF:', error);
        alert('No se pudo cargar el PDF: ' + error.message);
    }
}

function setupImageModal(modalId, url, fileName) {
    const modal = openModals[modalId].element;
    
    modal.querySelector('.pdf-viewer-container').style.display = 'none';
    const iframe = modal.querySelector('.modal-iframe');
    iframe.style.display = 'block';
    
    iframe.srcdoc = `
        <html>
            <head>
                <style>
                    body { 
                        margin: 0; 
                        display: flex; 
                        justify-content: center; 
                        align-items: center; 
                        background: #000; 
                        height: 100vh;
                    }
                    img { 
                        max-width: 100%; 
                        max-height: 100vh; 
                        object-fit: contain;
                    }
                </style>
            </head>
            <body>
                <img src="${url}" alt="${fileName}">
            </body>
        </html>
    `;
}


async function renderPageForModal(modalId, pageNum) {
    const modalData = openModals[modalId];
    if (!modalData || !modalData.pdfDoc) return;
    
    try {
        const page = await modalData.pdfDoc.getPage(pageNum);
        const viewport = page.getViewport({ scale: modalData.scale });
        
        const modal = modalData.element;
        const canvas = modal.querySelector('.pdf-canvas');
        const context = canvas.getContext('2d');
        
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        
        await page.render({
            canvasContext: context,
            viewport: viewport
        }).promise;
        
        // Actualizar canvas de anotaciones
        const annotationCanvas = modal.querySelector('.annotation-canvas');
        annotationCanvas.width = viewport.width;
        annotationCanvas.height = viewport.height;
        
        restoreAnnotationsForModal(modalId, pageNum);
        updatePageButtonsForModal(modalId);
        
    } catch (error) {
        console.error('Error al renderizar p√°gina:', error);
    }
}

function updatePageButtonsForModal(modalId) {
    const modalData = openModals[modalId];
    const modal = modalData.element;
    
    modal.querySelector('.btn-prev').disabled = modalData.currentPage <= 1;
    modal.querySelector('.btn-next').disabled = modalData.currentPage >= modalData.totalPages;
}

async function changePageForModal(modalId, delta) {
    const modalData = openModals[modalId];
    if (!modalData) return;
    
    const newPage = modalData.currentPage + delta;
    if (newPage < 1 || newPage > modalData.totalPages) return;
    
    modalData.currentPage = newPage;
    modalData.element.querySelector('.page-current').textContent = newPage;
    
    await renderPageForModal(modalId, newPage);
}

async function changeZoomForModal(modalId, delta) {
    const modalData = openModals[modalId];
    if (!modalData) return;
    
    modalData.scale += delta;
    if (modalData.scale < 0.5) modalData.scale = 0.5;
    if (modalData.scale > 3) modalData.scale = 3;
    
    modalData.element.querySelector('.pdf-zoom-display').textContent = 
        Math.round(modalData.scale * 100) + '%';
    
    await renderPageForModal(modalId, modalData.currentPage);
}

function initAnnotationCanvasForModal(modalId) {
    const modal = openModals[modalId].element;
    const canvas = modal.querySelector('.annotation-canvas');
    
    canvas.addEventListener('mousedown', (e) => startDrawingForModal(modalId, e));
    canvas.addEventListener('mousemove', (e) => drawForModal(modalId, e));
    canvas.addEventListener('mouseup', () => stopDrawingForModal(modalId));
    canvas.addEventListener('mouseleave', () => stopDrawingForModal(modalId));
}

function startDrawingForModal(modalId, e) {
    const modalData = openModals[modalId];
    modalData.isDrawing = true;
    
    const rect = e.target.getBoundingClientRect();
    modalData.lastX = e.clientX - rect.left;
    modalData.lastY = e.clientY - rect.top;
}

function drawForModal(modalId, e) {
    const modalData = openModals[modalId];
    if (!modalData.isDrawing) return;
    
    const modal = modalData.element;
    const canvas = modal.querySelector('.annotation-canvas');
    const ctx = canvas.getContext('2d');
    const rect = canvas.getBoundingClientRect();
    
    const currentX = e.clientX - rect.left;
    const currentY = e.clientY - rect.top;
    
    ctx.beginPath();
    ctx.moveTo(modalData.lastX, modalData.lastY);
    ctx.lineTo(currentX, currentY);
    
    if (modalData.currentTool === 'pen') {
        ctx.strokeStyle = modalData.currentColor;
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.globalCompositeOperation = 'source-over';
    } else if (modalData.currentTool === 'highlighter') {
        ctx.strokeStyle = modalData.currentColor;
        ctx.lineWidth = 15;
        ctx.lineCap = 'round';
        ctx.globalAlpha = 0.3;
        ctx.globalCompositeOperation = 'source-over';
    } else if (modalData.currentTool === 'eraser') {
        ctx.lineWidth = 20;
        ctx.globalCompositeOperation = 'destination-out';
    }
    
    ctx.stroke();
    ctx.globalAlpha = 1.0;
    
    modalData.lastX = currentX;
    modalData.lastY = currentY;
    
    saveAnnotationForModal(modalId);
}

function stopDrawingForModal(modalId) {
    if (openModals[modalId]) {
        openModals[modalId].isDrawing = false;
    }
}

function selectToolForModal(modalId, tool) {
    const modalData = openModals[modalId];
    modalData.currentTool = tool;
    
    const modal = modalData.element;
    modal.querySelectorAll('.pdf-tool-btn').forEach(btn => btn.classList.remove('active'));
    modal.querySelector(`.tool-${tool}`).classList.add('active');
}

function changeColorForModal(modalId, color) {
    openModals[modalId].currentColor = color;
}

function saveAnnotationForModal(modalId) {
    const modalData = openModals[modalId];
    const canvas = modalData.element.querySelector('.annotation-canvas');
    
    if (!modalData.annotations[modalData.currentPage]) {
        modalData.annotations[modalData.currentPage] = [];
    }
    modalData.annotations[modalData.currentPage] = canvas.toDataURL();
}

function restoreAnnotationsForModal(modalId, pageNum) {
    const modalData = openModals[modalId];
    const canvas = modalData.element.querySelector('.annotation-canvas');
    const ctx = canvas.getContext('2d');
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if (modalData.annotations[pageNum]) {
        const img = new Image();
        img.onload = () => ctx.drawImage(img, 0, 0);
        img.src = modalData.annotations[pageNum];
    }
}

function clearAnnotationsForModal(modalId) {
    if (!confirm('¬øBorrar todas las anotaciones de esta p√°gina?')) return;
    
    const modalData = openModals[modalId];
    const canvas = modalData.element.querySelector('.annotation-canvas');
    const ctx = canvas.getContext('2d');
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    delete modalData.annotations[modalData.currentPage];
}

function setupGenericModal(modalId, url, fileName) {
    const modal = openModals[modalId].element;
    
    modal.querySelector('.pdf-viewer-container').style.display = 'none';
    const iframe = modal.querySelector('.modal-iframe');
    iframe.style.display = 'block';
    iframe.src = url;
}

function focusModal(modalId) {
    // Remover focus de todos
    Object.keys(openModals).forEach(id => {
        const modal = openModals[id].element;
        modal.classList.remove('focused');
        modal.style.zIndex = 2000;
    });
    
    // Dar focus al seleccionado
    highestZIndex += 10;
    const modal = openModals[modalId].element;
    modal.style.zIndex = highestZIndex;
    modal.classList.add('focused');
}

function closeModalById(modalId) {
    if (!openModals[modalId]) return;
    
    const modal = openModals[modalId].element;
    
    // Remover del DOM
    modal.remove();
    
    // Eliminar del registro
    delete openModals[modalId];
    
    // ‚úÖ Ocultar backdrop si no hay m√°s modales
    if (Object.keys(openModals).length === 0) {
        const backdrop = document.getElementById('modalBackdrop');
        backdrop.classList.remove('active');
    }
    
    console.log(`‚ùå Modal cerrado: ${modalId}`);
}

function closeAllModals() {
    Object.keys(openModals).forEach(modalId => {
        closeModalById(modalId);
    });
}


function initModalDraggable(modalId) {
    const modal = openModals[modalId].element;
    const header = modal.querySelector('.pdf-modal-header');

    let isDragging = false;
    let startX, startY, initialLeft, initialTop;

    function dragStart(e) {
        // Evitar arrastrar si se pulsa el bot√≥n de cerrar
        if (e.target.closest('.pdf-modal-close')) return;
        
        // Traer al frente
        focusModal(modalId);

        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;

        const rect = modal.getBoundingClientRect();
        initialLeft = rect.left;
        initialTop = rect.top;

        header.style.cursor = 'grabbing';

        // IMPORTANTE: A√±adimos los eventos al documento SOLO al empezar a arrastrar
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', dragEnd);
    }

    function dragEnd() {
        isDragging = false;
        header.style.cursor = 'move';
        
        // IMPORTANTE: Limpiamos los eventos al soltar para no afectar otros modales
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('mouseup', dragEnd);
    }

    function drag(e) {
        if (!isDragging) return;
        e.preventDefault();

        const dx = e.clientX - startX;
        const dy = e.clientY - startY;

        modal.style.left = `${initialLeft + dx}px`;
        modal.style.top = `${initialTop + dy}px`;
    }

    // Solo escuchamos el mousedown permanentemente en el header
    header.addEventListener('mousedown', dragStart);
}

function downloadFile(btn) {
    const fileItem = btn.closest('.file-item');
    const fileName = fileItem.dataset.fileName;
    const fileUrl = fileItem.dataset.fileUrl;
    
    const a = document.createElement('a');
    a.href = fileUrl;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

function removeFile(btn) {
    btn.closest('.file-item').remove();
}

// ==================== GESTI√ìN DE ESTUDIANTES ====================
function listenForStudents() {
    usersRef.on("value", snap => {
        const users = snap.val() || {};
        const studentsContainer = document.getElementById("studentsContainer");

        studentsContainer.innerHTML = '';
        connectedStudents = {};
        
        for (let key in users) {
            if (users[key].role === "user") {
                connectedStudents[key] = users[key];
                createStudentUI(key, users[key].name || users[key].id);
            }
        }
        
        // Limpiar selecci√≥n si el estudiante se desconect√≥
        if (selectedStudent && !connectedStudents[selectedStudent]) {
            selectedStudent = null;
            updateStudentInfo(null);
            disableChat();
        }
        
        // Limpiar peers de estudiantes desconectados
        for (let studentId in peers) {
            if (!connectedStudents[studentId]) {
                cleanupStudentConnection(studentId);
            }
        }
    });
}

function createStudentUI(studentId, name) {
    const studentsContainer = document.getElementById("studentsContainer");
    const existingElement = document.getElementById(`student-${studentId}`);
    
    if (existingElement) {
        existingElement.remove();
    }

    // Datos simulados (En el futuro, s√°calos de snapshot.val())
    const niveles = ["Principiante", "Intermedio", "Avanzado"];
    const lecciones = ["Escalas Mayores", "Acordes 7ma", "Nocturno Op.9", "Lectura R√≠tmica"];
    // Generamos datos 'random' consistentes basados en el ID para que no cambien al refrescar
    const randomLvl = niveles[studentId.charCodeAt(0) % 3];
    const randomLesson = lecciones[studentId.charCodeAt(studentId.length-1) % 4];
    // Avatar random (usando UI Avatars con el nombre)
    const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random&color=fff&size=128`;

    const isConnected = studentConnections[studentId]?.connected || false;
    const isSelected = selectedStudent === studentId;
    const isMidiActive = activeMidiStudent === studentId;
    const isAudioActive = individualAudioStreams[studentId]?.active || false;
    const isScreenActive = individualScreenStreams[studentId]?.active || false;
    const audioMuted = document.getElementById(`audio-${studentId}`)?.muted || false;

    const studentItem = document.createElement("div");
    studentItem.className = `student-item ${isConnected ? 'connected' : ''} ${isSelected ? 'selected' : ''}`;
    studentItem.id = `student-${studentId}`;

    studentItem.innerHTML = `
        <div class="card-avatar-container">
            <img src="${avatarUrl}" class="card-avatar" alt="${name}">
            <div class="card-status-dot ${isConnected ? 'connected' : ''}"></div>
        </div>

        <div class="card-info">
            <div class="card-name">${name}</div>
            <div class="card-meta">${randomLvl}</div>
            <div class="card-lesson"><i class="fas fa-book-open"></i> ${randomLesson}</div>
        </div>

        <div class="student-actions">
            ${!isConnected ? `
                <button class="student-action-btn action-connect" onclick="connectToStudent('${studentId}')" title="Conectar">
                    <i class="fas fa-plug"></i>
                </button>
            ` : `
                <button class="student-action-btn action-microphone ${isAudioActive ? 'active' : ''}" onclick="toggleIndividualAudio('${studentId}')" title="Micr√≥fono">
                    <i class="fas fa-microphone${isAudioActive ? '' : '-slash'}"></i>
                </button>
                <button class="student-action-btn action-speaker ${audioMuted ? 'muted' : ''}" onclick="toggleIncomingAudio('${studentId}')" title="Audio">
                    <i class="fas fa-volume${audioMuted ? '-mute' : '-up'}"></i>
                </button>
                <button class="student-action-btn action-desktop ${isScreenActive ? 'active' : ''}" onclick="toggleIndividualScreen('${studentId}')" title="Pantalla">
                    <i class="fas fa-desktop"></i>
                </button>
                <button class="student-action-btn action-piano ${isMidiActive ? 'active' : ''}" onclick="toggleMidiTransmission('${studentId}')" title="MIDI">
                    <i class="fas fa-piano"></i>
                </button>
                <button class="student-action-btn action-chat ${isSelected ? 'active' : ''}" onclick="selectStudentForChat('${studentId}')" title="Chat">
                    <i class="fas fa-comment"></i>
                </button>
                <button class="student-action-btn action-close" onclick="disconnectStudent('${studentId}')" title="Desconectar">
                    <i class="fas fa-times"></i>
                </button>
            `}
        </div>
    `;

    // Animaci√≥n de entrada suave
    studentItem.style.opacity = '0';
    studentsContainer.appendChild(studentItem);
    
    // Peque√±o timeout para activar la transici√≥n de opacidad
    setTimeout(() => {
        studentItem.style.opacity = '1';
    }, 10);
}

async function connectToStudent(studentId) {
    console.log(`Conectando con ${getStudentName(studentId)}...`);
    startPeer(studentId, true);
}

function disconnectStudent(studentId) {
    cleanupStudentConnection(studentId);
    signalsRef.push({ from: myId, to: studentId, type: 'close' });
    console.log(`Desconectado de ${getStudentName(studentId)}`);
    createStudentUI(studentId, getStudentName(studentId));
}

function cleanupStudentConnection(studentId) {
    if (peers[studentId]) {
        peers[studentId].destroy();
        delete peers[studentId];
    }
    
    // Limpiar streams individuales
    if (individualAudioStreams[studentId]?.stream) {
        individualAudioStreams[studentId].stream.getTracks().forEach(track => track.stop());
        delete individualAudioStreams[studentId];
    }

    if (individualScreenStreams[studentId]?.stream) {
        individualScreenStreams[studentId].stream.getTracks().forEach(track => track.stop());
        delete individualScreenStreams[studentId];
    }

    studentConnections[studentId] = { connected: false };

    const audioEl = document.getElementById(`audio-${studentId}`);
    if (audioEl) audioEl.remove();

    // Detener transmisi√≥n MIDI si estaba activa
    if (activeMidiStudent === studentId) {
        activeMidiStudent = null;
        midiTransmissionEnabled = false;
        updateTransmissionStatus();
    }

    if (selectedStudent === studentId) {
        selectedStudent = null;
        updateStudentInfo(null);
        disableChat();
    }
}

function selectStudentForChat(studentId) {
    document.querySelectorAll('.student-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    selectedStudent = studentId;
    
    const studentElement = document.getElementById(`student-${studentId}`);
    if (studentElement) {
        studentElement.classList.add('selected');
    }
    
    updateStudentInfo(studentId);
    enableChat();

    document.querySelectorAll('.action-chat').forEach(btn => {
        btn.classList.remove('active');
    });
    
    const chatBtn = document.querySelector(`#student-${studentId} .action-chat`);
    if (chatBtn) {
        chatBtn.classList.add('active');
    }

    loadChatHistory(studentId);

    // Switch to chat tab
    switchTab('chat');
}

function loadChatHistory(studentId) {
    const chatLog = document.getElementById("chatLog");
    chatLog.innerHTML = '';
    
    const chatId = [myId, studentId].sort().join('-');
    chatsRef.child(chatId).off();
    
    chatsRef.child(chatId).on('child_added', snap => {
        const msg = snap.val();
        const senderName = msg.sender === myId ? "T√∫" : getStudentName(msg.sender);
        logChat(senderName, msg.text);
    });
}

// ==================== CONTROL DE AUDIO INDIVIDUAL ====================
async function toggleIndividualAudio(studentId) {
    if (!peers[studentId] || !peers[studentId].connected) {
        alert('El alumno no est√° conectado');
        return;
    }
    
    const isActive = individualAudioStreams[studentId]?.active || false;

    if (!isActive) {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            
            individualAudioStreams[studentId] = { stream: stream, active: true };
            
            const audioTrack = stream.getAudioTracks()[0];
            peers[studentId].addTrack(audioTrack, stream);
            
            console.log(`üé§ Audio activado para ${getStudentName(studentId)}`);
            createStudentUI(studentId, getStudentName(studentId));
            
        } catch (error) {
            console.error('Error al activar audio:', error);
            alert('No se pudo acceder al micr√≥fono');
        }
    } else {
        const stream = individualAudioStreams[studentId].stream;
        
        const senders = peers[studentId]._pc.getSenders();
        senders.forEach(sender => {
            if (sender.track && sender.track.kind === 'audio' && stream.getAudioTracks().includes(sender.track)) {
                peers[studentId].removeTrack(sender.track, stream);
            }
        });
        
        stream.getTracks().forEach(track => track.stop());
        delete individualAudioStreams[studentId];
        
        console.log(`üé§ Audio desactivado para ${getStudentName(studentId)}`);
        createStudentUI(studentId, getStudentName(studentId));
    }
}

// ==================== CONTROL DE PANTALLA INDIVIDUAL ====================
async function toggleIndividualScreen(studentId) {
    if (!peers[studentId] || !peers[studentId].connected) {
        alert('El alumno no est√° conectado');
        return;
    }
    
    const isActive = individualScreenStreams[studentId]?.active || false;

    if (!isActive) {
        try {
            const stream = await navigator.mediaDevices.getDisplayMedia({ 
                video: true, 
                audio: true 
            });
            
            individualScreenStreams[studentId] = { stream: stream, active: true };
            
            const videoTrack = stream.getVideoTracks()[0];
            const audioTrack = stream.getAudioTracks()[0];
            
            peers[studentId].addTrack(videoTrack, stream);
            if (audioTrack) {
                peers[studentId].addTrack(audioTrack, stream);
            }
            
            videoTrack.onended = () => {
                toggleIndividualScreen(studentId);
            };
            
            console.log(`üñ•Ô∏è Pantalla compartida con ${getStudentName(studentId)}`);
            createStudentUI(studentId, getStudentName(studentId));
            
        } catch (error) {
            console.error('Error al compartir pantalla:', error);
            if (error.name !== 'NotAllowedError') {
                alert('No se pudo compartir la pantalla');
            }
        }
    } else {
        const stream = individualScreenStreams[studentId].stream;
        
        const senders = peers[studentId]._pc.getSenders();
        senders.forEach(sender => {
            if (sender.track && stream.getTracks().includes(sender.track)) {
                peers[studentId].removeTrack(sender.track, stream);
            }
        });
        
        stream.getTracks().forEach(track => track.stop());
        delete individualScreenStreams[studentId];
        
        console.log(`üñ•Ô∏è Compartir pantalla detenido para ${getStudentName(studentId)}`);
        createStudentUI(studentId, getStudentName(studentId));
    }
}

function toggleIncomingAudio(studentId) {
    const audioEl = document.getElementById(`audio-${studentId}`);
    if (audioEl) {
        audioEl.muted = !audioEl.muted;
        createStudentUI(studentId, getStudentName(studentId));
    }
}

function updateStudentInfo(studentId) {
    const infoBox = document.getElementById('selectedStudentInfo');
    
    if (studentId) {
        const isConnected = studentConnections[studentId]?.connected || false;
        infoBox.innerHTML = `
            <i class="fas fa-user"></i>
            <span><strong>${getStudentName(studentId)}</strong> - ${isConnected ? 'Conectado' : 'Desconectado'}</span>
        `;
        infoBox.classList.add('active');
    } else {
        infoBox.innerHTML = `
            <i class="fas fa-info-circle"></i>
            <span>Selecciona un alumno para iniciar</span>
        `;
        infoBox.classList.remove('active');
    }
}

function getStudentName(studentId) {
    const student = connectedStudents[studentId];
    return student ? (student.name || studentId) : studentId;
}

// ==================== WEBRTC ====================
function startPeer(targetId, initiator) {
    const peer = new SimplePeer({
        initiator,
        stream: localStream,
        trickle: false,
        config: {
            iceServers: [
                { urls: "stun:stun.relay.metered.ca:80" },
                { 
                    urls: "turn:a.relay.metered.ca:80", 
                    username: "fad444a63bcf5c8176a3e139", 
                    credential: "MQm2u8W0l1TCVMm0" 
                },
                { 
                    urls: "turn:a.relay.metered.ca:443", 
                    username: "fad444a63bcf5c8176a3e139", 
                    credential: "MQm2u8W0l1TCVMm0" 
                }
            ]
        }
    });
    
    peers[targetId] = peer;
    studentConnections[targetId] = { connected: false };

    peer.on("signal", data => {
        signalsRef.push({ from: myId, to: targetId, data });
    });

    peer.on("connect", () => {
        studentConnections[targetId].connected = true;
        console.log(`‚úÖ Conexi√≥n WebRTC con ${getStudentName(targetId)}`);
        createStudentUI(targetId, getStudentName(targetId));
    });

    peer.on("data", msg => {
        try {
            const data = JSON.parse(msg.toString());
            if (data.type === 'chat') {
                if (selectedStudent === targetId) {
                    logChat(getStudentName(targetId), data.text);
                }
            }
        } catch (error) {
            console.error("Error parsing peer data:", error);
        }
    });

    peer.on("stream", stream => {
        console.log(`Stream recibido de ${getStudentName(targetId)}`);
        
        let audioEl = document.getElementById(`audio-${targetId}`);
        if (!audioEl) {
            audioEl = document.createElement('audio');
            audioEl.id = `audio-${targetId}`;
            audioEl.autoplay = true;
            audioEl.style.display = 'none';
            document.body.appendChild(audioEl);
        }
        audioEl.srcObject = stream;
    });

    peer.on("close", () => {
        studentConnections[targetId] = { connected: false };
        console.log(`Conexi√≥n cerrada con ${getStudentName(targetId)}`);
        createStudentUI(targetId, getStudentName(targetId));
    });

    peer.on("error", (err) => {
        console.error("Error en peer:", err);
        studentConnections[targetId] = { connected: false };
        createStudentUI(targetId, getStudentName(targetId));
    });
}

function listenForSignals() {
    signalsRef.on("child_added", snap => {
        const { from, to, data, type } = snap.val();

        if (to === myId) {
            if (type === 'close') {
                if (peers[from]) {
                    peers[from].destroy();
                    delete peers[from];
                }
                studentConnections[from] = { connected: false };
                createStudentUI(from, getStudentName(from));
            } else if (data) {
                if (!peers[from]) {
                    startPeer(from, false);
                }
                peers[from].signal(data);
            }
        }
        
        signalsRef.child(snap.key).remove();
    });
}

// ==================== CHAT ====================
function sendMessage() {
    if (!selectedStudent) return;
    
    const input = document.getElementById("chatInput");
    const msg = input.value.trim();
    if (!msg) return;

    input.value = "";

    const chatId = [myId, selectedStudent].sort().join('-');
    const messageData = {
        text: msg,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        sender: myId,
        recipient: selectedStudent
    };
    chatsRef.child(chatId).push(messageData);

    if (peers[selectedStudent] && peers[selectedStudent].connected) {
        peers[selectedStudent].send(JSON.stringify({ 
            type: 'chat', 
            text: msg 
        }));
    }
}

function logChat(sender, message) {
    const chatLog = document.getElementById("chatLog");
    const messageElement = document.createElement("div");
    messageElement.classList.add("message");
    messageElement.classList.add(sender === "T√∫" ? "self" : "other");
    messageElement.innerHTML = `
        <div class="message-sender">${sender}</div>
        <div>${message}</div>
    `;
    chatLog.appendChild(messageElement);
    chatLog.scrollTop = chatLog.scrollHeight;
}

function enableChat() {
    document.getElementById("chatInput").disabled = false;
    document.getElementById("sendBtn").disabled = false;
}

function disableChat() {
    document.getElementById("chatInput").disabled = true;
    document.getElementById("sendBtn").disabled = true;
}

// ==================== MIDI ====================
async function initMIDI() {
    if (navigator.requestMIDIAccess) {
        try {
            midiAccess = await navigator.requestMIDIAccess();
            console.log('‚úÖ MIDI Acceso concedido');

            const inputs = midiAccess.inputs.values();
            for (let input of inputs) {
                console.log(`üéπ Piano MIDI: ${input.name}`);
                midiInput = input;
                midiInput.onmidimessage = handleMIDIMessage;
                updateMIDIStatus(true, input.name);
            }

            if (!midiInput) {
                console.warn('‚ö†Ô∏è No se detect√≥ piano MIDI');
                updateMIDIStatus(false);
            }

            midiAccess.onstatechange = (e) => {
                if (e.port.type === 'input') {
                    if (e.port.state === 'connected') {
                        console.log(`üîå Piano conectado: ${e.port.name}`);
                        midiInput = e.port;
                        midiInput.onmidimessage = handleMIDIMessage;
                        updateMIDIStatus(true, e.port.name);
                    } else {
                        console.log('üîå Piano desconectado');
                        updateMIDIStatus(false);
                        if (midiTransmissionEnabled) {
                            activeMidiStudent = null;
                            midiTransmissionEnabled = false;
                            updateTransmissionStatus();
                        }
                    }
                }
            };

        } catch (err) {
            console.error('‚ùå Error MIDI:', err);
        }
    } else {
        console.warn('Web MIDI API no soportada');
    }
}

function updateMIDIStatus(connected, deviceName = '') {
    const statusEl = document.getElementById('midiHeaderStatus');
    if (connected) {
        statusEl.innerHTML = `<i class="fas fa-circle"></i> Piano: ${deviceName}`;
        statusEl.classList.add('connected');
    } else {
        statusEl.innerHTML = '<i class="fas fa-circle"></i> Sin piano MIDI';
        statusEl.classList.remove('connected');
    }
}

function handleMIDIMessage(message) {
    const [command, note, velocity] = message.data;
    const noteName = midiNoteToName(note);

    // Reproducir visual local
    if (command === 144 && velocity > 0) {
        triggerNoteOn(noteName);
    } else if (command === 128 || (command === 144 && velocity === 0)) {
        triggerNoteOff(noteName);
    }

    // Enviar a alumno si est√° activo
    if (midiTransmissionEnabled && activeMidiStudent) {
        sendMIDIToStudent(activeMidiStudent, command === 144 && velocity > 0 ? 'noteOn' : 'noteOff', noteName, velocity);
    }
}

function midiNoteToName(midiNote) {
    const noteNames = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
    const octave = Math.floor(midiNote / 12) - 1;
    const noteName = noteNames[midiNote % 12];
    return `${noteName}${octave}`;
}

function sendMIDIToStudent(studentId, type, note, velocity) {
    if (peers[studentId] && peers[studentId].connected) {
        try {
            const midiData = {
                type: 'midi',
                action: type,
                note: note,
                velocity: velocity,
                timestamp: Date.now()
            };
            peers[studentId].send(JSON.stringify(midiData));
        } catch (error) {
            console.error('Error sending MIDI:', error);
        }
    }
}

function toggleMidiTransmission(studentId) {
    if (!midiInput) {
        alert('No hay piano MIDI conectado');
        return;
    }
    
    if (!studentConnections[studentId]?.connected) {
        alert('El alumno no est√° conectado');
        return;
    }

    if (activeMidiStudent === studentId) {
        activeMidiStudent = null;
        midiTransmissionEnabled = false;
        console.log('üéπ Transmisi√≥n MIDI detenida');
    } else {
        activeMidiStudent = studentId;
        midiTransmissionEnabled = true;
        console.log(`üéπ Transmisi√≥n MIDI activa ‚Üí ${getStudentName(studentId)}`);
    }

    updateTransmissionStatus();
    createStudentUI(studentId, getStudentName(studentId));
}

function updateTransmissionStatus() {
    const statusBadge = document.getElementById('transmissionStatus');
    if (midiTransmissionEnabled && activeMidiStudent) {
        statusBadge.textContent = `Transmitiendo a ${getStudentName(activeMidiStudent)}`;
        statusBadge.classList.add('active');
    } else {
        statusBadge.textContent = 'Transmisi√≥n inactiva';
        statusBadge.classList.remove('active');
    }
}

// ==================== PIANO VISUAL ====================
async function initPianoVisual() {
    await Tone.start();
    
    sampler = new Tone.Sampler({
        urls: {
            A0: "A0.mp3", C1: "C1.mp3", "D#1": "Ds1.mp3", "F#1": "Fs1.mp3", A1: "A1.mp3",
            C2: "C2.mp3", "D#2": "Ds2.mp3", "F#2": "Fs2.mp3", A2: "A2.mp3", C3: "C3.mp3",
            "D#3": "Ds3.mp3", "F#3": "Fs3.mp3", A3: "A3.mp3", C4: "C4.mp3", "D#4": "Ds4.mp3",
            "F#4": "Fs4.mp3", A4: "A4.mp3", C5: "C5.mp3", "D#5": "Ds5.mp3", "F#5": "Fs5.mp3",
            A5: "A5.mp3", C6: "C6.mp3", "D#6": "Ds6.mp3", "F#6": "Fs6.mp3", A6: "A6.mp3",
            C7: "C7.mp3", "D#7": "Ds7.mp3", "F#7": "Fs7.mp3", A7: "A7.mp3", C8: "C8.mp3"
        },
        release: 1,
        baseUrl: "https://tonejs.github.io/audio/salamander/"
    }).toDestination();

    renderPianoKeys();
}

function renderPianoKeys() {
    const container = document.getElementById('piano-keys');
    if (!container) return;
    
    container.innerHTML = '';

    const pattern = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
    const blackKeys = { 'C': 'Db', 'D': 'Eb', 'F': 'Gb', 'G': 'Ab', 'A': 'Bb' };

    // ‚úÖ Orden correcto: Octavas 1 a 7 (ascendente)
    for (let octave = 1; octave <= 7; octave++) {
        for (let i = 0; i <= 6; i++) {
            const note = pattern[i];
            const noteName = `${note}${octave}`;
            
            // Tecla Blanca
            const whiteKey = document.createElement('div');
            whiteKey.className = 'piano-key white';
            whiteKey.dataset.note = noteName;
            whiteKey.id = `key-${noteName}`;
            container.appendChild(whiteKey);
            
            // Tecla Negra (solo despu√©s de C, D, F, G, A)
            if (blackKeys[note]) {
                const blackNoteName = `${blackKeys[note]}${octave}`;
                const blackKey = document.createElement('div');
                blackKey.className = 'piano-key black';
                blackKey.dataset.note = blackNoteName;
                blackKey.id = `key-${blackNoteName}`;
                container.appendChild(blackKey);
            }
        }
    }
}

function triggerNoteOn(noteName) {
    if (activeNotes[noteName]) return;
    
    if (sampler && Tone.context.state === 'running') {
        sampler.triggerAttack(noteName, Tone.now());
    }

    const key = document.getElementById(`key-${noteName}`);
    if (key) {
        key.classList.add('active');
        createFloatingLabel(noteName, key);
    }

    activeNotes[noteName] = true;
}

function triggerNoteOff(noteName) {
    if (!activeNotes[noteName]) return;
    
    if (sampler) {
        sampler.triggerRelease(noteName);
    }

    const key = document.getElementById(`key-${noteName}`);
    if (key) {
        key.classList.remove('active');
    }

    removeFloatingLabel(noteName);
    delete activeNotes[noteName];
}

function createFloatingLabel(noteName, keyElement) {
    const casing = document.getElementById('piano-top-casing');
    if (!casing) return;
    
    const keyRect = keyElement.getBoundingClientRect();
    const casingRect = casing.getBoundingClientRect();
    const keyCenterX = keyRect.left + (keyRect.width / 2);
    const relativeX = keyCenterX - casingRect.left;

    const lbl = document.createElement('div');
    lbl.className = 'casing-note-label';
    lbl.id = `lbl-${noteName}`;
    lbl.textContent = noteName.replace(/[0-9]/g, '');
    lbl.style.left = `${relativeX}px`;
    casing.appendChild(lbl);
}

function removeFloatingLabel(noteName) {
    const lbl = document.getElementById(`lbl-${noteName}`);
    if (lbl) lbl.remove();
}





    </script>
</body>
</html>   
