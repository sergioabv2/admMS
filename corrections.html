<head>
  
<link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i,700,700i">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.2/angular.min.js"></script>
</head>


<style>
  body {
  font-family: "Source Sans Pro", sans-serif;
}
h1 {
  text-align: center;
}
.row {
  margin-top: 10px;
  margin-bottom: 10px;
}
.photo {
  border-radius: 45px;
  margin-right: 20px;
  width: 90px;
  height: 90px;
}
.attend{
    width: 186px;
 }
.outside{
  margin-top: -10px;
  width: 80px;
  display: flex;
}
.outside button{  
  margin: 0 2px;
}
.inside{
  margin-top: 15px;
  width: 80px;
  display: flex;
}
.inside button{  
  margin: 0 2px;
  margin-right: -10px;
}
.form-control {
  width: 30%;
  display: inline-block;
  margin-right: 10px;
}
.name {
  font-weight: 700;
}
.expertise-label {
  display: block;
  font-weight: 700;
  margin-top: 10px;
}
.btn-more {
  margin-top: 10px;
  width: 100%;
}
.label {
  font-weight: normal;
}
.status {
  position: absolute; 
  bottom: 60px; 
  right: 15px;
}


li {
  list-style: none; 
}

.inside .fa-download{
  color: CadetBlue; 
  position: absolute; 
  bottom: 85px; 
  right: 110px; 
  font-size: 24px;
  animation: beat-fade 1s infinite ease-in-out;
}

.fa-check-circle{
  color: green; 
  position: absolute; 
  top: 15px; 
  right: 15px; 
  
  animation: beat-fade 0.5s;
  transform: scale(2.5); 
}

.fa-pause-circle-o{
  color: orange;
  position: absolute; 
  top: 15px; 
  right: 15px; 
  
  animation: beat-fade 0.5s;
  transform: scale(2.5); 
}



.loadInfo{
  z-index: 4;
  position: absolute; 
  top: 50%; 
  left: 50%; 
  transform: translate(-50%, -50%); 
  color: white;
  font-weight: 700;
  font-size: 20px;
}


@media only screen and (min-width: 990px) {
  .col-md-2{
    margin-top: 130px;
    margin-left: -20px;
  }
  
  
}






@keyframes beat-fade {
  0%, 100% {
    opacity: 1;
    transform: scale(2.4);
  }
  
  50% {
    opacity: 0.5;
    transform: scale(4);
  }
}






 .video-container {
            position: relative;
    overflow: hidden;
    max-width: 500px;
   max-height: 300px;
    margin: 0 auto;
        }



video {

  /*max-width: 600px;
  min-height: 400px;
  height: auto;*/
  height: 100%;
  width: 100%;
  display: block;
  background-color: black;  
  margin-bottom: 10px;
}

div {
  flex-basis: 100%;
}

button { margin: 0 .5rem }








.uploader {
  text-align: center;
   display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
  clear: both;
  margin: 0 auto;
  width: 100%;
  max-width: 600px;
}
.uploader label {
  float: left;
  clear: both;
  width: 100%;
  padding: 2rem 1.5rem;
  text-align: center;
  background: #fff;
  border-radius: 7px;
  border: 3px solid #eee;
  transition: all 0.2s ease;
  -webkit-user-select: none;
     -moz-user-select: none;
      -ms-user-select: none;
          user-select: none;
}
.uploader label:hover {
  border-color: #454cad;
}
.uploader label.hover {
  border: 3px solid #454cad;
  box-shadow: inset 0 0 0 6px #eee;
}
.uploader label.hover #start i.fa {
  transform: scale(0.8);
  opacity: 0.3;
}
.uploader #start {
  float: left;
  clear: both;
  width: 100%;
}
.uploader #start.hidden {
  display: none;
}
.uploader #start i.fa {
  font-size: 50px;
  margin-bottom: 1rem;
  transition: all 0.2s ease-in-out;
}
.uploader #response {
  float: left;
  clear: both;
  width: 100%;
}
.uploader #response.hidden {
  display: none;
}
.uploader #response #messages {
  margin-bottom: 0.5rem;
}
.uploader #file-image {
  display: inline;
  /*margin: 0 auto 0.5rem auto;
  width: auto;
  height: auto;
  max-width: 100px;*/
  width: 100px;
  height: 100px;
  object-fit: cover;
  object-position: center;
  background-color: #fff;
}
.uploader #file-image.hidden {
  display: none;
}
.uploader #notimage {
  display: block;
  float: left;
  clear: both;
  width: 100%;
}
.uploader #notimage.hidden {
  display: none;
}


.uploader input[type=file] {
  display: none;
}
.uploader div {
  margin: 0 0 0.5rem 0;
  color: #5f6982;
}
.uploader .btn {
  display: inline-block;
  margin: 0.5rem 0.5rem 1rem 0.5rem;
  clear: both;
  font-family: inherit;
  font-weight: 700;
  font-size: 14px;
  text-decoration: none;
  text-transform: initial;
  border: none;
  border-radius: 0.2rem;
  outline: none;
  padding: 0 1rem;
  height: 36px;
  line-height: 36px;
  color: #fff;
  transition: all 0.2s ease-in-out;
  box-sizing: border-box;
  background: #454cad;
  border-color: #454cad;
  cursor: pointer;
}







@media (max-width: 700px){
  #vidContainer{
    display: none;
  }
}
</style>


<div class="container">
<div class="row">
      <div class="col-sm-5">
        <div id="vidContainer">
<div class="video-container">
<video id="video" autoplay muted></video>
</div>
<div id="videodata" style="display: none"></div>

<div>
<button class="btn btn-default" onClick="recordScreenAndAudio()">Grabar pantalla</button>
<button id="stop-btn" class="btn btn-default" onClick="stopRecording()">Stop!</button>
</div>
 </div>
         
        
        <br><br>
         <form id="file-upload-form" class="uploader">
  <input id="file-upload" type="file" name="fileUpload" accept="image/*" />

  <label for="file-upload" id="file-drag">
    <img id="file-image" src="#" alt="Preview" class="hidden">
    <div id="start2">
      <i class="fa fa-download" aria-hidden="true"></i>
      <div>Selecciona tu imagen</div>
      <div id="notimage" class="hidden">Please select an image</div>
      <span id="file-upload-btn" class="btn btn-primary">Seleccionar</span>
    </div>
    <div id="response" class="hidden">
      <div id="messages"></div>
    </div>
     <input type="hidden" id="imageData">
     <span id="file-send-btn" data-dismiss="modal" style="display: none;"> </span>  
  </label> 
                 
</form>
  </div>       

<div class="col-sm-7" >
  <div id="students" ng-app="studentsApp" ng-controller="studentsCtrl">
<div id="users">
  <div class="container">
    <div class="row">
      <div class="col-sm-7">
    <input ng-model="query" class="search form-control" placeholder="Buscar" type="text" id="query" />   
        <br>
  <div ng-model="orderList">
    <button class="btn btn-warning" ng-click="filterByColor('orange')">
    Marcados
  </button>
     <button class="btn btn-light" ng-click="filterByColor('green')" >
    Todos
  </button>
  
    
    </div>
        
      </div>
    </div>
<br>     
        
    <li ng-repeat="student in filteredStudents | filter: { name: query } | orderBy: orderList" id="active" ng-click="$event.preventDefault();$event.stopPropagation()"> 
   
        <div class="list-group list">
          <a href="#" class="list-group-item" >
            
  

        <div class="col-sm-7">  
              <h4 class="list-group-item-heading name">{{student.name}}</h4>     
     <h5 class="list-group-item-text title" style="font-size: 15px;">Nivel Preparatorio</h5>  
   <span class="label label-default expertise lessonTag" ng-click="abrirNuevaPestana('https://www.facebook.com');$event.preventDefault();$event.stopPropagation()">
  3. Lecci√≥n: Intervalos de 2da y 3era
</span> <br>          

   <div style="font-weight: 600; margin-top:5px;">  Fecha de entrega: <br>
        <span style="font-weight: 400;"> {{student.schedule}} </span></div>         
            </div>    
            

            
           <div class="col-sm-7">             
          
              
 
         <button type="button" class="btn btn-primary" ng-click=";$event.preventDefault();$event.stopPropagation()" style="position: absolute; bottom: 65px; right: 5px;">Abrir &nbsp; <i class="fa fa-chevron-circle-right" aria-hidden="true" ></i></button>
                    <button type="button" class="btn btn-success" ng-click="sendVideo(student);$event.preventDefault();$event.stopPropagation()" style="position: absolute; bottom: 15px; right: 5px;">Enviar &nbsp; <i class="fa fa-chevron-circle-right" aria-hidden="true" ></i></button>
  
     
             
            </div>         
            <div class="clearfix"></div>
          </a>
          
        </div>
  
    </li>
  
  </div>
        
      </div>
    </div>
   </div>
</div>
  </div>



<script>
  var studentsApp = angular.module('studentsApp', []);


studentsApp.controller('studentsCtrl', ['$http', '$scope', function($http, $scope) {
  $scope.students = [];
  $scope.orderList = 'name';

  $http({
    method: 'GET',
    url: 'https://script.google.com/macros/s/AKfycbxOqxZIRpmYVUHlOqM3it1ofWAE9CqmlCsi47agePqX901UNIei-qKTWJLaobRsX75tfw/exec',
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json'
    }
  }).then(function(response) {
    $scope.students = response.data;
     $scope.filterByColor('orange');
  });
  

  
  
  $scope.abrirNuevaPestana = function(URL) {
    window.open(URL, '_blank');
  };
  
 
  
 $scope.setOrder = function(color) {
    $scope.orderList = color;
    $scope.students = $scope.students.filter(function(student) {
      if ($scope.orderList === 'green' && student.color === 'green') {
        return true;
      } else if ($scope.orderList === 'orange' && student.color === 'orange') {
        return true;
      } else if ($scope.orderList === 'red' && student.color === 'red') {
        return true;
      } else {
        return false;
      }
    });
  };

   $scope.filteredStudents = [];

  $scope.filterByColor = function(color) {
    $scope.filteredStudents = $scope.students.filter(function(student) {
      return student.color === color;
    });
  };
  
  
   $scope.sendVideo = function(student) { 
     var base64Video = document.getElementById("videodata").textContent
     
   /* var requestData = {
    action: "postVideo",
    mail: "sergioabv2@gmail.com",
    blob: base64Video
  };

  var config = {
    headers: {
      "Content-Type": "text/plain;charset=utf-8"
    },
    followRedirects: true, 
  };
  

  $http.post('https://script.google.com/macros/s/AKfycbzIra465SJypRhzRL6ihOF0dmuCCykgZF3F4PufbHR76OBkyhS7NLvAu0joiJr5VfwM/exec', requestData, config)
    .then(function(response) {
      //$scope.userData = response.data;
    })*/
     alert(student.name)
      var index = $scope.filteredStudents.indexOf(student);
        if (index !== -1) {
            $scope.filteredStudents.splice(index, 1);
        }
     $("#stop-btn").removeClass("btn-danger").addClass("btn-default");
   };
  
  
   
  
}]);






const video = document.getElementById('video')

async function captureMediaDevices(mediaConstraints = {
    video: {
      width: 1280,
      height: 720
    },
    audio: {
      echoCancellation: true,
      noiseSuppression: true,
      sampleRate: 44100
    }
  }) {
  const stream = await navigator.mediaDevices.getUserMedia(mediaConstraints)
  
  video.src = null
  video.srcObject = stream
  video.muted = true
  
  return stream
}

async function captureScreen(mediaConstraints = {
    video: {
      cursor: 'always',
      resizeMode: 'crop-and-scale'
    }
  }) {
  const screenStream = await navigator.mediaDevices.getDisplayMedia(mediaConstraints)
  
  return screenStream
}

let recorder = null



function stopRecording() {
 recorder.stream.getTracks().forEach(track => track.stop())
   $("#stop-btn").removeClass("btn-default").addClass("btn-danger");
}

async function recordScreenAndAudio() {
  const screenStream = await captureScreen()
  const audioStream = await captureMediaDevices({
    audio: {
      echoCancellation: true,
      noiseSuppression: true,
      sampleRate: 44100
    },
    video: false
  })
  
  const stream = new MediaStream([...screenStream.getTracks(), ...audioStream.getTracks()])
  
  video.src = null
  video.srcObject = stream
  video.muted = true
  
  recorder = new MediaRecorder(stream)
  let chunks = []

  recorder.ondataavailable = event => {
    if (event.data.size > 0) {
      chunks.push(event.data)
    }
  }
  
  recorder.onstop = () => {
    const blob = new Blob(chunks, {
      type: 'video/webm'
    })
    
    chunks = []
    const blobUrl = URL.createObjectURL(blob)

    video.srcObject = null
    video.src = blobUrl
    video.muted = false
    
    const reader = new FileReader();
    reader.readAsDataURL(blob)
    reader.onloadend = function() {
    const base64Video = reader.result;
    document.getElementById('videodata').textContent = base64Video;
    }
   }
  
  recorder.start(200)
}









 
  function ekUpload(){
  function Init() {

    console.log("Upload Initialised");

    var fileSelect    = document.getElementById('file-upload'),
        fileDrag      = document.getElementById('file-drag'),
        submitButton  = document.getElementById('submit-button');

    fileSelect.addEventListener('change', fileSelectHandler, false);

    // Is XHR2 available?
    var xhr = new XMLHttpRequest();
    if (xhr.upload) {
      // File Drop
      fileDrag.addEventListener('dragover', fileDragHover, false);
      fileDrag.addEventListener('dragleave', fileDragHover, false);
      fileDrag.addEventListener('drop', fileSelectHandler, false);
    }
  }

  function fileDragHover(e) {
    var fileDrag = document.getElementById('file-drag');

    e.stopPropagation();
    e.preventDefault();

    fileDrag.className = (e.type === 'dragover' ? 'hover' : 'modal-body file-upload');
  }

  function fileSelectHandler(e) {
    // Fetch FileList object
    var files = e.target.files || e.dataTransfer.files;

    // Cancel event and hover styling
    fileDragHover(e);

    // Process all File objects
    for (var i = 0, f; f = files[i]; i++) {
      parseFile(f);
      convertFileToBase64(f);
    }
  }
    
    function convertFileToBase64(file) {
    var reader = new FileReader();
    reader.onloadend = function() {
      var base64image = reader.result.split(',')[1];
      document.getElementById("imageData").value = base64image;
    };
    reader.readAsDataURL(file);
  }

  // Output
  function output(msg) {
    // Response
    var m = document.getElementById('messages');
    m.innerHTML = msg;
  }

  function parseFile(file) {

    console.log(file.name);
    output(
      '<br><strong style="font-size: 12px;">' + encodeURI(file.name) + '</strong>'
    );
    
    // var fileType = file.type;
    // console.log(fileType);
    var imageName = file.name;

    var isGood = (/\.(?=gif|jpg|png|jpeg)/gi).test(imageName);
    if (isGood) {
      //document.getElementById('start2').classList.add("hidden");
      document.getElementById('start2').style.display = 'none';
      document.getElementById('response').classList.remove("hidden");
       document.getElementById('file-send-btn').style.display = 'block';
      document.getElementById('notimage').classList.add("hidden");
      // Thumbnail Preview
      document.getElementById('file-image').classList.remove("hidden");
      document.getElementById('file-image').src = URL.createObjectURL(file);
    }
    else {
      document.getElementById('file-image').classList.add("hidden");
      document.getElementById('notimage').classList.remove("hidden");
      document.getElementById('start2').classList.remove("hidden");
      document.getElementById('response').classList.add("hidden");
      document.getElementById("file-upload-form").reset();
    }
  }


  // Check for the various File API support.
  if (window.File && window.FileList && window.FileReader) {
    Init();
  } else {
    document.getElementById('file-drag').style.display = 'none';
  }
}
ekUpload();
</script>
